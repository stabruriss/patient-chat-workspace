<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Composer - Healthcare Provider Workbench</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        .primary { color: #4F46E5; }
        .bg-primary { background-color: #4F46E5; }
        .border-primary { border-color: #4F46E5; }
        .border-primary\/20 { border-color: rgba(79, 70, 229, 0.2); }
        .bg-primary\/5 { background-color: rgba(79, 70, 229, 0.05); }
        .text-primary { color: #4F46E5; }
        .rounded-button { border-radius: 8px; }
        .block-editor {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .workflow-block {
            transition: all 0.15s ease;
            border-left: 3px solid transparent;
        }
        .workflow-block:hover {
            background-color: rgba(0, 0, 0, 0.02);
            border-left-color: #e5e7eb;
        }
        .workflow-block.selected {
            background-color: rgba(79, 70, 229, 0.05);
            border-left-color: #4F46E5;
        }
        .block-handle {
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        .workflow-block:hover .block-handle {
            opacity: 1;
        }
        .slash-menu {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .condition-branch {
            border-left: 2px solid #d1d5db;
            margin-left: 1rem;
        }
        .condition-branch.true-branch {
            border-left-color: #10b981;
        }
        .condition-branch.false-branch {
            border-left-color: #ef4444;
        }
        
        /* Chat styling */
        #chatMessages {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        
        #chatMessages::-webkit-scrollbar {
            width: 4px;
        }
        
        #chatMessages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #chatMessages::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 2px;
        }
        
        #chatInput {
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }
        
        .chat-message {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Block Library styling */
        #blockCategories {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        
        #blockCategories::-webkit-scrollbar {
            width: 4px;
        }
        
        #blockCategories::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #blockCategories::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 2px;
        }
        
        .block-library-item:active {
            transform: translateY(1px);
        }
        
        .block-library-item {
            min-height: 60px;
            height: fit-content;
        }
        
        /* Container block styling */
        .workflow-container {
            position: relative;
        }
        
        .drop-zone {
            transition: all 0.2s ease;
        }
        
        .drop-zone:hover {
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.05);
        }
        
        .drop-zone.drag-over {
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.1);
            transform: scale(1.02);
        }
        
        .condition-container, .loop-container {
            transition: all 0.15s ease;
        }
        
        .condition-container:hover, .loop-container:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Workflow type styling */
        .workflow-type-card.selected {
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.05);
        }
        
        .workflow-type-badge-patient {
            background-color: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
        }
        
        .workflow-type-badge-practice {
            background-color: rgba(34, 197, 94, 0.1);
            color: #166534;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <button id="backBtn" class="mr-4 p-2 text-gray-500 hover:bg-gray-100 rounded-lg">
                        <i class="ri-arrow-left-line text-xl"></i>
                    </button>
                    <div class="flex items-center">
                        <div class="flex flex-col">
                            <input id="workflowName" type="text" placeholder="My New Workflow" class="text-xl font-semibold text-gray-900 bg-transparent border-none outline-none focus:bg-white focus:px-2 focus:py-1 focus:rounded focus:border focus:border-gray-200" style="min-width: 200px;">
                            <input id="workflowDescription" type="text" placeholder="Workflow description..." class="text-sm text-gray-600 bg-transparent border-none outline-none focus:bg-white focus:px-2 focus:py-1 focus:rounded focus:border focus:border-gray-200 mt-1" style="min-width: 300px;">
                        </div>
                        <div id="workflowTypeBadge" class="ml-4 px-3 py-1 rounded-full text-sm font-medium hidden">
                            <i class="mr-1"></i>
                            <span></span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="saveBtn" class="px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90">
                        <i class="ri-save-line mr-2"></i>
                        Save Workflow
                    </button>
                    <button id="previewBtn" class="px-4 py-2 text-primary border border-primary/20 bg-primary/5 rounded-button hover:bg-primary/10">
                        <i class="ri-eye-line mr-2"></i>
                        Preview
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="h-screen bg-gray-50 flex">
        <!-- Left Panel - Block Library -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col" id="blockLibraryPanel">
            <!-- Library Header -->
            <div class="p-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Block Library</h3>
                <p class="text-sm text-gray-500 mt-1">Click to add blocks to your workflow</p>
            </div>
            
            <!-- Block Categories -->
            <div class="flex-1 overflow-y-auto p-4" id="blockCategories">
                <!-- Categories will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Block Editor -->
        <div class="block-editor bg-white flex-1 overflow-auto">
            <div id="blockEditor" class="max-w-4xl mx-auto p-8">
                <div id="workflowBlocks" class="space-y-3">
                    <!-- Empty state -->
                    <div id="emptyState" class="text-center py-16 text-gray-400">
                        <i class="ri-file-text-line text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium mb-2">Start building your workflow</h3>
                        <p>Press <span class="bg-gray-100 px-2 py-1 rounded font-mono text-sm">⌘K</span> to open the command palette and add blocks</p>
                    </div>
                </div>
                
            </div>
            
            
        </div>

        <!-- Right Panel - AI Chat -->
        <div class="w-96 bg-white border-l border-gray-200 flex flex-col" id="aiChatPanel">
            <!-- Chat Header -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                        <i class="ri-magic-line text-purple-600"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">AI Assistant</h3>
                </div>
                <p class="text-sm text-gray-500 mt-1">Ask me to help with your workflow</p>
            </div>
            
            <!-- Chat Messages -->
            <div class="flex-1 overflow-y-auto p-4" id="chatMessages">
                <div class="text-center text-gray-400 py-8">
                    <i class="ri-chat-3-line text-3xl mb-2"></i>
                    <p class="text-sm">Start a conversation with AI to get help with your workflow</p>
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center space-x-2">
                    <div class="flex-1">
                        <textarea 
                            id="chatInput" 
                            class="w-full h-12 px-3 py-2 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                            placeholder="Ask AI to help with your workflow..."
                            
                        ></textarea>
                    </div>
                    <button 
                        id="sendChatBtn" 
                        class="flex-shrink-0 h-12 w-12 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 flex items-center justify-center"
                    >
                        <i class="ri-send-plane-line text-lg"></i>
                    </button>
                </div>
                <div class="text-xs text-gray-500 mt-2">Press Shift+Enter for new line, Enter to send</div>
            </div>
        </div>
    </div>

    <!-- Workflow Type Selection Modal -->
    <div id="workflowTypeModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-4xl mx-4 shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ri-workflow-line text-2xl text-purple-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Choose Workflow Type</h2>
                <p class="text-gray-600">Select the type of workflow you want to create</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Patient Workflow Option -->
                <div class="workflow-type-card cursor-pointer p-6 border-2 border-gray-200 rounded-xl hover:border-blue-400 hover:bg-blue-50 transition-all duration-200" data-type="patient">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="ri-user-heart-line text-2xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">Patient Workflow</h3>
                        <p class="text-gray-600 mb-4">Create workflows that run for individual patients based on their specific data and interactions.</p>
                        
                        <div class="text-left">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Examples:</h4>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>• Post-appointment follow-up sequence</li>
                                <li>• Medication adherence monitoring</li>
                                <li>• Care plan execution</li>
                                <li>• Patient onboarding process</li>
                            </ul>
                        </div>
                        
                        <div class="mt-4 text-left">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Triggers:</h4>
                            <div class="flex flex-wrap gap-1">
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">Patient Event</span>
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">Form Submit</span>
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">Timeline</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Practice Workflow Option -->
                <div class="workflow-type-card cursor-pointer p-6 border-2 border-gray-200 rounded-xl hover:border-green-400 hover:bg-green-50 transition-all duration-200" data-type="practice">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="ri-building-line text-2xl text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">Practice Workflow</h3>
                        <p class="text-gray-600 mb-4">Create workflows that monitor system-wide events and run across your entire practice.</p>
                        
                        <div class="text-left">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Examples:</h4>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>• Daily operational reports</li>
                                <li>• Threshold-based alerts</li>
                                <li>• Bulk patient communications</li>
                                <li>• Scheduled maintenance tasks</li>
                            </ul>
                        </div>
                        
                        <div class="mt-4 text-left">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Triggers:</h4>
                            <div class="flex flex-wrap gap-1">
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">Schedule</span>
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">Threshold</span>
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">System Event</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-8">
                <p class="text-sm text-gray-500">You can change the workflow type later if needed</p>
            </div>
        </div>
    </div>

    <!-- Command Palette Modal -->
    <div id="commandPalette" class="fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-200">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/20 backdrop-blur-sm" onclick="hideCommandPalette()"></div>
        
        <!-- Modal -->
        <div class="fixed top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-4 w-full max-w-2xl mx-4 transition-all duration-200">
            <div class="bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden">
                <!-- Search Input -->
                <div class="p-4 border-b border-gray-100">
                    <div class="relative">
                        <i class="ri-search-line absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input 
                            id="commandSearch" 
                            type="text" 
                            placeholder="Search for blocks..." 
                            class="w-full pl-10 pr-4 py-3 text-lg border-none outline-none bg-transparent"
                            autocomplete="off"
                        >
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-sm text-gray-400">
                            Press <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">ESC</kbd> to close
                        </div>
                    </div>
                </div>
                
                <!-- Results -->
                <div id="commandResults" class="max-h-96 overflow-y-auto p-2">
                    <!-- Results will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize workflow composer
        let workflowBlocks = [];
        let blockCounter = 0;
        let selectedBlock = null;
        let currentInput = null;
        let currentWorkflowType = null;

        // Block type configurations
        const blockConfigs = {
            'send-message': { 
                title: 'Send Message/SMS/Email', 
                icon: 'ri-message-line', 
                color: 'blue',
                description: 'Send communication to patient'
            },
            'appointment': { 
                title: 'Make Appointment', 
                icon: 'ri-calendar-line', 
                color: 'green',
                description: 'Schedule appointment with patient'
            },
            'task': { 
                title: 'Assign Task', 
                icon: 'ri-task-line', 
                color: 'purple',
                description: 'Assign task to team member'
            },
            'document': { 
                title: 'Send Document', 
                icon: 'ri-folder-shared-line', 
                color: 'orange',
                description: 'Share document with patient'
            },
            'order': { 
                title: 'Place Order', 
                icon: 'ri-shopping-cart-line', 
                color: 'teal',
                description: 'Place lab/medication order'
            },
            'note': { 
                title: 'Add Internal Note', 
                icon: 'ri-sticky-note-line', 
                color: 'yellow',
                description: 'Add note for staff'
            },
            'nested-workflow': { 
                title: 'Nest Workflow', 
                icon: 'ri-links-line', 
                color: 'indigo',
                description: 'Execute another workflow'
            },
            'wait': { 
                title: 'Wait', 
                icon: 'ri-timer-line', 
                color: 'gray',
                description: 'Wait for time or input'
            },
            'condition': { 
                title: 'Condition', 
                icon: 'ri-git-branch-line', 
                color: 'yellow',
                description: 'Conditional branching'
            },
            'loop': { 
                title: 'Loop', 
                icon: 'ri-repeat-line', 
                color: 'blue',
                description: 'Repeat actions'
            },
            'approval': { 
                title: 'Smart Review', 
                icon: 'ri-brain-line', 
                color: 'red',
                description: 'AI analysis + human review for approval decisions'
            },
            'ai-touch': {
                title: 'AI Touch',
                icon: 'ri-magic-line',
                color: 'purple',
                description: 'AI analysis and smart execution'
            },
            'trigger-order-events': {
                title: 'Order Update',
                icon: 'ri-shopping-cart-line',
                color: 'teal',
                description: 'Triggered by order status changes'
            },
            'trigger-appointment-events': {
                title: 'Appointment Update',
                icon: 'ri-calendar-event-line',
                color: 'green',
                description: 'Triggered by appointment status changes'
            },
            'trigger-document-events': {
                title: 'Document/Form Update',
                icon: 'ri-file-text-line',
                color: 'blue',
                description: 'Triggered by document or form interactions'
            },
            'trigger-report-events': {
                title: 'Report Update',
                icon: 'ri-file-chart-line',
                color: 'purple',
                description: 'Triggered by report status changes'
            },
            'trigger-task-events': {
                title: 'Task Update',
                icon: 'ri-task-line',
                color: 'orange',
                description: 'Triggered by task status changes'
            },
            'trigger-profile-events': {
                title: 'Profile Update',
                icon: 'ri-user-line',
                color: 'indigo',
                description: 'Triggered by patient profile changes'
            },
            'trigger-manual': {
                title: 'Trigger: Manual Start',
                icon: 'ri-play-circle-line',
                color: 'gray',
                description: 'Manually triggered workflow'
            },
            'trigger-scheduled': {
                title: 'Trigger: Scheduled',
                icon: 'ri-calendar-schedule-line',
                color: 'blue',
                description: 'Runs on a schedule (daily, weekly, monthly)'
            },
            'trigger-threshold': {
                title: 'Trigger: Threshold Alert',
                icon: 'ri-alarm-warning-line',
                color: 'orange',
                description: 'Triggered when metrics exceed thresholds'
            },
            'trigger-system-event': {
                title: 'Trigger: System Event',
                icon: 'ri-server-line',
                color: 'purple',
                description: 'Triggered by system-wide events'
            },
            'bulk-communication': {
                title: 'Bulk Communication',
                icon: 'ri-mail-send-line',
                color: 'blue',
                description: 'Send messages to multiple patients'
            },
            'generate-report': {
                title: 'Generate Report',
                icon: 'ri-file-chart-line',
                color: 'green',
                description: 'Generate practice reports and analytics'
            },
            'system-maintenance': {
                title: 'System Maintenance',
                icon: 'ri-tools-line',
                color: 'gray',
                description: 'Perform system maintenance tasks'
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
            // Get workflow type from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const workflowType = urlParams.get('type');
            
            if (workflowType && (workflowType === 'patient' || workflowType === 'practice')) {
                // Set workflow type directly from URL
                selectWorkflowType(workflowType);
                
                // Hide the selection modal
                document.getElementById('workflowTypeModal').classList.add('hidden');
                
                initializeEditor();
                setupEventListeners();
            } else {
                // Fallback to showing selection modal if no/invalid type parameter
                showWorkflowTypeSelection();
                initializeEditor();
                setupEventListeners();
            }
        });

        function initializeEditor() {
            // Block editor is now initialized without the input field
        }

        function showWorkflowTypeSelection() {
            const modal = document.getElementById('workflowTypeModal');
            
            // Show the modal
            modal.classList.remove('hidden');
            
            // Add click handlers to workflow type cards
            const typeCards = modal.querySelectorAll('.workflow-type-card');
            typeCards.forEach(card => {
                card.addEventListener('click', () => {
                    const workflowType = card.dataset.type;
                    selectWorkflowType(workflowType);
                });
            });
        }

        function selectWorkflowType(type) {
            currentWorkflowType = type;
            
            // Hide the selection modal
            const modal = document.getElementById('workflowTypeModal');
            modal.classList.add('hidden');
            
            // Update the workflow badge
            updateWorkflowTypeBadge(type);
            
            // Initialize the block library with type-specific content
            initializeBlockLibrary();
            
            // Show empty state
            showEmptyState();
            
            // Update AI assistant context
            updateAIAssistantContext(type);
        }

        function updateWorkflowTypeBadge(type) {
            const badge = document.getElementById('workflowTypeBadge');
            const icon = badge.querySelector('i');
            const text = badge.querySelector('span');
            
            if (type === 'patient') {
                badge.className = 'ml-4 px-3 py-1 rounded-full text-sm font-medium workflow-type-badge-patient';
                icon.className = 'ri-user-heart-line mr-1';
                text.textContent = 'Patient Workflow';
            } else if (type === 'practice') {
                badge.className = 'ml-4 px-3 py-1 rounded-full text-sm font-medium workflow-type-badge-practice';
                icon.className = 'ri-building-line mr-1';
                text.textContent = 'Practice Workflow';
            }
            
            badge.classList.remove('hidden');
        }

        function updateAIAssistantContext(type) {
            // Update AI assistant header and context
            const chatHeader = document.querySelector('#aiChatPanel .p-4.border-b.border-gray-200 p');
            if (chatHeader) {
                if (type === 'patient') {
                    chatHeader.textContent = 'Ask me to help with your patient workflow';
                } else if (type === 'practice') {
                    chatHeader.textContent = 'Ask me to help with your practice workflow';
                }
            }
        }

        function initializeBlockLibrary() {
            const blockCategories = document.getElementById('blockCategories');
            
            // Define workflow type specific blocks
            const patientTriggers = ['trigger-order-events', 'trigger-appointment-events', 'trigger-document-events', 'trigger-report-events', 'trigger-task-events', 'trigger-profile-events'];
            const practiceTriggers = ['trigger-scheduled', 'trigger-threshold', 'trigger-system-event'];
            const patientActions = ['send-message', 'appointment', 'task', 'document', 'order', 'note'];
            const practiceActions = ['bulk-communication', 'generate-report', 'system-maintenance'];
            
            // Filter blocks based on current workflow type
            let availableTriggers, availableActions;
            
            if (currentWorkflowType === 'patient') {
                availableTriggers = patientTriggers;
                availableActions = patientActions;
            } else if (currentWorkflowType === 'practice') {
                availableTriggers = practiceTriggers;
                availableActions = practiceActions;
            } else {
                // Fallback to all blocks if no type is selected yet
                availableTriggers = [...patientTriggers, ...practiceTriggers];
                availableActions = [...patientActions, ...practiceActions];
            }
            
            // Group blocks by category with type filtering
            const triggers = Object.entries(blockConfigs).filter(([type]) => availableTriggers.includes(type));
            const actions = Object.entries(blockConfigs).filter(([type]) => availableActions.includes(type));
            const logic = Object.entries(blockConfigs).filter(([type]) => 
                ['wait', 'condition', 'loop', 'approval'].includes(type)
            );

            let html = '';

            // Triggers section
            if (triggers.length > 0) {
                html += createCategorySection('Triggers', triggers);
            }

            // Actions section
            if (actions.length > 0) {
                html += createCategorySection('Actions', actions);
            }

            // Logic section
            if (logic.length > 0) {
                html += createCategorySection('Logic', logic);
            }

            blockCategories.innerHTML = html;

            // Add click handlers to all block items
            blockCategories.querySelectorAll('.block-library-item').forEach(item => {
                item.addEventListener('click', () => {
                    const blockType = item.dataset.type;
                    addBlock(blockType);
                });
            });
        }

        function createCategorySection(categoryName, blocks) {
            let html = `
                <div class="mb-6">
                    <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-3">${categoryName}</h4>
                    <div class="grid grid-cols-2 gap-2">
            `;

            blocks.forEach(([type, config]) => {
                const colorClass = getColorClasses(config.color);
                const shortTitle = shortenBlockTitle(config.title);
                html += `
                    <div class="block-library-item flex flex-col items-center p-2 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 hover:border-gray-300 transition-colors" data-type="${type}" title="${config.title} - ${config.description}">
                        <div class="w-6 h-6 ${colorClass.bg} ${colorClass.text} rounded-full flex items-center justify-center mb-1 flex-shrink-0">
                            <i class="${config.icon} text-sm"></i>
                        </div>
                        <div class="text-center">
                            <div class="text-xs font-medium text-gray-900 leading-tight">${shortTitle}</div>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        function shortenBlockTitle(title) {
            // Mapping of long titles to shorter versions
            const titleMappings = {
                'Send Message/SMS/Email': 'Send Message',
                'Make Appointment': 'Appointment',
                'Assign Task': 'Task',
                'Send Document': 'Document',
                'Place Order': 'Order',
                'Add Internal Note': 'Note',
                'Nest Workflow': 'Workflow',
                'Wait': 'Wait',
                'Condition': 'Condition',
                'Loop': 'Loop',
                'Smart Review': 'Smart Review',
                'AI Touch': 'AI Touch',
                // Patient triggers
                'Trigger: Appointment Booked': 'Appt Booked',
                'Trigger: Form Submitted': 'Form Submit',
                'Trigger: Patient Message': 'Patient Msg',
                'Trigger: Test Result Available': 'Test Result',
                'Trigger: Manual Start': 'Manual',
                // Practice triggers
                'Trigger: Scheduled': 'Scheduled',
                'Trigger: Threshold Alert': 'Threshold',
                'Trigger: System Event': 'System Event',
                // Practice actions
                'Bulk Communication': 'Bulk Comm',
                'Generate Report': 'Report',
                'System Maintenance': 'Maintenance'
            };

            return titleMappings[title] || title;
        }

        function setupEventListeners() {
            // Back button
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'Healthcare-Provider-Workbench.html';
            });

            // AI Chat functionality
            const sendChatBtn = document.getElementById('sendChatBtn');
            const chatInput = document.getElementById('chatInput');
            
            sendChatBtn.addEventListener('click', () => {
                sendChatMessage();
            });
            
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });

            // Save and Preview
            document.getElementById('saveBtn').addEventListener('click', saveWorkflow);
            document.getElementById('previewBtn').addEventListener('click', previewWorkflow);

            
            // Command palette search
            document.getElementById('commandSearch').addEventListener('input', (e) => {
                updateCommandPaletteResults(e.target.value);
            });

            // Keyboard shortcuts for command palette
            document.addEventListener('keydown', (e) => {
                // Cmd/Ctrl + K to open command palette
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    showCommandPalette();
                    return;
                }

                // ESC to close command palette
                if (e.key === 'Escape' && commandPaletteVisible) {
                    e.preventDefault();
                    hideCommandPalette();
                    return;
                }

                // Arrow keys and Enter for navigation when palette is open
                if (commandPaletteVisible) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, filteredItems.length - 1);
                        updateCommandPaletteResults(document.getElementById('commandSearch').value);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, 0);
                        updateCommandPaletteResults(document.getElementById('commandSearch').value);
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (filteredItems[selectedIndex]) {
                            const [blockType] = filteredItems[selectedIndex];
                            addBlock(blockType);
                            hideCommandPalette();
                        }
                    }
                }
            });
        }

        function showEmptyState() {
            const emptyState = document.getElementById('emptyState');
            emptyState.style.display = 'block';
        }

        function hideEmptyState() {
            const emptyState = document.getElementById('emptyState');
            emptyState.style.display = 'none';
        }




        function addBlock(type, parentId = null) {
            blockCounter++;
            const config = blockConfigs[type];
            
            const block = {
                id: `block-${blockCounter}`,
                type: type,
                config: { ...config },
                data: {},
                parentId: parentId,
                children: type === 'condition' ? { true: [], false: [] } : 
                         type === 'loop' ? { items: [] } : null
            };

            if (parentId) {
                // Add to parent's children instead of main workflow
                const parentBlock = findBlockById(parentId);
                if (parentBlock) {
                    // This will be handled by the container-specific logic
                }
            } else {
                workflowBlocks.push(block);
            }
            
            renderWorkflow();
            hideEmptyState();

            // Show configuration for the new block
            setTimeout(() => {
                showBlockConfiguration(block);
            }, 100);
        }

        function addTextBlock(text) {
            blockCounter++;
            
            const block = {
                id: `block-${blockCounter}`,
                type: 'text',
                config: {
                    title: 'Text Block',
                    icon: 'ri-text',
                    color: 'gray'
                },
                data: { content: text },
                parentId: null,
                children: null
            };

            workflowBlocks.push(block);
            renderWorkflow();
            hideEmptyState();
        }

        function findBlockById(blockId) {
            function searchInBlocks(blocks) {
                for (let block of blocks) {
                    if (block.id === blockId) {
                        return block;
                    }
                    if (block.children) {
                        if (block.children.true) {
                            const found = searchInBlocks(block.children.true);
                            if (found) return found;
                        }
                        if (block.children.false) {
                            const found = searchInBlocks(block.children.false);
                            if (found) return found;
                        }
                        if (block.children.items) {
                            const found = searchInBlocks(block.children.items);
                            if (found) return found;
                        }
                    }
                }
                return null;
            }
            return searchInBlocks(workflowBlocks);
        }

        function renderWorkflow() {
            const workflowBlocksContainer = document.getElementById('workflowBlocks');
            workflowBlocksContainer.innerHTML = '';
            
            workflowBlocks.forEach(block => {
                renderBlock(block, workflowBlocksContainer);
            });
        }

        function renderBlock(block, container, nestingLevel = 0) {
            const blockElement = document.createElement('div');
            const indentClass = nestingLevel > 0 ? `ml-${nestingLevel * 4} border-l-2 border-gray-200 pl-4` : '';
            
            // Check if this is a container block
            if (block.type === 'condition') {
                renderConditionBlock(block, container, nestingLevel);
                return;
            } else if (block.type === 'loop') {
                renderLoopBlock(block, container, nestingLevel);
                return;
            }
            
            // Render regular block
            blockElement.className = `workflow-block p-4 rounded-lg border border-gray-200 cursor-pointer mb-3 ${indentClass}`;
            blockElement.dataset.blockId = block.id;
            
            const colorClass = getColorClasses(block.config.color);
            
            blockElement.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="block-handle mr-3 text-gray-400 hover:text-gray-600">
                            <i class="ri-drag-move-line"></i>
                        </div>
                        <div class="w-8 h-8 ${colorClass.bg} ${colorClass.text} rounded-full flex items-center justify-center mr-3">
                            <i class="${block.config.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-900">${block.config.title}</div>
                            <div class="text-xs text-gray-500">${block.config.description}</div>
                            ${renderBlockContent(block)}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="configure-block p-1 text-gray-400 hover:text-gray-600">
                            <i class="ri-settings-line"></i>
                        </button>
                        <button class="delete-block p-1 text-gray-400 hover:text-red-500">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Add event listeners
            blockElement.addEventListener('click', () => selectBlock(block));
            blockElement.querySelector('.configure-block').addEventListener('click', (e) => {
                e.stopPropagation();
                showBlockConfiguration(block);
            });
            blockElement.querySelector('.delete-block').addEventListener('click', (e) => {
                e.stopPropagation();
                showDeleteConfirmation(block.id, block.config.title);
            });
            
            container.appendChild(blockElement);
        }

        function renderConditionBlock(block, container, nestingLevel = 0) {
            const containerElement = document.createElement('div');
            const indentClass = nestingLevel > 0 ? `ml-${nestingLevel * 4} border-l-2 border-gray-200 pl-4` : '';
            
            containerElement.className = `workflow-container mb-4 ${indentClass}`;
            containerElement.dataset.blockId = block.id;
            
            const colorClass = getColorClasses(block.config.color);
            const conditionText = block.data.condition || 'Set condition...';
            const isExpanded = block.data.expanded !== false; // Default to expanded
            
            containerElement.innerHTML = `
                <div class="condition-container border-2 border-yellow-200 rounded-lg bg-yellow-50">
                    <!-- Container Header -->
                    <div class="condition-header p-4 border-b border-yellow-200 cursor-pointer" onclick="toggleContainer('${block.id}')">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-8 h-8 ${colorClass.bg} ${colorClass.text} rounded-full flex items-center justify-center mr-3">
                                    <i class="${block.config.icon}"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-gray-900">IF: ${conditionText}</div>
                                    <div class="text-xs text-gray-500">Click to ${isExpanded ? 'collapse' : 'expand'}</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="configure-block p-1 text-gray-400 hover:text-gray-600" onclick="event.stopPropagation(); showBlockConfiguration(findBlockById('${block.id}'))">
                                    <i class="ri-settings-line"></i>
                                </button>
                                <button class="delete-block p-1 text-gray-400 hover:text-red-500" onclick="event.stopPropagation(); showDeleteConfirmation('${block.id}', '${block.config.title}')">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                                <i class="ri-arrow-${isExpanded ? 'up' : 'down'}-s-line text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Container Content -->
                    <div class="condition-content ${isExpanded ? '' : 'hidden'}" id="container-${block.id}">
                        <div class="grid grid-cols-2 gap-4 p-4">
                            <!-- True Branch -->
                            <div class="condition-branch true-branch">
                                <div class="branch-header mb-3">
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                                        <span class="text-sm font-medium text-green-700">When TRUE</span>
                                    </div>
                                </div>
                                <div class="drop-zone min-h-16 border-2 border-dashed border-green-300 rounded-lg p-2 bg-green-50" 
                                     data-parent-id="${block.id}" data-branch="true">
                                    ${block.children.true.length === 0 ? 
                                        '<div class="text-xs text-green-600 text-center py-2">Drop blocks here for TRUE case</div>' : ''}
                                </div>
                            </div>
                            
                            <!-- False Branch -->
                            <div class="condition-branch false-branch">
                                <div class="branch-header mb-3">
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 bg-red-500 rounded-full mr-2"></div>
                                        <span class="text-sm font-medium text-red-700">When FALSE</span>
                                    </div>
                                </div>
                                <div class="drop-zone min-h-16 border-2 border-dashed border-red-300 rounded-lg p-2 bg-red-50" 
                                     data-parent-id="${block.id}" data-branch="false">
                                    ${block.children.false.length === 0 ? 
                                        '<div class="text-xs text-red-600 text-center py-2">Drop blocks here for FALSE case</div>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(containerElement);
            
            // Render nested blocks if expanded
            if (isExpanded) {
                const trueDropZone = containerElement.querySelector('[data-branch="true"]');
                const falseDropZone = containerElement.querySelector('[data-branch="false"]');
                
                if (block.children.true.length > 0) {
                    trueDropZone.innerHTML = '';
                    block.children.true.forEach(childBlock => {
                        renderBlock(childBlock, trueDropZone, nestingLevel + 1);
                    });
                }
                
                if (block.children.false.length > 0) {
                    falseDropZone.innerHTML = '';
                    block.children.false.forEach(childBlock => {
                        renderBlock(childBlock, falseDropZone, nestingLevel + 1);
                    });
                }
            }
        }

        function renderLoopBlock(block, container, nestingLevel = 0) {
            const containerElement = document.createElement('div');
            const indentClass = nestingLevel > 0 ? `ml-${nestingLevel * 4} border-l-2 border-gray-200 pl-4` : '';
            
            containerElement.className = `workflow-container mb-4 ${indentClass}`;
            containerElement.dataset.blockId = block.id;
            
            const colorClass = getColorClasses(block.config.color);
            const loopText = block.data.count ? `Repeat ${block.data.count} times` : 'Set loop count...';
            const isExpanded = block.data.expanded !== false; // Default to expanded
            
            containerElement.innerHTML = `
                <div class="loop-container border-2 border-blue-200 rounded-lg bg-blue-50">
                    <!-- Container Header -->
                    <div class="loop-header p-4 border-b border-blue-200 cursor-pointer" onclick="toggleContainer('${block.id}')">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-8 h-8 ${colorClass.bg} ${colorClass.text} rounded-full flex items-center justify-center mr-3">
                                    <i class="${block.config.icon}"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-gray-900">LOOP: ${loopText}</div>
                                    <div class="text-xs text-gray-500">Click to ${isExpanded ? 'collapse' : 'expand'}</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="configure-block p-1 text-gray-400 hover:text-gray-600" onclick="event.stopPropagation(); showBlockConfiguration(findBlockById('${block.id}'))">
                                    <i class="ri-settings-line"></i>
                                </button>
                                <button class="delete-block p-1 text-gray-400 hover:text-red-500" onclick="event.stopPropagation(); showDeleteConfirmation('${block.id}', '${block.config.title}')">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                                <i class="ri-arrow-${isExpanded ? 'up' : 'down'}-s-line text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Container Content -->
                    <div class="loop-content ${isExpanded ? '' : 'hidden'}" id="container-${block.id}">
                        <div class="p-4">
                            <div class="loop-items">
                                <div class="branch-header mb-3">
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                                        <span class="text-sm font-medium text-blue-700">Repeated Actions</span>
                                    </div>
                                </div>
                                <div class="drop-zone min-h-16 border-2 border-dashed border-blue-300 rounded-lg p-2 bg-blue-50" 
                                     data-parent-id="${block.id}" data-branch="items">
                                    ${block.children.items.length === 0 ? 
                                        '<div class="text-xs text-blue-600 text-center py-2">Drop blocks here to repeat</div>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(containerElement);
            
            // Render nested blocks if expanded
            if (isExpanded && block.children.items.length > 0) {
                const itemsDropZone = containerElement.querySelector('[data-branch="items"]');
                itemsDropZone.innerHTML = '';
                block.children.items.forEach(childBlock => {
                    renderBlock(childBlock, itemsDropZone, nestingLevel + 1);
                });
            }
        }

        function toggleContainer(blockId) {
            const block = findBlockById(blockId);
            if (block) {
                block.data.expanded = !block.data.expanded;
                renderWorkflow();
            }
        }

        function renderBlockContent(block) {
            if (block.type === 'text') {
                return `<div class="text-sm text-gray-700 mt-1">${block.data.content}</div>`;
            }
            
            if (block.type === 'condition' && block.data.configured) {
                return `
                    <div class="mt-3">
                        <div class="text-xs text-gray-600 mb-2">When: ${block.data.condition || 'Not set'}</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="condition-branch true-branch p-2 rounded bg-green-50">
                                <div class="text-green-700 font-medium">✓ True Path</div>
                                <div class="text-green-600">${block.data.trueBranch?.length || 0} steps</div>
                            </div>
                            <div class="condition-branch false-branch p-2 rounded bg-red-50">
                                <div class="text-red-700 font-medium">✗ False Path</div>
                                <div class="text-red-600">${block.data.falseBranch?.length || 0} steps</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (block.type === 'wait' && block.data.configured) {
                const waitType = block.data.type === 'time' ? 'Time-based' : 'Input-based';
                const waitValue = block.data.type === 'time' ? 
                    `${block.data.duration} ${block.data.unit}` : 
                    `Wait for ${block.data.inputCount} inputs`;
                return `<div class="text-sm text-gray-600 mt-1">${waitType}: ${waitValue}</div>`;
            }
            
            if (block.type === 'loop' && block.data.configured) {
                return `<div class="text-sm text-gray-600 mt-1">Repeat ${block.data.count} times</div>`;
            }
            
            if (block.type === 'approval' && block.data.configured) {
                const aiStatus = block.data.aiEnabled ? '🤖 AI Analysis + Human' : '👤 Human Only';
                const reviewer = block.data.defaultReviewer || 'Not set';
                const reviewerLabel = reviewer === 'practice-manager' ? 'Practice Manager' : 
                                   reviewer === 'clinical-director' ? 'Clinical Director' :
                                   reviewer === 'admin-staff' ? 'Admin Staff' :
                                   reviewer === 'custom' ? 'Custom User' : 'Not set';
                
                return `
                    <div class="mt-2 space-y-1">
                        <div class="text-xs text-red-600 bg-red-50 px-2 py-1 rounded">${aiStatus}</div>
                        ${block.data.aiEnabled ? `<div class="text-xs text-gray-600">AI decisions: ✅ Approve • ❌ Reject • 🔄 Escalate</div>` : ''}
                        <div class="text-xs text-gray-600">👤 Reviewer: ${reviewerLabel}</div>
                    </div>
                `;
            }
            
            if (block.type === 'ai-touch' && block.data.configured) {
                const contextLabels = {
                    'previous-1': '1 previous step',
                    'previous-2': '2 previous steps', 
                    'previous-3': '3 previous steps',
                    'previous-all': 'All previous steps',
                    'specific': 'Specific steps'
                };
                const contextSteps = contextLabels[block.data.contextSteps] || 'Previous step';
                
                const modeLabels = {
                    'execute-next': '➡️ Execute next steps',
                    'auto-generate': '⚡ Auto-generate steps',
                    'hybrid': '🔄 Hybrid mode'
                };
                const executionMode = modeLabels[block.data.executionMode] || '➡️ Execute next steps';
                
                const approvalIcon = block.data.requireApproval ? '✋ ' : '';
                
                return `
                    <div class="mt-3 space-y-2">
                        <div class="text-xs text-purple-600 bg-purple-50 p-2 rounded">
                            <strong>🤖 AI Prompt:</strong> ${block.data.prompt ? (block.data.prompt.length > 60 ? block.data.prompt.substring(0, 60) + '...' : block.data.prompt) : 'Not set'}
                        </div>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div>📥 Context: ${contextSteps}</div>
                            <div>${approvalIcon}${executionMode}</div>
                        </div>
                    </div>
                `;
            }
            
            // Handle grouped trigger blocks
            if (block.type.startsWith('trigger-') && block.data.configured) {
                return renderGroupedTriggerContent(block);
            }
            
            // Show configuration status
            const hasConfig = Object.keys(block.data).length > 0;
            if (!hasConfig) {
                return `<div class="text-xs text-orange-500 mt-1">⚠️ Needs configuration</div>`;
            }
            
            return `<div class="text-xs text-green-600 mt-1">✓ Configured</div>`;
        }
        
        function renderGroupedTriggerContent(block) {
            const selectedEvents = [];
            
            // Get all selected events from block data
            Object.keys(block.data).forEach(key => {
                if (key !== 'configured' && block.data[key] === true) {
                    // Convert camelCase to readable text
                    const eventText = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    selectedEvents.push(eventText);
                }
            });
            
            if (selectedEvents.length === 0) {
                return `<div class="text-xs text-orange-500 mt-1">⚠️ No events selected</div>`;
            }
            
            const eventColors = {
                'trigger-order-events': 'teal',
                'trigger-appointment-events': 'green',
                'trigger-document-events': 'blue',
                'trigger-report-events': 'purple',
                'trigger-task-events': 'orange',
                'trigger-profile-events': 'indigo'
            };
            
            const color = eventColors[block.type] || 'gray';
            
            return `
                <div class="mt-3">
                    <div class="text-xs text-gray-600 mb-2">Monitoring ${selectedEvents.length} event${selectedEvents.length > 1 ? 's' : ''}:</div>
                    <div class="flex flex-wrap gap-1">
                        ${selectedEvents.slice(0, 3).map(event => 
                            `<span class="px-2 py-1 bg-${color}-100 text-${color}-700 text-xs rounded">${event}</span>`
                        ).join('')}
                        ${selectedEvents.length > 3 ? `<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">+${selectedEvents.length - 3} more</span>` : ''}
                    </div>
                </div>
            `;
        }

        function getColorClasses(color) {
            const colorMap = {
                blue: { bg: 'bg-blue-100', text: 'text-blue-600' },
                green: { bg: 'bg-green-100', text: 'text-green-600' },
                purple: { bg: 'bg-purple-100', text: 'text-purple-600' },
                orange: { bg: 'bg-orange-100', text: 'text-orange-600' },
                teal: { bg: 'bg-teal-100', text: 'text-teal-600' },
                yellow: { bg: 'bg-yellow-100', text: 'text-yellow-600' },
                indigo: { bg: 'bg-indigo-100', text: 'text-indigo-600' },
                gray: { bg: 'bg-gray-100', text: 'text-gray-600' },
                red: { bg: 'bg-red-100', text: 'text-red-600' }
            };
            return colorMap[color] || colorMap.gray;
        }

        function selectBlock(block) {
            // Remove previous selection
            document.querySelectorAll('.workflow-block').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selection to current block
            const blockElement = document.querySelector(`[data-block-id="${block.id}"]`);
            blockElement.classList.add('selected');
            selectedBlock = block;
        }

        function showDeleteConfirmation(blockId, blockTitle) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4 shadow-xl">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                            <i class="ri-delete-bin-line text-red-600 text-lg"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">Delete Block</h3>
                    </div>
                    <p class="text-gray-600 mb-6">Are you sure you want to delete the <strong>${blockTitle}</strong> block? This action cannot be undone.</p>
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-delete px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button class="confirm-delete px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            Delete Block
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            modal.querySelector('.cancel-delete').addEventListener('click', () => {
                modal.remove();
            });
            
            modal.querySelector('.confirm-delete').addEventListener('click', () => {
                deleteBlock(blockId);
                modal.remove();
            });
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function deleteBlock(blockId) {
            // Remove from main workflow blocks
            workflowBlocks = workflowBlocks.filter(block => block.id !== blockId);
            
            // Also remove from any parent containers
            function removeFromChildren(blocks) {
                blocks.forEach(block => {
                    if (block.children) {
                        if (block.children.true) {
                            block.children.true = block.children.true.filter(child => child.id !== blockId);
                            removeFromChildren(block.children.true);
                        }
                        if (block.children.false) {
                            block.children.false = block.children.false.filter(child => child.id !== blockId);
                            removeFromChildren(block.children.false);
                        }
                        if (block.children.items) {
                            block.children.items = block.children.items.filter(child => child.id !== blockId);
                            removeFromChildren(block.children.items);
                        }
                    }
                });
            }
            
            removeFromChildren(workflowBlocks);
            renderWorkflow();
            
            if (workflowBlocks.length === 0) {
                showEmptyState();
            }
        }

        function showBlockConfiguration(block) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            
            let modalContent = '';
            
            switch (block.type) {
                case 'send-message':
                    modalContent = createMessageConfigModal(block);
                    break;
                case 'appointment':
                    modalContent = createAppointmentConfigModal(block);
                    break;
                case 'task':
                    modalContent = createTaskConfigModal(block);
                    break;
                case 'wait':
                    modalContent = createWaitConfigModal(block);
                    break;
                case 'condition':
                    modalContent = createConditionConfigModal(block);
                    break;
                case 'loop':
                    modalContent = createLoopConfigModal(block);
                    break;
                case 'approval':
                    modalContent = createApprovalConfigModal(block);
                    break;
                case 'ai-touch':
                    modalContent = createAITouchConfigModal(block);
                    break;
                case 'trigger-order-events':
                    modalContent = createOrderEventsConfigModal(block);
                    break;
                case 'trigger-appointment-events':
                    modalContent = createAppointmentEventsConfigModal(block);
                    break;
                case 'trigger-document-events':
                    modalContent = createDocumentEventsConfigModal(block);
                    break;
                case 'trigger-report-events':
                    modalContent = createReportEventsConfigModal(block);
                    break;
                case 'trigger-task-events':
                    modalContent = createTaskEventsConfigModal(block);
                    break;
                case 'trigger-profile-events':
                    modalContent = createProfileEventsConfigModal(block);
                    break;
                default:
                    modalContent = createGenericConfigModal(block);
            }
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // Setup modal event listeners
            setupModalEventListeners(modal, block);
        }
        
        function createMessageConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Message</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Message Type</label>
                            <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="type">
                                <option value="">Select type...</option>
                                <option value="sms">SMS</option>
                                <option value="email">Email</option>
                                <option value="in-app">In-App Message</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Subject (Email only)</label>
                            <input type="text" class="config-input w-full p-2 border border-gray-300 rounded-lg" 
                                   data-field="subject" placeholder="Email subject...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Message Content</label>
                            <textarea class="config-input w-full p-2 border border-gray-300 rounded-lg" rows="4" 
                                      data-field="content" placeholder="Message content..."></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Save Configuration
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createWaitConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-lg mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Wait</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Wait Type</label>
                            <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="type">
                                <option value="time">Fixed Time Period</option>
                                <option value="input">Wait for Input</option>
                            </select>
                        </div>
                        <div id="timeConfig" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Duration</label>
                                <input type="number" class="config-input w-full p-2 border border-gray-300 rounded-lg" 
                                       data-field="duration" min="1" placeholder="1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Unit</label>
                                <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="unit">
                                    <option value="minutes">Minutes</option>
                                    <option value="hours">Hours</option>
                                    <option value="days">Days</option>
                                </select>
                            </div>
                        </div>
                        <div id="inputConfig" class="hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Number of Inputs Required</label>
                                <input type="number" class="config-input w-full p-2 border border-gray-300 rounded-lg" 
                                       data-field="inputCount" min="1" placeholder="1">
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Save Configuration
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createConditionConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Condition</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Condition</label>
                            <textarea class="config-input w-full p-2 border border-gray-300 rounded-lg" rows="3" 
                                      data-field="condition" placeholder="Describe the condition to check...\nExample: Patient age > 65"></textarea>
                        </div>
                        <div class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                            <strong>Note:</strong> This creates two separate paths in your workflow. Steps following this condition will be organized into True and False branches.
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                            Save Configuration
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createLoopConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-lg mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Loop</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Repeat Count</label>
                            <input type="number" class="config-input w-full p-2 border border-gray-300 rounded-lg" 
                                   data-field="count" min="1" placeholder="3">
                        </div>
                        <div class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                            <strong>Note:</strong> Actions following this loop will be repeated the specified number of times.
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Save Configuration
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createGenericConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-lg mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure ${block.config.title}</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea class="config-input w-full p-2 border border-gray-300 rounded-lg" rows="3" 
                                      data-field="description" placeholder="Describe what this block should do..."></textarea>
                        </div>
                        <div class="text-sm text-yellow-600 bg-yellow-50 p-3 rounded-lg">
                            <strong>Note:</strong> This block type will need additional configuration during workflow execution.
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Save Configuration
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createAppointmentConfigModal(block) {
            return createGenericConfigModal(block);
        }
        
        function createTaskConfigModal(block) {
            return createGenericConfigModal(block);
        }
        
        function createApprovalConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Smart Review</h3>
                    <div class="space-y-4">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-brain-line text-red-600 mr-2 mt-1"></i>
                                <div class="text-sm text-red-800">
                                    <strong>Smart Review</strong> combines AI analysis with human oversight for intelligent approval decisions. Configure AI pre-screening or route directly to human review.
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-b border-gray-200 pb-4">
                            <label class="flex items-center">
                                <input type="checkbox" class="config-input mr-3" data-field="aiEnabled">
                                <div>
                                    <div class="text-sm font-medium text-gray-900">Enable AI Analysis</div>
                                    <div class="text-xs text-gray-500">AI will analyze input and make initial decisions before human review if needed</div>
                                </div>
                            </label>
                        </div>
                        
                        <div id="ai-analysis-section" class="space-y-4" style="display: none;">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">AI Analysis Prompt</label>
                                <textarea class="config-input w-full p-3 border border-gray-300 rounded-lg text-sm" rows="3" 
                                          data-field="aiPrompt" placeholder="Describe what AI should analyze from previous workflow steps...&#10;&#10;Example: 'Analyze patient response time and message content to determine if approval is needed for appointment rescheduling'"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Context from Previous Steps</label>
                                <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="contextSteps">
                                    <option value="previous-1">Previous 1 step</option>
                                    <option value="previous-2">Previous 2 steps</option>
                                    <option value="previous-3">Previous 3 steps</option>
                                    <option value="previous-all">All previous steps</option>
                                </select>
                            </div>
                            
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-gray-900 mb-3">AI Decision Instructions</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-green-700 mb-1">✅ Approval Instructions</label>
                                        <textarea class="config-input w-full p-2 border border-gray-300 rounded-lg text-sm" rows="2" 
                                                  data-field="approvalInstructions" placeholder="When should AI approve and continue workflow? &#10;Example: 'If patient confirmed appointment within 24 hours'"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-red-700 mb-1">❌ Rejection Instructions</label>
                                        <textarea class="config-input w-full p-2 border border-gray-300 rounded-lg text-sm" rows="2" 
                                                  data-field="rejectionInstructions" placeholder="When should AI reject and stop workflow? &#10;Example: 'If patient requested cancellation or no response after 48 hours'"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-orange-700 mb-1">🔄 Escalation Instructions</label>
                                        <textarea class="config-input w-full p-2 border border-gray-300 rounded-lg text-sm" rows="2" 
                                                  data-field="escalationInstructions" placeholder="When should AI escalate to human review? &#10;Example: 'If patient response is unclear or requests special accommodation'"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Human Review Configuration</label>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Default Reviewer</label>
                                    <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="defaultReviewer">
                                        <option value="">Select reviewer...</option>
                                        <option value="practice-manager">Practice Manager</option>
                                        <option value="clinical-director">Clinical Director</option>
                                        <option value="admin-staff">Administrative Staff</option>
                                        <option value="custom">Custom User</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1">Review Timeout</label>
                                        <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="reviewTimeout">
                                            <option value="1h">1 Hour</option>
                                            <option value="4h">4 Hours</option>
                                            <option value="1d" selected>1 Day</option>
                                            <option value="3d">3 Days</option>
                                            <option value="none">No Timeout</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1">Timeout Action</label>
                                        <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="timeoutAction">
                                            <option value="escalate">Escalate to Manager</option>
                                            <option value="auto-approve">Auto Approve</option>
                                            <option value="auto-reject" selected>Auto Reject</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="config-input mr-2" data-field="allowForwarding">
                                        <span class="text-sm text-gray-700">Allow reviewers to forward to other users</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="flex items-start">
                                <i class="ri-information-line text-blue-600 mr-2 mt-1 cursor-pointer" onclick="showReviewDemo()"></i>
                                <div class="text-sm text-blue-800">
                                    <strong>Human Review Interface:</strong> When triggered, reviewers can approve, reject, check event source, or forward to another reviewer. 
                                    <span class="underline cursor-pointer" onclick="showReviewDemo()">Click icon to see demo</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Save Configuration
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createAITouchConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure AI Touch</h3>
                    <div class="space-y-4">
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-ai-generate text-purple-600 mr-2 mt-1"></i>
                                <div class="text-sm text-purple-800">
                                    <strong>AI Touch</strong> analyzes previous workflow steps and intelligently executes or generates next steps based on your instructions.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">AI Analysis Prompt</label>
                            <textarea class="config-input w-full p-3 border border-gray-300 rounded-lg text-sm" rows="4" 
                                      data-field="prompt" placeholder="Describe what AI should analyze and do...&#10;&#10;Examples:&#10;• 'If patient didn't respond to appointment reminder, send SMS and reschedule'&#10;• 'Analyze patient questionnaire results and recommend next steps'&#10;• 'Check if lab results are abnormal and create appropriate follow-up tasks'"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Context from Previous Steps</label>
                            <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="contextSteps">
                                <option value="previous-1">Previous 1 step</option>
                                <option value="previous-2">Previous 2 steps</option>
                                <option value="previous-3">Previous 3 steps</option>
                                <option value="previous-all">All previous steps</option>
                                <option value="specific">Specific steps (advanced)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Execution Mode</label>
                            <div class="space-y-3">
                                <label class="flex items-start">
                                    <input type="radio" name="executionMode" value="execute-next" class="config-input mt-1 mr-3" data-field="executionMode" checked>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">Execute Next Steps</div>
                                        <div class="text-xs text-gray-500">AI will execute pre-configured next steps based on analysis</div>
                                    </div>
                                </label>
                                <label class="flex items-start">
                                    <input type="radio" name="executionMode" value="auto-generate" class="config-input mt-1 mr-3" data-field="executionMode">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">Auto-Generate Steps</div>
                                        <div class="text-xs text-gray-500">AI will automatically create and execute new workflow steps</div>
                                    </div>
                                </label>
                                <label class="flex items-start">
                                    <input type="radio" name="executionMode" value="hybrid" class="config-input mt-1 mr-3" data-field="executionMode">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">Hybrid Mode</div>
                                        <div class="text-xs text-gray-500">Execute configured steps + auto-generate additional ones if needed</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" class="config-input mr-2" data-field="requireApproval">
                                <span class="text-sm text-gray-700">Require human approval before AI execution</span>
                            </label>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="text-sm text-blue-800">
                                <strong>💡 Tip:</strong> AI Touch works best when placed after data collection steps (forms, questionnaires, test results) or communication attempts where intelligent analysis and response are needed.
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            Save AI Touch
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createOrderEventsConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Order Update Trigger</h3>
                    <div class="space-y-4">
                        <div class="bg-teal-50 border border-teal-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-shopping-cart-line text-teal-600 mr-2 mt-1"></i>
                                <div class="text-sm text-teal-800">
                                    <strong>Order Update</strong> triggers when order status changes occur in your system.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Order Updates to Monitor:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="orderCreated" value="order-created">
                                    <span class="text-sm text-gray-700">Order Created</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="orderModified" value="order-modified">
                                    <span class="text-sm text-gray-700">Order Modified</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="orderRedrawn" value="order-redrawn">
                                    <span class="text-sm text-gray-700">Order Redrawn</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="paymentComplete" value="payment-complete">
                                    <span class="text-sm text-gray-700">Payment Complete</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="paymentFailed" value="payment-failed">
                                    <span class="text-sm text-gray-700">Payment Failed</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="paymentRefund" value="payment-refund">
                                    <span class="text-sm text-gray-700">Payment Refund</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="labShipped" value="lab-shipped">
                                    <span class="text-sm text-gray-700">Lab Shipped</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="questionnaireAssigned" value="questionnaire-assigned">
                                    <span class="text-sm text-gray-700">Questionnaire Assigned</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="missingInformation" value="missing-information">
                                    <span class="text-sm text-gray-700">Missing Information</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="testNotPerformed" value="test-not-performed">
                                    <span class="text-sm text-gray-700">Test Not Performed</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="orderCanceled" value="order-canceled">
                                    <span class="text-sm text-gray-700">Order Canceled</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                            Save Trigger
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createAppointmentEventsConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Appointment Update Trigger</h3>
                    <div class="space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-calendar-event-line text-green-600 mr-2 mt-1"></i>
                                <div class="text-sm text-green-800">
                                    <strong>Appointment Update</strong> triggers when calendar appointment status changes occur.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Appointment Updates to Monitor:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="appointmentCreated" value="appointment-created">
                                    <span class="text-sm text-gray-700">Appointment Created</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="appointmentAccepted" value="appointment-accepted">
                                    <span class="text-sm text-gray-700">Appointment Accepted</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="appointmentRejected" value="appointment-rejected">
                                    <span class="text-sm text-gray-700">Appointment Rejected</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="appointmentTentative" value="appointment-tentative">
                                    <span class="text-sm text-gray-700">Appointment Tentative</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="appointmentCancelled" value="appointment-cancelled">
                                    <span class="text-sm text-gray-700">Appointment Cancelled</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Save Trigger
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createDocumentEventsConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Document/Form Update Trigger</h3>
                    <div class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-file-text-line text-blue-600 mr-2 mt-1"></i>
                                <div class="text-sm text-blue-800">
                                    <strong>Document/Form Update</strong> triggers when document or form interactions occur.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Document/Form Updates to Monitor:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="documentViewed" value="document-viewed">
                                    <span class="text-sm text-gray-700">Document/Form Viewed</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="formSubmitted" value="form-submitted">
                                    <span class="text-sm text-gray-700">Form Submitted</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="encounterShared" value="encounter-shared">
                                    <span class="text-sm text-gray-700">Encounter Note Shared</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="encounterUpdated" value="encounter-updated">
                                    <span class="text-sm text-gray-700">Encounter Note Updated</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Save Trigger
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createReportEventsConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Report Update Trigger</h3>
                    <div class="space-y-4">
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-file-chart-line text-purple-600 mr-2 mt-1"></i>
                                <div class="text-sm text-purple-800">
                                    <strong>Report Update</strong> triggers when report status changes occur.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Report Updates to Monitor:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="reportAvailable" value="report-available">
                                    <span class="text-sm text-gray-700">Report Available</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="reportShared" value="report-shared">
                                    <span class="text-sm text-gray-700">Report Shared</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            Save Trigger
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createTaskEventsConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Task Update Trigger</h3>
                    <div class="space-y-4">
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-task-line text-orange-600 mr-2 mt-1"></i>
                                <div class="text-sm text-orange-800">
                                    <strong>Task Update</strong> triggers when task status changes occur.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Task Updates to Monitor:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="taskOpen" value="task-open">
                                    <span class="text-sm text-gray-700">Task Open</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="taskCompleted" value="task-completed">
                                    <span class="text-sm text-gray-700">Task Completed</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                            Save Trigger
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createProfileEventsConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Profile Update Trigger</h3>
                    <div class="space-y-4">
                        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-user-line text-indigo-600 mr-2 mt-1"></i>
                                <div class="text-sm text-indigo-800">
                                    <strong>Profile Update</strong> triggers when patient profile or note changes occur.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Profile Updates to Monitor:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="profileUpdated" value="profile-updated">
                                    <span class="text-sm text-gray-700">Patient Profile Updated</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="internalNoteUpdated" value="internal-note-updated">
                                    <span class="text-sm text-gray-700">Internal Note Updated</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            Save Trigger
                        </button>
                    </div>
                </div>
            `;
        }
        
        function showReviewDemo() {
            const demoModal = document.createElement('div');
            demoModal.className = 'modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            demoModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Human Review Interface Demo</h3>
                    <div class="space-y-4">
                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <div class="text-sm font-medium text-gray-900 mb-2">📧 Review Request</div>
                            <div class="text-xs text-gray-600 mb-3">Patient appointment rescheduling requires your approval</div>
                            
                            <div class="space-y-2">
                                <button class="w-full p-2 bg-green-100 border border-green-300 rounded text-sm text-green-800 hover:bg-green-200">
                                    ✅ Approve & Continue Workflow
                                </button>
                                <button class="w-full p-2 bg-red-100 border border-red-300 rounded text-sm text-red-800 hover:bg-red-200">
                                    ❌ Reject & Stop Workflow
                                </button>
                                <button class="w-full p-2 bg-blue-100 border border-blue-300 rounded text-sm text-blue-800 hover:bg-blue-200">
                                    📄 Check Event Source
                                </button>
                                <button class="w-full p-2 bg-yellow-100 border border-yellow-300 rounded text-sm text-yellow-800 hover:bg-yellow-200">
                                    🔄 Forward to Another Reviewer
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-500 text-center">
                            This interface appears when a review is actually triggered during workflow execution
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-6">
                        <button class="close-demo px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Close Demo
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(demoModal);
            
            // Close demo functionality
            demoModal.querySelector('.close-demo').addEventListener('click', () => {
                document.body.removeChild(demoModal);
            });
            
            demoModal.addEventListener('click', (e) => {
                if (e.target === demoModal) {
                    document.body.removeChild(demoModal);
                }
            });
        }
        
        function setupModalEventListeners(modal, block) {
            // Wait type toggle for wait blocks
            const waitTypeSelect = modal.querySelector('select[data-field="type"]');
            if (waitTypeSelect && block.type === 'wait') {
                waitTypeSelect.addEventListener('change', (e) => {
                    const timeConfig = modal.querySelector('#timeConfig');
                    const inputConfig = modal.querySelector('#inputConfig');
                    
                    if (e.target.value === 'input') {
                        timeConfig.classList.add('hidden');
                        inputConfig.classList.remove('hidden');
                    } else {
                        timeConfig.classList.remove('hidden');
                        inputConfig.classList.add('hidden');
                    }
                });
            }
            
            // AI analysis toggle for approval blocks
            const aiEnabledToggle = modal.querySelector('input[data-field="aiEnabled"]');
            if (aiEnabledToggle && block.type === 'approval') {
                const aiAnalysisSection = modal.querySelector('#ai-analysis-section');
                
                // Set initial state
                if (block.data.aiEnabled) {
                    aiEnabledToggle.checked = true;
                    aiAnalysisSection.style.display = 'block';
                }
                
                aiEnabledToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        aiAnalysisSection.style.display = 'block';
                    } else {
                        aiAnalysisSection.style.display = 'none';
                    }
                });
            }
            
            // Cancel button
            modal.querySelector('.cancel-btn').addEventListener('click', () => {
                modal.remove();
            });
            
            // Save button
            modal.querySelector('.save-btn').addEventListener('click', () => {
                saveBlockConfiguration(modal, block);
                modal.remove();
            });
        }
        
        function saveBlockConfiguration(modal, block) {
            const inputs = modal.querySelectorAll('.config-input');
            const data = {};
            
            inputs.forEach(input => {
                const field = input.dataset.field;
                
                if (input.type === 'radio') {
                    if (input.checked) {
                        data[field] = input.value;
                    }
                } else if (input.type === 'checkbox') {
                    data[field] = input.checked;
                } else {
                    const value = input.value.trim();
                    if (value) {
                        data[field] = value;
                    }
                }
            });
            
            // Mark as configured
            data.configured = true;
            
            // Special handling for condition blocks
            if (block.type === 'condition') {
                data.trueBranch = [];
                data.falseBranch = [];
            }
            
            // Update block data
            block.data = { ...block.data, ...data };
            
            // Re-render the workflow to show updated configuration
            renderWorkflow();
            
            showNotification('Block configuration saved!', 'success');
        }

        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addChatMessage(message, 'user');
            
            // Clear input
            chatInput.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Simulate AI response (replace with actual API call)
            setTimeout(() => {
                hideTypingIndicator();
                const hasExistingWorkflow = workflowBlocks.length > 0;
                const aiResponse = generateAIResponse(message, hasExistingWorkflow);
                addChatMessage(aiResponse, 'ai');
            }, 1500);
        }
        
        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remove empty state if it exists
            const emptyState = chatMessages.querySelector('.text-center');
            if (emptyState) {
                emptyState.remove();
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `mb-4 chat-message ${sender === 'user' ? 'text-right' : 'text-left'}`;
            
            const time = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (sender === 'user') {
                messageElement.innerHTML = `
                    <div class="inline-block max-w-xs">
                        <div class="bg-purple-600 text-white px-4 py-2 rounded-lg rounded-br-sm">
                            ${message}
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${time}</div>
                    </div>
                `;
            } else {
                messageElement.innerHTML = `
                    <div class="inline-block max-w-xs">
                        <div class="bg-gray-100 text-gray-900 px-4 py-2 rounded-lg rounded-bl-sm">
                            <div class="flex items-start">
                                <i class="ri-magic-line text-purple-600 mr-2 mt-1 text-sm"></i>
                                <div>${message}</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${time}</div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingElement = document.createElement('div');
            typingElement.id = 'typingIndicator';
            typingElement.className = 'mb-4 text-left';
            typingElement.innerHTML = `
                <div class="inline-block">
                    <div class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg rounded-bl-sm">
                        <div class="flex items-center">
                            <i class="ri-magic-line text-purple-600 mr-2"></i>
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(typingElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function generateAIResponse(userMessage, hasWorkflow) {
            // Type-aware AI response simulation - replace with actual AI integration
            const workflowTypeText = currentWorkflowType === 'patient' ? 'patient' : 'practice-wide';
            
            const responses = {
                greeting: `Hello! I'm here to help you build your ${workflowTypeText} workflow. What would you like to work on?`,
                generate: hasWorkflow ? 
                    `I can help you modify your existing ${workflowTypeText} workflow. What changes would you like to make?` :
                    `I can help you create a new ${workflowTypeText} workflow. What process would you like to automate?`,
                patient_specific: "For patient workflows, I can help you create personalized care paths, appointment follow-ups, or medication adherence workflows. What patient process would you like to automate?",
                practice_specific: "For practice workflows, I can help you set up scheduled reports, threshold alerts, or bulk operations. What system-wide process would you like to automate?",
                placeholder: `I understand you want to work on your ${workflowTypeText} workflow. This is a demo - full AI integration will provide intelligent suggestions and modifications to your workflow blocks.`
            };
            
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return responses.greeting;
            } else if (lowerMessage.includes('create') || lowerMessage.includes('generate') || lowerMessage.includes('build')) {
                return responses.generate;
            } else if (lowerMessage.includes('patient') && currentWorkflowType === 'patient') {
                return responses.patient_specific;
            } else if (lowerMessage.includes('practice') && currentWorkflowType === 'practice') {
                return responses.practice_specific;
            } else {
                return responses.placeholder;
            }
        }

        function saveWorkflow() {
            // Extract trigger blocks from workflow blocks
            const triggerBlocks = workflowBlocks.filter(block => block.type.startsWith('trigger-'));
            const triggerInfo = triggerBlocks.map(block => ({
                type: block.type.replace('trigger-', ''),
                blockId: block.id
            }));

            const workflowData = {
                name: document.getElementById('workflowName').value || 'Untitled Workflow',
                description: document.getElementById('workflowDescription').value || '',
                triggers: triggerInfo,
                blocks: workflowBlocks
            };
            
            // For now, just show success message
            showNotification('Workflow saved successfully!', 'success');
            console.log('Saved workflow:', workflowData);
        }

        function previewWorkflow() {
            showNotification('Preview feature coming soon!', 'info');
        }

        // Command Palette functionality
        let commandPaletteVisible = false;
        let filteredItems = [];
        let selectedIndex = 0;

        function showCommandPalette() {
            if (commandPaletteVisible) return;
            
            commandPaletteVisible = true;
            const palette = document.getElementById('commandPalette');
            const modal = palette.querySelector('div:nth-child(2)');
            const searchInput = document.getElementById('commandSearch');
            
            palette.classList.remove('hidden');
            
            // Trigger animation after a small delay
            setTimeout(() => {
                palette.classList.remove('opacity-0');
                modal.classList.remove('-translate-y-4');
            }, 10);
            
            setTimeout(() => {
                searchInput.focus();
            }, 150);
            
            searchInput.value = '';
            
            // Show all items initially
            updateCommandPaletteResults('');
        }

        function hideCommandPalette() {
            if (!commandPaletteVisible) return;
            
            commandPaletteVisible = false;
            const palette = document.getElementById('commandPalette');
            const modal = palette.querySelector('div:nth-child(2)');
            
            palette.classList.add('opacity-0');
            modal.classList.add('-translate-y-4');
            
            setTimeout(() => {
                palette.classList.add('hidden');
            }, 200);
            
            selectedIndex = 0;
        }

        function updateCommandPaletteResults(query) {
            const resultsContainer = document.getElementById('commandResults');
            
            // Get workflow type specific blocks (same logic as block library)
            const patientTriggers = ['trigger-order-events', 'trigger-appointment-events', 'trigger-document-events', 'trigger-report-events', 'trigger-task-events', 'trigger-profile-events'];
            const practiceTriggers = ['trigger-scheduled', 'trigger-threshold', 'trigger-system-event'];
            const patientActions = ['send-message', 'appointment', 'task', 'document', 'order', 'note'];
            const practiceActions = ['bulk-communication', 'generate-report', 'system-maintenance'];
            
            let availableTriggers, availableActions;
            if (currentWorkflowType === 'patient') {
                availableTriggers = patientTriggers;
                availableActions = patientActions;
            } else if (currentWorkflowType === 'practice') {
                availableTriggers = practiceTriggers;
                availableActions = practiceActions;
            } else {
                availableTriggers = [...patientTriggers, ...practiceTriggers];
                availableActions = [...patientActions, ...practiceActions];
            }
            
            const allowedTypes = [...availableTriggers, ...availableActions, 'wait', 'condition', 'loop', 'approval'];
            
            // Filter items based on query and workflow type
            filteredItems = Object.entries(blockConfigs).filter(([type, config]) => {
                // Only include workflow type appropriate blocks
                if (!allowedTypes.includes(type)) {
                    return false;
                }
                
                return config.title.toLowerCase().includes(query.toLowerCase()) ||
                       config.description.toLowerCase().includes(query.toLowerCase());
            });

            // Group by category with type filtering
            const triggers = filteredItems.filter(([type]) => availableTriggers.includes(type));
            const actions = filteredItems.filter(([type]) => availableActions.includes(type));
            const logic = filteredItems.filter(([type]) => ['wait', 'condition', 'loop', 'approval'].includes(type));

            let html = '';

            if (triggers.length > 0) {
                html += '<div class="mb-4"><div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Triggers</div>';
                triggers.forEach(([type, config], index) => {
                    const isSelected = index === selectedIndex;
                    html += `
                        <div class="command-item flex items-center p-3 rounded-lg cursor-pointer transition-colors ${isSelected ? 'bg-primary text-white' : 'hover:bg-gray-50'}" data-type="${type}">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 ${isSelected ? 'bg-white/20' : `bg-${config.color}-100`}">
                                <i class="${config.icon} ${isSelected ? 'text-white' : `text-${config.color}-600`}"></i>
                            </div>
                            <div>
                                <div class="font-medium">${config.title}</div>
                                <div class="text-sm ${isSelected ? 'text-white/80' : 'text-gray-500'}">${config.description}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (actions.length > 0) {
                html += '<div class="mb-4"><div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Actions</div>';
                actions.forEach(([type, config], index) => {
                    const globalIndex = triggers.length + index;
                    const isSelected = globalIndex === selectedIndex;
                    html += `
                        <div class="command-item flex items-center p-3 rounded-lg cursor-pointer transition-colors ${isSelected ? 'bg-primary text-white' : 'hover:bg-gray-50'}" data-type="${type}">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 ${isSelected ? 'bg-white/20' : `bg-${config.color}-100`}">
                                <i class="${config.icon} ${isSelected ? 'text-white' : `text-${config.color}-600`}"></i>
                            </div>
                            <div>
                                <div class="font-medium">${config.title}</div>
                                <div class="text-sm ${isSelected ? 'text-white/80' : 'text-gray-500'}">${config.description}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (logic.length > 0) {
                html += '<div class="mb-4"><div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Logic</div>';
                logic.forEach(([type, config], index) => {
                    const globalIndex = triggers.length + actions.length + index;
                    const isSelected = globalIndex === selectedIndex;
                    html += `
                        <div class="command-item flex items-center p-3 rounded-lg cursor-pointer transition-colors ${isSelected ? 'bg-primary text-white' : 'hover:bg-gray-50'}" data-type="${type}">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 ${isSelected ? 'bg-white/20' : `bg-${config.color}-100`}">
                                <i class="${config.icon} ${isSelected ? 'text-white' : `text-${config.color}-600`}"></i>
                            </div>
                            <div>
                                <div class="font-medium">${config.title}</div>
                                <div class="text-sm ${isSelected ? 'text-white/80' : 'text-gray-500'}">${config.description}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (filteredItems.length === 0) {
                html = '<div class="text-center py-8 text-gray-500">No blocks found</div>';
            }

            resultsContainer.innerHTML = html;
            selectedIndex = 0;

            // Add click handlers
            document.querySelectorAll('.command-item').forEach((item, index) => {
                item.addEventListener('click', () => {
                    const blockType = item.dataset.type;
                    addBlock(blockType);
                    hideCommandPalette();
                });
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colorClass = type === 'success' ? 'bg-green-50 text-green-600' : 'bg-blue-50 text-blue-600';
            const icon = type === 'success' ? 'ri-check-line' : 'ri-information-line';
            
            notification.className = `fixed top-4 right-4 ${colorClass} px-4 py-3 rounded-lg shadow-lg z-50`;
            notification.innerHTML = `<i class="${icon} mr-2"></i>${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>