<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Composer - Healthcare Provider Workbench</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        .primary { color: #4F46E5; }
        .bg-primary { background-color: #4F46E5; }
        .border-primary { border-color: #4F46E5; }
        .border-primary\/20 { border-color: rgba(79, 70, 229, 0.2); }
        .bg-primary\/5 { background-color: rgba(79, 70, 229, 0.05); }
        .text-primary { color: #4F46E5; }
        .rounded-button { border-radius: 8px; }
        .block-editor {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .workflow-block {
            transition: all 0.15s ease;
            border-left: 3px solid transparent;
        }
        .workflow-block:hover {
            background-color: rgba(0, 0, 0, 0.02);
            border-left-color: #e5e7eb;
        }
        .workflow-block.selected {
            background-color: rgba(79, 70, 229, 0.05);
            border-left-color: #4F46E5;
        }
        .block-handle {
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        .workflow-block:hover .block-handle {
            opacity: 1;
        }
        .slash-menu {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .condition-branch {
            border-left: 2px solid #d1d5db;
            margin-left: 1rem;
        }
        .condition-branch.true-branch {
            border-left-color: #10b981;
        }
        .condition-branch.false-branch {
            border-left-color: #ef4444;
        }
        
        /* Chat styling */
        #chatMessages {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        
        #chatMessages::-webkit-scrollbar {
            width: 4px;
        }
        
        #chatMessages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #chatMessages::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 2px;
        }
        
        #chatInput {
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }
        
        .chat-message {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Block Library styling */
        #blockCategories {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        
        #blockCategories::-webkit-scrollbar {
            width: 4px;
        }
        
        #blockCategories::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #blockCategories::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 2px;
        }
        
        .block-library-item:active {
            transform: translateY(1px);
        }
        
        .block-library-item {
            min-height: 60px;
            height: fit-content;
        }
        
        /* Container block styling */
        .workflow-container {
            position: relative;
            margin: 8px auto;
            width: 100%;
            max-width: none;
            min-width: 400px;
            padding: 0 20px;
        }
        
        /* Flowchart styling */
        .flowchart-block {
            position: relative;
            margin: 8px auto;
            padding: 16px 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
            width: fit-content;
            max-width: 500px;
            min-width: 300px;
        }
        
        .flowchart-block:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            transform: translateY(-1px);
        }
        
        .flowchart-block.configured {
            border-color: #10b981;
            background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
        }
        
        .flowchart-block.needs-config {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #ffffff 0%, #fffbeb 100%);
            animation: pulse-warning 2s infinite;
        }
        
        /* Condition block special styling */
        .flowchart-block.condition-block {
            border-radius: 0px;
            transform: rotate(45deg);
            width: 180px;
            height: 180px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .flowchart-block.condition-block .flowchart-block-header {
            transform: rotate(-45deg);
            flex-direction: column;
            text-align: center;
            margin-bottom: 0;
        }
        
        .flowchart-block.condition-block .flowchart-block-content {
            transform: rotate(-45deg);
            text-align: center;
        }
        
        .flowchart-block.condition-block .flowchart-block-actions {
            transform: rotate(-45deg);
            justify-content: center;
            margin-top: 8px;
        }
        
        @keyframes pulse-warning {
            0%, 100% { border-color: #f59e0b; }
            50% { border-color: #fbbf24; }
        }
        
        
        .flowchart-block-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .flowchart-block-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .flowchart-block-content {
            flex: 1;
            min-width: 0;
        }
        
        .flowchart-block-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 2px;
        }
        
        .flowchart-block-description {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 6px;
            line-height: 1.3;
        }
        
        .flowchart-block-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .flowchart-block-status.configured {
            background: #dcfce7;
            color: #166534;
        }
        
        .flowchart-block-status.needs-config {
            background: #fef3c7;
            color: #92400e;
        }
        
        .flowchart-block-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }
        
        .flowchart-action-btn {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            flex: 1;
        }
        
        .flowchart-action-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }
        
        .flowchart-action-btn.primary {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        
        .flowchart-action-btn.primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }
        
        .flowchart-action-btn.danger {
            color: #dc2626;
            border-color: #fecaca;
        }
        
        .flowchart-action-btn.danger:hover {
            background: #fef2f2;
            border-color: #fca5a5;
        }
        
        .drop-zone {
            transition: all 0.2s ease;
        }
        
        .drop-zone:hover {
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.05);
        }
        
        .drop-zone.drag-over {
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.1);
            transform: scale(1.02);
        }
        
        .condition-container, .loop-container {
            transition: all 0.15s ease;
        }
        
        .condition-container:hover, .loop-container:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }


        /* Canvas container for zoom and pan */
        .canvas-viewport {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .canvas-content {
            position: relative;
            transform-origin: top left;
            transition: transform 0.2s ease;
            width: 100%;
            min-height: 100%;
        }



        /* Enhanced grid positioning system */
        .workflow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            padding: 20px;
            width: 100%;
            min-height: 100vh;
            position: relative;
        }


        .grid-block {
            position: relative;
            transition: all 0.3s ease;
            transform-origin: center;
        }

        .grid-block:hover {
            transform: scale(1.02);
            z-index: 2;
        }

        .grid-block.dragging {
            transform: rotate(5deg) scale(1.05);
            z-index: 10;
            opacity: 0.8;
        }


        .workflow-connection-line {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }

        .workflow-connection-line svg {
            overflow: visible;
        }

        /* Red connection handles for drag-and-drop */
        .connection-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ef4444;
            border: 2px solid white;
            border-radius: 50%;
            cursor: grab;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .connection-handle:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.5);
            background: #dc2626;
        }

        .connection-handle.active {
            background: #dc2626;
            transform: scale(1.3);
            animation: pulse-handle 1s infinite;
        }

        .connection-handle::before {
            content: '+';
            color: white;
            font-size: 12px;
            font-weight: bold;
            line-height: 1;
        }

        @keyframes pulse-handle {
            0%, 100% { box-shadow: 0 4px 16px rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 4px 20px rgba(239, 68, 68, 0.8); }
        }

        /* Drop zone styling - make it very obvious */
        .workflow-canvas.drop-zone-active {
            position: relative;
            background-color: rgba(79, 70, 229, 0.05);
        }

        @keyframes drop-zone-pulse {
            0%, 100% { 
                opacity: 1;
            }
        }

        @keyframes message-bounce {
            0% { transform: translate(-50%, -50%) scale(1); }
            100% { transform: translate(-50%, -50%) scale(1.05); }
        }

        /* Orphaned/disconnected block styling */
        .workflow-block.orphaned {
            opacity: 0.7;
            position: relative;
        }

        .workflow-block.orphaned::after {
            content: 'DISCONNECTED';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #f59e0b;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 20;
        }

        /* Connection line with arrows */
        .workflow-connection-line.connected {
            pointer-events: auto;
            cursor: pointer;
        }

        .workflow-connection-line.connected:hover {
            filter: drop-shadow(0 2px 8px rgba(79, 70, 229, 0.4));
        }

        .workflow-connection-line path {
            stroke: #4f46e5;
            stroke-width: 2;
            fill: none;
            transition: all 0.2s ease;
        }

        .workflow-connection-line.connected path:hover {
            stroke: #3730a3;
            stroke-width: 3;
        }

        /* Arrow marker for connection lines */
        .workflow-connection-line marker path {
            fill: #4f46e5;
            stroke: none;
        }

        /* Proximity indicator for snap-to-connect */
        .connection-handle.proximity-active {
            transform: scale(1.5);
            background: #22c55e;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.6);
            animation: proximity-pulse 0.5s infinite alternate;
        }

        @keyframes proximity-pulse {
            0% { box-shadow: 0 4px 20px rgba(34, 197, 94, 0.6); }
            100% { box-shadow: 0 6px 30px rgba(34, 197, 94, 0.8); }
        }

        /* Connection target highlighting */
        .workflow-block.connection-target {
            transform: scale(1.05);
            box-shadow: 0 8px 32px rgba(34, 197, 94, 0.4);
            border: 2px solid #22c55e;
            background: rgba(34, 197, 94, 0.1);
            z-index: 15;
        }

        /* Block position relative for handles */
        .flowchart-block {
            position: relative;
        }

        /* Draggable block states */
        .block-dragging {
            opacity: 0.8;
            transform: rotate(3deg) scale(1.05);
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .block-drop-target {
            transform: scale(1.02);
            box-shadow: 0 0 0 2px #ef4444;
        }

        /* Connection preview line */
        .connection-preview {
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }

        .connection-preview svg {
            overflow: visible;
        }
        
        /* Workflow type styling */
        .workflow-type-card.selected {
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.05);
        }
        
        .workflow-type-badge-patient {
            background-color: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
        }
        
        .workflow-type-badge-practice {
            background-color: rgba(34, 197, 94, 0.1);
            color: #166534;
        }
        
        /* Fancy AI Toggle Switch */
        .ai-toggle input[type="checkbox"] {
            position: absolute;
            opacity: 0;
        }
        
        .ai-toggle-slider {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 32px;
            background-color: #e5e7eb;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ai-toggle-slider:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 28px;
            height: 28px;
            background-color: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .ai-toggle input[type="checkbox"]:checked + .ai-toggle-slider {
            background-color: #8b5cf6;
        }
        
        .ai-toggle input[type="checkbox"]:checked + .ai-toggle-slider:before {
            transform: translateX(24px);
        }
        
        .ai-toggle input[type="checkbox"]:focus + .ai-toggle-slider {
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
        }
        
        /* AI Corner Tag */
        .ai-corner-tag {
            position: absolute;
            top: 4px;
            right: 4px;
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        /* Tab Styling */
        .workflow-tab {
            transition: all 0.2s ease;
        }
        
        .workflow-tab.active {
            color: #4F46E5;
            border-color: #4F46E5;
            background-color: rgba(79, 70, 229, 0.05);
        }
        
        .tab-content {
            display: block;
        }
        
        .tab-content.hidden {
            display: none;
        }
        
        .sub-tab {
            transition: all 0.2s ease;
        }
        
        .sub-tab.active {
            color: #4F46E5;
            border-color: #4F46E5;
            background-color: rgba(79, 70, 229, 0.05);
        }
        
        .sub-tab-content {
            display: block;
        }
        
        .sub-tab-content.hidden {
            display: none;
        }
        
        .log-tab {
            transition: all 0.2s ease;
        }
        
        .log-tab.active {
            color: #4F46E5;
            border-color: #4F46E5;
        }
        
        /* Test status animations */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <button id="backBtn" class="mr-4 p-2 text-gray-500 hover:bg-gray-100 rounded-lg">
                        <i class="ri-arrow-left-line text-xl"></i>
                    </button>
                    <div class="flex flex-col">
                        <div id="workflowTypeBadge" class="mb-1 px-2 py-1 rounded-md text-xs font-semibold uppercase tracking-wide hidden self-start">
                            <i class="mr-1"></i>
                            <span></span>
                        </div>
                        <div class="flex flex-col">
                            <input id="workflowName" type="text" placeholder="My New Workflow" class="text-xl font-semibold text-gray-900 bg-transparent border-none outline-none focus:bg-white focus:px-2 focus:py-1 focus:rounded focus:border focus:border-gray-200" style="min-width: 200px;">
                            <input id="workflowDescription" type="text" placeholder="Workflow description..." class="text-sm text-gray-600 bg-transparent border-none outline-none focus:bg-white focus:px-2 focus:py-1 focus:rounded focus:border focus:border-gray-200 mt-1" style="min-width: 300px;">
                        </div>
                        
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- Zoom Controls -->
                    <div class="flex items-center bg-gray-100 border border-gray-200 rounded-button">
                        <button id="zoomOutBtn" class="px-2 py-1.5 text-sm text-gray-700 hover:bg-gray-200 rounded-l-button">
                            <i class="ri-subtract-line"></i>
                        </button>
                        <div id="zoomDisplay" class="px-3 py-1.5 text-sm text-gray-700 border-x border-gray-200 min-w-[60px] text-center">
                            100%
                        </div>
                        <button id="zoomInBtn" class="px-2 py-1.5 text-sm text-gray-700 hover:bg-gray-200 rounded-r-button">
                            <i class="ri-add-line"></i>
                        </button>
                    </div>
                    
                    <button id="manageUsageBtn" class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 border border-gray-200 rounded-button hover:bg-gray-200">
                        <i class="ri-settings-3-line mr-1.5"></i>
                        Manage Usage
                    </button>
                    <button id="copyWorkflowBtn" class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 border border-gray-200 rounded-button hover:bg-gray-200">
                        <i class="ri-file-copy-line mr-1.5"></i>
                        Copy to New
                    </button>
                    <button id="saveBtn" class="px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90">
                        <i class="ri-save-line mr-2"></i>
                        Save Workflow
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="bg-white border-b border-gray-200">
        <div class="px-6">
            <div class="flex">
                <button id="composeTab" class="workflow-tab px-4 py-3 text-sm font-medium border-b-2 border-primary text-primary bg-primary/5 flex items-center">
                    <i class="ri-edit-line mr-2"></i>
                    Compose
                </button>
                <button id="testLogTab" class="workflow-tab px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center">
                    <i class="ri-play-line mr-2"></i>
                    Test & Log
                </button>
            </div>
        </div>
    </div>

    <!-- Tab Content Container -->
    <div class="flex-1 bg-gray-50">
        <!-- Compose Tab Content -->
        <div id="composeTabContent" class="tab-content">
            <div class="h-full bg-gray-50 flex">
        <!-- Left Panel - Block Library -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col" id="blockLibraryPanel">
            <!-- Library Header -->
            <div class="p-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Block Library</h3>
                <p class="text-sm text-gray-500 mt-1">Click to add blocks to your workflow</p>
            </div>
            
            <!-- Block Categories -->
            <div class="flex-1 overflow-y-auto p-4" id="blockCategories">
                <!-- Categories will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Block Editor -->
        <div class="block-editor bg-gray-50 flex-1 overflow-auto" style="background-image: radial-gradient(circle, #e5e7eb 1px, transparent 1px); background-size: 20px 20px;">
            
            <div class="canvas-viewport">
                <div id="blockEditor" class="canvas-content w-full p-8">
                    <div id="workflowBlocks" class="flex flex-col items-stretch space-y-4 min-h-full w-full px-4">
                    <!-- Empty state -->
                    <div id="emptyState" class="text-center py-16 text-gray-400 bg-white rounded-lg max-w-md">
                        <i class="ri-workflow-line text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium mb-2">Start building your workflow</h3>
                        <p>Click blocks from the library on the left to add them to your workflow</p>
                        <p class="text-sm mt-2">Press <span class="bg-gray-100 px-2 py-1 rounded font-mono text-sm">⌘K</span> for quick search</p>
                    </div>
                </div>
            </div>
            <!-- End canvas-viewport -->
            </div>
            
            
        </div>

        <!-- Right Panel - AI Chat -->
        <div class="w-96 bg-white border-l border-gray-200 flex flex-col" id="aiChatPanel">
            <!-- Chat Header -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                        <i class="ri-magic-line text-purple-600"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">AI Assistant</h3>
                </div>
                <p class="text-sm text-gray-500 mt-1">Ask me to help with your workflow</p>
            </div>
            
            <!-- Chat Messages -->
            <div class="flex-1 overflow-y-auto p-4" id="chatMessages">
                <div class="text-center text-gray-400 py-8">
                    <i class="ri-chat-3-line text-3xl mb-2"></i>
                    <p class="text-sm">Start a conversation with AI to get help with your workflow</p>
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center space-x-2">
                    <div class="flex-1">
                        <textarea 
                            id="chatInput" 
                            class="w-full h-12 px-3 py-2 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                            placeholder="Ask AI to help with your workflow..."
                            
                        ></textarea>
                    </div>
                    <button 
                        id="sendChatBtn" 
                        class="flex-shrink-0 h-12 w-12 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 flex items-center justify-center"
                    >
                        <i class="ri-send-plane-line text-lg"></i>
                    </button>
                </div>
                <div class="text-xs text-gray-500 mt-2">Press Shift+Enter for new line, Enter to send</div>
            </div>
        </div>
            </div>
        </div>

        <!-- Test & Log Tab Content -->
        <div id="testLogTabContent" class="tab-content hidden">
            <div class="h-full bg-gray-50 flex">
                <!-- Test & Log Content -->
                <div class="flex-1 p-6">
                    <!-- Sub-tab Navigation for Test & Log -->
                    <div class="mb-6">
                        <div class="flex border-b border-gray-200">
                            <button id="testRunTab" class="sub-tab px-4 py-2 text-sm font-medium border-b-2 border-primary text-primary bg-primary/5">
                                <i class="ri-play-circle-line mr-2"></i>
                                Test Run
                            </button>
                            <button id="logViewTab" class="sub-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                <i class="ri-file-list-line mr-2"></i>
                                Log View
                            </button>
                        </div>
                    </div>

                    <!-- Test Run Content -->
                    <div id="testRunContent" class="sub-tab-content">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Test Workflow Execution</h3>
                            
                            <!-- Workflow Type Detection -->
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                                <div class="flex items-center">
                                    <div id="workflowTypeIcon" class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="ri-user-heart-line text-blue-600"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">Detected Workflow Type</p>
                                        <p id="workflowTypeText" class="text-sm text-gray-600">Patient Workflow</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Test Run Controls -->
                            <div class="mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-sm font-medium text-gray-900 mb-1">Test Execution</h4>
                                        <p class="text-sm text-gray-600" id="testDescription">Run this workflow with dummy patient data to verify functionality</p>
                                    </div>
                                    <button id="runTestBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center">
                                        <i class="ri-play-line mr-2"></i>
                                        <span id="runTestBtnText">Run with Dummy Patient</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Test Status -->
                            <div id="testStatus" class="hidden mb-6 p-4 rounded-lg">
                                <div class="flex items-center">
                                    <div id="testStatusIcon" class="w-5 h-5 mr-3">
                                        <i class="ri-loader-4-line animate-spin text-blue-600"></i>
                                    </div>
                                    <div>
                                        <p id="testStatusText" class="text-sm font-medium text-gray-900">Running test...</p>
                                        <p id="testStatusDetail" class="text-sm text-gray-600">Executing workflow blocks</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Test Results -->
                            <div id="testResults" class="hidden">
                                <h4 class="text-sm font-medium text-gray-900 mb-3">Test Results</h4>
                                <div class="space-y-3" id="testResultsList">
                                    <!-- Results will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Log View Content -->
                    <div id="logViewContent" class="sub-tab-content hidden">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <!-- Log Sub-tabs -->
                            <div class="border-b border-gray-200 px-6 pt-6">
                                <div class="flex">
                                    <button id="testLogsTab" class="log-tab px-3 py-2 text-sm font-medium border-b-2 border-primary text-primary">
                                        Test Runs
                                    </button>
                                    <button id="liveLogsTab" class="log-tab px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                        Live Runs
                                    </button>
                                </div>
                            </div>

                            <!-- Log Content -->
                            <div class="p-6">
                                <!-- Log Filters -->
                                <div class="mb-4 flex items-center space-x-4">
                                    <div class="flex items-center space-x-2">
                                        <label class="text-sm text-gray-600">Status:</label>
                                        <select class="text-sm border border-gray-300 rounded px-2 py-1">
                                            <option>All</option>
                                            <option>Success</option>
                                            <option>Failed</option>
                                            <option>Running</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <label class="text-sm text-gray-600">Date:</label>
                                        <select class="text-sm border border-gray-300 rounded px-2 py-1">
                                            <option>Last 7 days</option>
                                            <option>Last 30 days</option>
                                            <option>All time</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Log Table -->
                                <div id="logTableContainer">
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead class="bg-gray-50 border-b border-gray-200">
                                                <tr>
                                                    <th class="text-left py-3 px-4 font-medium text-gray-900">Timestamp</th>
                                                    <th class="text-left py-3 px-4 font-medium text-gray-900">Type</th>
                                                    <th class="text-left py-3 px-4 font-medium text-gray-900">Status</th>
                                                    <th class="text-left py-3 px-4 font-medium text-gray-900">Duration</th>
                                                    <th class="text-left py-3 px-4 font-medium text-gray-900">Details</th>
                                                </tr>
                                            </thead>
                                            <tbody id="logTableBody" class="divide-y divide-gray-200">
                                                <!-- Placeholder log entries -->
                                                <tr class="hover:bg-gray-50">
                                                    <td class="py-3 px-4 text-gray-900">2024-03-15 10:30:45</td>
                                                    <td class="py-3 px-4">
                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                            Test Run
                                                        </span>
                                                    </td>
                                                    <td class="py-3 px-4">
                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                            <i class="ri-check-line mr-1"></i>
                                                            Success
                                                        </span>
                                                    </td>
                                                    <td class="py-3 px-4 text-gray-600">2.3s</td>
                                                    <td class="py-3 px-4">
                                                        <button class="text-blue-600 hover:text-blue-800 text-sm">View Details</button>
                                                    </td>
                                                </tr>
                                                <tr class="hover:bg-gray-50">
                                                    <td class="py-3 px-4 text-gray-900">2024-03-15 09:15:22</td>
                                                    <td class="py-3 px-4">
                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                                            Live Run
                                                        </span>
                                                    </td>
                                                    <td class="py-3 px-4">
                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                            <i class="ri-close-line mr-1"></i>
                                                            Failed
                                                        </span>
                                                    </td>
                                                    <td class="py-3 px-4 text-gray-600">0.8s</td>
                                                    <td class="py-3 px-4">
                                                        <button class="text-blue-600 hover:text-blue-800 text-sm">View Details</button>
                                                    </td>
                                                </tr>
                                                <tr class="hover:bg-gray-50">
                                                    <td class="py-3 px-4 text-gray-900">2024-03-14 16:42:11</td>
                                                    <td class="py-3 px-4">
                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                            Test Run
                                                        </span>
                                                    </td>
                                                    <td class="py-3 px-4">
                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                            <i class="ri-check-line mr-1"></i>
                                                            Success
                                                        </span>
                                                    </td>
                                                    <td class="py-3 px-4 text-gray-600">1.9s</td>
                                                    <td class="py-3 px-4">
                                                        <button class="text-blue-600 hover:text-blue-800 text-sm">View Details</button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workflow Type Selection Modal -->
    <div id="workflowTypeModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-4xl mx-4 shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ri-workflow-line text-2xl text-purple-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Choose Workflow Type</h2>
                <p class="text-gray-600">Select the type of workflow you want to create</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Patient Workflow Option -->
                <div class="workflow-type-card cursor-pointer p-6 border-2 border-gray-200 rounded-xl hover:border-blue-400 hover:bg-blue-50 transition-all duration-200" data-type="patient">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="ri-user-heart-line text-2xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">Patient Workflow</h3>
                        <p class="text-gray-600 mb-4">Create workflows that run for individual patients based on their specific data and interactions.</p>
                        
                        <div class="text-left">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Examples:</h4>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>• Post-appointment follow-up sequence</li>
                                <li>• Medication adherence monitoring</li>
                                <li>• Care plan execution</li>
                                <li>• Patient onboarding process</li>
                            </ul>
                        </div>
                        
                        <div class="mt-4 text-left">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Triggers:</h4>
                            <div class="flex flex-wrap gap-1">
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">Patient Event</span>
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">Form Submit</span>
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">Timeline</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Practice Workflow Option -->
                <div class="workflow-type-card cursor-pointer p-6 border-2 border-gray-200 rounded-xl hover:border-green-400 hover:bg-green-50 transition-all duration-200" data-type="practice">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="ri-building-line text-2xl text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">Practice Workflow</h3>
                        <p class="text-gray-600 mb-4">Create workflows that monitor system-wide events and run across your entire practice.</p>
                        
                        <div class="text-left">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Examples:</h4>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>• Daily operational reports</li>
                                <li>• Threshold-based alerts</li>
                                <li>• Bulk patient communications</li>
                                <li>• Scheduled maintenance tasks</li>
                            </ul>
                        </div>
                        
                        <div class="mt-4 text-left">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Triggers:</h4>
                            <div class="flex flex-wrap gap-1">
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">Schedule</span>
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">Threshold</span>
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">System Event</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-8">
                <p class="text-sm text-gray-500">You can change the workflow type later if needed</p>
            </div>
        </div>
    </div>

    <!-- Trigger Restriction Modal -->
    <div id="triggerRestrictionModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl border border-red-200">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                    <i class="ri-error-warning-line text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">One Trigger Per Workflow</h3>
            </div>
            <p class="text-gray-700 mb-4">
                Each workflow can only have <strong>one trigger</strong>. You already have a trigger block in this workflow.
            </p>
            <p class="text-sm text-gray-600 mb-4">
                To add a different trigger, please delete the existing trigger block first.
            </p>
            <div class="flex justify-end">
                <button onclick="document.getElementById('triggerRestrictionModal').classList.add('hidden')" 
                        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                    Got it
                </button>
            </div>
        </div>
    </div>

    <!-- Command Palette Modal -->
    <div id="commandPalette" class="fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-200">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/20 backdrop-blur-sm" onclick="hideCommandPalette()"></div>
        
        <!-- Modal -->
        <div class="fixed top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-4 w-full max-w-2xl mx-4 transition-all duration-200">
            <div class="bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden">
                <!-- Search Input -->
                <div class="p-4 border-b border-gray-100">
                    <div class="relative">
                        <i class="ri-search-line absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input 
                            id="commandSearch" 
                            type="text" 
                            placeholder="Search for blocks..." 
                            class="w-full pl-10 pr-4 py-3 text-lg border-none outline-none bg-transparent"
                            autocomplete="off"
                        >
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-sm text-gray-400">
                            Press <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">ESC</kbd> to close
                        </div>
                    </div>
                </div>
                
                <!-- Results -->
                <div id="commandResults" class="max-h-96 overflow-y-auto p-2">
                    <!-- Results will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize workflow composer
        let workflowBlocks = [];
        let blockCounter = 0;
        let selectedBlock = null;
        let currentInput = null;
        let currentWorkflowType = null;

        // Trigger restriction modal
        function showTriggerRestrictionModal() {
            const modal = document.getElementById('triggerRestrictionModal');
            if (modal) {
                modal.classList.remove('hidden');
                
                // Auto-hide after 3 seconds
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 3000);
            }
        }

        // FollowUp relationship management functions
        function addFollowUpRelationship(parentBlockId, childBlockId) {
            const parentBlock = findBlockById(parentBlockId);
            const childBlock = findBlockById(childBlockId);
            
            if (parentBlock && childBlock) {
                // Add child to parent's followUp list if not already there
                if (!parentBlock.nextBlocks.some(block => block.id === childBlockId)) {
                    parentBlock.nextBlocks.push(childBlock);
                    childBlock.parentId = parentBlockId;
                    return true;
                }
            }
            return false;
        }

        function removeFollowUpRelationship(parentBlockId, childBlockId) {
            const parentBlock = findBlockById(parentBlockId);
            const childBlock = findBlockById(childBlockId);
            
            if (parentBlock && childBlock) {
                parentBlock.nextBlocks = parentBlock.nextBlocks.filter(block => block.id !== childBlockId);
                childBlock.parentId = null;
                return true;
            }
            return false;
        }

        function getRootBlocks() {
            // Return blocks that are not referenced as nextBlocks by any other block
            return workflowBlocks.filter(block => {
                // Check if this block is referenced as a nextBlock by any other block
                const isReferencedAsNext = workflowBlocks.some(otherBlock => 
                    otherBlock.nextBlocks && otherBlock.nextBlocks.some(nextBlock => nextBlock.id === block.id)
                );
                return !isReferencedAsNext;
            });
        }

        function getChildBlocks(parentBlockId) {
            const parentBlock = findBlockById(parentBlockId);
            return parentBlock ? parentBlock.nextBlocks : [];
        }

        function hasCircularDependency(parentBlockId, childBlockId) {
            // Check if adding this relationship would create a circular dependency
            function checkPath(currentBlockId, targetBlockId, visited = new Set()) {
                if (currentBlockId === targetBlockId) return true;
                if (visited.has(currentBlockId)) return false;
                
                visited.add(currentBlockId);
                const currentBlock = findBlockById(currentBlockId);
                if (currentBlock) {
                    return currentBlock.nextBlocks.some(child => 
                        checkPath(child.id, targetBlockId, visited)
                    );
                }
                return false;
            }
            
            return checkPath(childBlockId, parentBlockId);
        }

        // Drag and drop variables
        let draggedBlock = null;
        let dragPreviewLine = null;
        let isDraggingFromLibrary = false;

        // Setup drop zone listeners for connection handles
        function showConditionPathPromptModal(conditionBlock, nextBlock) {
            const modal = document.getElementById('blockConfigurationModal');
            const modalContent = document.getElementById('modalContent');
            
            modalContent.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure AI Path</h3>
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center mr-3">
                                    <i class="ri-git-branch-line text-white"></i>
                                </div>
                                <span class="font-medium">Condition Block</span>
                            </div>
                            <div class="text-sm text-gray-600">AI will evaluate context and choose whether to continue to:</div>
                            <div class="mt-2 p-2 bg-white rounded border">
                                <div class="flex items-center">
                                    <div class="w-6 h-6 ${getColorClasses(nextBlock.config.color).bg} ${getColorClasses(nextBlock.config.color).text} rounded mr-2 flex items-center justify-center text-sm">
                                        <i class="${nextBlock.config.icon}"></i>
                                    </div>
                                    <span class="font-medium">${nextBlock.config.title}</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">AI Decision Prompt</label>
                            <textarea id="pathPromptInput" class="w-full p-3 border border-gray-300 rounded-lg" rows="4" 
                                      placeholder="Describe when AI should continue to this step...&#10;Example: Continue to this step if the patient's symptoms are severe or require immediate attention"></textarea>
                            <div class="text-xs text-gray-500 mt-1">The AI will have context from all previous workflow steps to make this decision.</div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="cancelConditionPathModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                        <button onclick="saveConditionPath('${conditionBlock.id}', '${nextBlock.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Path</button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            
            // Focus on textarea
            setTimeout(() => {
                document.getElementById('pathPromptInput').focus();
            }, 100);
        }
        
        function cancelConditionPathModal() {
            const modal = document.getElementById('blockConfigurationModal');
            modal.classList.add('hidden');
            clearDragState();
        }
        
        function saveConditionPath(conditionBlockId, nextBlockId) {
            const promptInput = document.getElementById('pathPromptInput');
            const prompt = promptInput.value.trim();
            
            if (!prompt) {
                alert('Please enter an AI decision prompt');
                return;
            }
            
            const conditionBlock = findBlockById(conditionBlockId);
            const nextBlock = findBlockById(nextBlockId);
            
            if (!conditionBlock || !nextBlock) {
                alert('Error: Could not find blocks');
                return;
            }
            
            // Initialize paths array if not exists
            if (!conditionBlock.data.paths) {
                conditionBlock.data.paths = [];
            }
            
            // Add the path
            conditionBlock.data.paths.push({
                prompt: prompt,
                nextBlockId: nextBlockId
            });
            
            // Create follow-up relationship
            if (addFollowUpRelationship(conditionBlockId, nextBlockId)) {
                // Remove from root level if it was there
                workflowBlocks = workflowBlocks.filter(block => block.id !== nextBlockId);
                
                // Close modal
                const modal = document.getElementById('blockConfigurationModal');
                modal.classList.add('hidden');
                
                // Re-render workflow
                renderWorkflow();
            }
            
            clearDragState();
        }

        function setupDropZoneListeners(handle, parentBlock) {
            handle.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'link';
                handle.classList.add('active');
            });

            handle.addEventListener('dragleave', (e) => {
                e.preventDefault();
                handle.classList.remove('active');
            });

            handle.addEventListener('drop', (e) => {
                e.preventDefault();
                handle.classList.remove('active');
                
                if (draggedBlock) {
                    // Check for circular dependency
                    if (!hasCircularDependency(parentBlock.id, draggedBlock.id)) {
                        // Special handling for condition blocks - show prompt input modal
                        if (parentBlock.type === 'condition') {
                            showConditionPathPromptModal(parentBlock, draggedBlock);
                        } else {
                            // Create followUp relationship for regular blocks
                            if (addFollowUpRelationship(parentBlock.id, draggedBlock.id)) {
                                // Remove from root level if it was there
                                workflowBlocks = workflowBlocks.filter(block => block.id !== draggedBlock.id);
                                
                                // Re-render workflow
                                renderWorkflow();
                            }
                        }
                    } else {
                        showCircularDependencyError();
                    }
                }
                
                clearDragState();
            });
        }

        // Make blocks draggable
        function makeBlockDraggable(blockElement, block) {
            blockElement.draggable = true;
            blockElement.dataset.blockId = block.id;
            
            blockElement.addEventListener('dragstart', (e) => {
                draggedBlock = block;
                blockElement.classList.add('block-dragging');
                
                // Set drag effect
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', block.id);
                
                // Highlight all potential drop zones
                document.querySelectorAll('.connection-handle').forEach(handle => {
                    const parentBlockId = handle.dataset.blockId;
                    if (parentBlockId !== block.id && !hasCircularDependency(parentBlockId, block.id)) {
                        handle.classList.add('active');
                    }
                });
            });

            blockElement.addEventListener('dragend', (e) => {
                clearDragState();
            });
        }

        function clearDragState() {
            if (draggedBlock) {
                document.querySelector(`[data-block-id="${draggedBlock.id}"]`)?.classList.remove('block-dragging');
                draggedBlock = null;
            }
            
            // Remove all drop zone highlights
            document.querySelectorAll('.connection-handle').forEach(handle => {
                handle.classList.remove('active');
            });
            
            // Remove preview line
            if (dragPreviewLine) {
                dragPreviewLine.remove();
                dragPreviewLine = null;
            }
        }

        function showCircularDependencyError() {
            // Simple alert for now - could be replaced with a nicer modal
            alert('Cannot create this connection: it would create a circular dependency in your workflow.');
        }

        // Setup canvas as drop zone for new blocks from library
        function setupCanvasDropZone(canvasContainer) {
            canvasContainer.addEventListener('dragover', (e) => {
                // Accept all drags from library - simplified approach
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'copy';
                canvasContainer.classList.add('drop-zone-active');
                console.log('Dragover - added drop-zone-active'); // Debug log
            });

            canvasContainer.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
                canvasContainer.classList.add('drop-zone-active');
                console.log('Dragenter - added drop-zone-active'); // Debug log
            });

            canvasContainer.addEventListener('dragleave', (e) => {
                // Only remove highlight if we're actually leaving the canvas
                const rect = canvasContainer.getBoundingClientRect();
                const x = e.clientX;
                const y = e.clientY;
                
                if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                    canvasContainer.classList.remove('drop-zone-active');
                    console.log('Dragleave - removed drop-zone-active'); // Debug log
                }
            });

            canvasContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                canvasContainer.classList.remove('drop-zone-active');
                
                const blockType = e.dataTransfer.getData('text/plain');
                const isFromLibrary = e.dataTransfer.getData('application/x-block-library') === 'true';
                
                
                // Only create new blocks if dragging from library, not when moving existing blocks
                if (blockType && isFromLibrary) {
                    // Calculate drop position relative to canvas
                    const rect = canvasContainer.getBoundingClientRect();
                    const dropX = e.clientX - rect.left;
                    const dropY = e.clientY - rect.top;
                    
                    console.log('Creating new block at position:', dropX, dropY); // Debug log
                    
                    // Create block at drop position
                    createBlockAtPosition(blockType, dropX, dropY);
                } else if (blockType && !isFromLibrary) {
                    console.log('Ignoring drop - existing block being moved:', blockType); // Debug log
                }
            });
        }

        // Create a new block at specific canvas position
        function createBlockAtPosition(type, x, y) {
            // Check trigger restriction first
            if (type.startsWith('trigger-')) {
                const existingTriggers = workflowBlocks.filter(block => block.type.startsWith('trigger-'));
                if (existingTriggers.length > 0) {
                    showTriggerRestrictionModal();
                    return;
                }
            }
            
            blockCounter++;
            const config = blockConfigs[type];
            
            const block = {
                id: `block-${blockCounter}`,
                type: type,
                config: { ...config },
                data: {},
                parentId: null,
                nextBlocks: [],
                position: { x: x - 160, y: y - 40 }, // Offset to center block on cursor
                connectionPoints: {
                    bottom: { x: 0, y: 0 }
                },
                children: type === 'condition' ? { paths: [] } : 
                         type === 'loop' ? { items: [] } : null
            };

            workflowBlocks.push(block);
            
            renderWorkflow();
            hideEmptyState();
            
            // Refresh block library to update trigger restrictions
            initializeBlockLibrary();

            // Show configuration for the new block
            setTimeout(() => {
                showBlockConfiguration(block);
            }, 100);
        }

        // Draw hierarchical connection lines between parent and child blocks
        function drawHierarchicalConnections() {
            // Remove existing connection lines
            document.querySelectorAll('.workflow-connection-line').forEach(line => line.remove());
            
            const canvas = document.querySelector('.workflow-canvas');
            if (!canvas) return;
            
            // Create SVG overlay for connections
            const svgOverlay = document.createElement('div');
            svgOverlay.className = 'workflow-connection-line';
            svgOverlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 1;
            `;
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.style.cssText = 'width: 100%; height: 100%; position: absolute; top: 0; left: 0;';
            
            // Add marker definitions for arrowheads
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead');
            marker.setAttribute('markerWidth', '10');
            marker.setAttribute('markerHeight', '7');
            marker.setAttribute('refX', '9');
            marker.setAttribute('refY', '3.5');
            marker.setAttribute('orient', 'auto');
            
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
            polygon.setAttribute('fill', '#4f46e5');
            
            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);
            
            // Draw connections for each block with followUp relationships
            function drawConnectionsForBlock(block) {
                if (block.nextBlocks && block.nextBlocks.length > 0) {
                    block.nextBlocks.forEach(childBlock => {
                        // Calculate connection points - center the blocks
                        const blockWidth = 320; // Standard block width
                        const blockHeight = 80; // Standard block height
                        
                        const parentX = block.position.x + blockWidth / 2;
                        const parentY = block.position.y + blockHeight; // Bottom of parent block
                        const childX = childBlock.position.x + blockWidth / 2;
                        const childY = childBlock.position.y; // Top of child block
                        
                        // Create curved path
                        const midY = parentY + (childY - parentY) / 2;
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        path.setAttribute('d', `M ${parentX} ${parentY} Q ${parentX} ${midY} ${childX} ${childY}`);
                        path.setAttribute('stroke', '#4f46e5');
                        path.setAttribute('stroke-width', '2');
                        path.setAttribute('fill', 'none');
                        path.setAttribute('marker-end', 'url(#arrowhead)');
                        path.setAttribute('opacity', '0.8');
                        
                        svg.appendChild(path);
                        
                        // Recursively draw connections for child blocks
                        drawConnectionsForBlock(childBlock);
                    });
                }
            }
            
            // Draw connections starting from root blocks
            getRootBlocks().forEach(rootBlock => {
                drawConnectionsForBlock(rootBlock);
            });
            
            svgOverlay.appendChild(svg);
            canvas.appendChild(svgOverlay);
        }

        // Enable free dragging of blocks
        function makeBlockMovable(wrapper, block) {
            // Disable default HTML5 drag behavior
            wrapper.addEventListener('dragstart', (e) => e.preventDefault());
            let isDragging = false;
            let offsetX = 0;
            let offsetY = 0;
            wrapper.style.cursor = 'grab';
            wrapper.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                
                // Don't start block dragging if clicking on a red handle
                if (e.target.classList.contains('connection-handle') || e.target.closest('.connection-handle')) {
                    return;
                }
                
                isDragging = true;
                const rect = wrapper.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                document.body.style.userSelect = 'none';
                wrapper.style.cursor = 'grabbing';
                e.preventDefault();
                e.stopPropagation();
            });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const canvasRect = wrapper.parentElement.getBoundingClientRect();
                const x = e.clientX - canvasRect.left - offsetX;
                const y = e.clientY - canvasRect.top - offsetY;
                block.position.x = x;
                block.position.y = y;
                wrapper.style.left = `${x}px`;
                wrapper.style.top = `${y}px`;
                
                // Redraw connection lines in real-time during drag
                requestAnimationFrame(() => {
                    drawHierarchicalConnections();
                });
            });
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    document.body.style.userSelect = '';
                    wrapper.style.cursor = 'grab';
                    // Redraw connectors after drop
                    drawHierarchicalConnections();
                }
            });
        }



        // Block type configurations
        const blockConfigs = {
            'send-message': { 
                title: 'Send Message/SMS/Email', 
                icon: 'ri-message-line', 
                color: 'blue',
                description: 'Send communication to patient'
            },
            'appointment': { 
                title: 'Make Appointment', 
                icon: 'ri-calendar-line', 
                color: 'green',
                description: 'Schedule appointment with patient'
            },
            'task': { 
                title: 'Assign Task', 
                icon: 'ri-task-line', 
                color: 'purple',
                description: 'Assign task to team member'
            },
            'document': { 
                title: 'Send Document', 
                icon: 'ri-folder-shared-line', 
                color: 'orange',
                description: 'Share document with patient'
            },
            'order': { 
                title: 'Place Order', 
                icon: 'ri-shopping-cart-line', 
                color: 'teal',
                description: 'Place lab/medication order'
            },
            'note': { 
                title: 'Add Internal Note', 
                icon: 'ri-sticky-note-line', 
                color: 'yellow',
                description: 'Add note for staff'
            },
            'nested-workflow': { 
                title: 'Nest Workflow', 
                icon: 'ri-links-line', 
                color: 'indigo',
                description: 'Execute another workflow'
            },
            'wait': { 
                title: 'Wait', 
                icon: 'ri-timer-line', 
                color: 'gray',
                description: 'Wait for time or input'
            },
            'condition': { 
                title: 'Condition', 
                icon: 'ri-git-branch-line', 
                color: 'yellow',
                description: 'Conditional branching'
            },
            'loop': { 
                title: 'Loop', 
                icon: 'ri-repeat-line', 
                color: 'blue',
                description: 'Repeat actions'
            },
            'approval': { 
                title: 'Review & Approval', 
                icon: 'ri-shield-check-line', 
                color: 'red',
                description: 'Human review with optional AI pre-screening for approval decisions'
            },
            'ai-touch': {
                title: 'AI Touch',
                icon: 'ri-magic-line',
                color: 'purple',
                description: 'AI analysis and smart execution'
            },
            'trigger-order-events': {
                title: 'Order Update',
                icon: 'ri-shopping-cart-line',
                color: 'teal',
                description: 'Triggered by order status changes'
            },
            'trigger-appointment-events': {
                title: 'Appointment Update',
                icon: 'ri-calendar-event-line',
                color: 'green',
                description: 'Triggered by appointment status changes'
            },
            'trigger-document-events': {
                title: 'Document/Form Update',
                icon: 'ri-file-text-line',
                color: 'blue',
                description: 'Triggered by document or form interactions'
            },
            'trigger-report-events': {
                title: 'Report Update',
                icon: 'ri-file-chart-line',
                color: 'purple',
                description: 'Triggered by report status changes'
            },
            'trigger-task-events': {
                title: 'Task Update',
                icon: 'ri-task-line',
                color: 'orange',
                description: 'Triggered by task status changes'
            },
            'trigger-profile-events': {
                title: 'Profile Update',
                icon: 'ri-user-line',
                color: 'indigo',
                description: 'Triggered by patient profile changes'
            },
            'trigger-manual': {
                title: 'Trigger: Manual Start',
                icon: 'ri-play-circle-line',
                color: 'gray',
                description: 'Manually triggered workflow (patient assignment or button click)'
            },
            'trigger-scheduled': {
                title: 'Trigger: Scheduled',
                icon: 'ri-calendar-schedule-line',
                color: 'blue',
                description: 'Runs on a schedule (daily, weekly, monthly)'
            },
            'trigger-threshold': {
                title: 'Trigger: Threshold Alert',
                icon: 'ri-alarm-warning-line',
                color: 'orange',
                description: 'Triggered when metrics exceed thresholds'
            },
            'trigger-system-event': {
                title: 'Trigger: System Event',
                icon: 'ri-server-line',
                color: 'purple',
                description: 'Triggered by system-wide events'
            },
            'bulk-communication': {
                title: 'Bulk Communication',
                icon: 'ri-mail-send-line',
                color: 'blue',
                description: 'Send messages to multiple patients'
            },
            'generate-report': {
                title: 'Generate Report',
                icon: 'ri-file-chart-line',
                color: 'green',
                description: 'Generate practice reports and analytics'
            },
            'system-maintenance': {
                title: 'System Maintenance',
                icon: 'ri-tools-line',
                color: 'gray',
                description: 'Perform system maintenance tasks'
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
            // Get workflow type from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const workflowType = urlParams.get('type');
            
            if (workflowType && (workflowType === 'patient' || workflowType === 'practice')) {
                // Set workflow type directly from URL
                selectWorkflowType(workflowType);
                
                // Hide the selection modal
                document.getElementById('workflowTypeModal').classList.add('hidden');
                
                initializeEditor();
                setupEventListeners();
            } else {
                // Fallback to showing selection modal if no/invalid type parameter
                showWorkflowTypeSelection();
                initializeEditor();
                setupEventListeners();
            }
            
            // Initialize zoom and pan functionality
            initializeZoomAndPan();
        });

        function initializeEditor() {
            // Block editor is now initialized without the input field
            renderWorkflow();
        }

        function showWorkflowTypeSelection() {
            const modal = document.getElementById('workflowTypeModal');
            
            // Show the modal
            modal.classList.remove('hidden');
            
            // Add click handlers to workflow type cards
            const typeCards = modal.querySelectorAll('.workflow-type-card');
            typeCards.forEach(card => {
                card.addEventListener('click', () => {
                    const workflowType = card.dataset.type;
                    selectWorkflowType(workflowType);
                });
            });
        }

        function selectWorkflowType(type) {
            currentWorkflowType = type;
            
            // Hide the selection modal
            const modal = document.getElementById('workflowTypeModal');
            modal.classList.add('hidden');
            
            // Update the workflow badge
            updateWorkflowTypeBadge(type);
            
            // Initialize the block library with type-specific content
            initializeBlockLibrary();
            
            // Show empty state
            showEmptyState();
            
            // Update AI assistant context
            updateAIAssistantContext(type);
        }

        function updateWorkflowTypeBadge(type) {
            const badge = document.getElementById('workflowTypeBadge');
            const icon = badge.querySelector('i');
            const text = badge.querySelector('span');
            
            if (type === 'patient') {
                badge.className = 'mb-1 px-2 py-1 rounded-md text-xs font-semibold uppercase tracking-wide self-start workflow-type-badge-patient';
                icon.className = 'ri-user-heart-line mr-1';
                text.textContent = 'Patient Workflow';
            } else if (type === 'practice') {
                badge.className = 'mb-1 px-2 py-1 rounded-md text-xs font-semibold uppercase tracking-wide self-start workflow-type-badge-practice';
                icon.className = 'ri-building-line mr-1';
                text.textContent = 'Practice Workflow';
            }
            
            badge.classList.remove('hidden');
        }

        function updateAIAssistantContext(type) {
            // Update AI assistant header and context
            const chatHeader = document.querySelector('#aiChatPanel .p-4.border-b.border-gray-200 p');
            if (chatHeader) {
                if (type === 'patient') {
                    chatHeader.textContent = 'Ask me to help with your patient workflow';
                } else if (type === 'practice') {
                    chatHeader.textContent = 'Ask me to help with your practice workflow';
                }
            }
        }

        function initializeBlockLibrary() {
            const blockCategories = document.getElementById('blockCategories');
            
            // Define workflow type specific blocks
            const patientTriggers = ['trigger-manual', 'trigger-order-events', 'trigger-appointment-events', 'trigger-document-events', 'trigger-report-events', 'trigger-task-events', 'trigger-profile-events'];
            const practiceTriggers = ['trigger-manual', 'trigger-scheduled', 'trigger-threshold', 'trigger-system-event'];
            const patientActions = ['send-message', 'appointment', 'task', 'document', 'order', 'note'];
            const practiceActions = ['bulk-communication', 'generate-report', 'system-maintenance'];
            
            // Filter blocks based on current workflow type
            let availableTriggers, availableActions;
            
            if (currentWorkflowType === 'patient') {
                availableTriggers = patientTriggers;
                availableActions = patientActions;
            } else if (currentWorkflowType === 'practice') {
                availableTriggers = practiceTriggers;
                availableActions = practiceActions;
            } else {
                // Fallback to all blocks if no type is selected yet
                availableTriggers = [...patientTriggers, ...practiceTriggers];
                availableActions = [...patientActions, ...practiceActions];
            }
            
            // Group blocks by category with type filtering
            const triggers = Object.entries(blockConfigs).filter(([type]) => availableTriggers.includes(type));
            const actions = Object.entries(blockConfigs).filter(([type]) => availableActions.includes(type));
            const logic = Object.entries(blockConfigs).filter(([type]) => 
                ['wait', 'condition', 'loop', 'approval'].includes(type)
            );

            let html = '';

            // Triggers section
            if (triggers.length > 0) {
                const hasTrigger = workflowBlocks.some(block => block.type.startsWith('trigger-'));
                let triggerNote = '';
                if (hasTrigger) {
                    triggerNote = '<div class="mb-3 p-2 bg-amber-50 border border-amber-200 rounded-lg"><div class="text-xs text-amber-700"><i class="ri-information-line mr-1"></i>Only one trigger block allowed per workflow. Other triggers are disabled.</div></div>';
                }
                html += triggerNote + createCategorySection('Triggers', triggers);
            }

            // Actions section
            if (actions.length > 0) {
                html += createCategorySection('Actions', actions);
            }

            // Logic section
            if (logic.length > 0) {
                html += createCategorySection('Logic', logic);
            }

            blockCategories.innerHTML = html;

            // Make block library items draggable instead of clickable
            blockCategories.querySelectorAll('.block-library-item').forEach((item, index) => {
                const blockType = item.dataset.type;
                
                // Skip disabled items (like triggers when one already exists)
                if (item.classList.contains('cursor-not-allowed') || item.classList.contains('pointer-events-none')) {
                    return;
                }
                
                // Make the item draggable
                item.draggable = true;
                item.style.cursor = 'grab';
                
                item.addEventListener('dragstart', (e) => {
                    isDraggingFromLibrary = true;
                    e.dataTransfer.setData('text/plain', blockType);
                    e.dataTransfer.setData('application/x-block-library', 'true');
                    e.dataTransfer.effectAllowed = 'copy';
                    item.style.cursor = 'grabbing';
                    item.classList.add('opacity-50');
                });
                
                item.addEventListener('dragend', (e) => {
                    isDraggingFromLibrary = false;
                    item.style.cursor = 'grab';
                    item.classList.remove('opacity-50');
                });
            });
        }

        function createCategorySection(categoryName, blocks) {
            let html = `
                <div class="mb-6">
                    <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-3">${categoryName}</h4>
                    <div class="grid grid-cols-2 gap-2">
            `;

            blocks.forEach(([type, config], blockIndex) => {
                const colorClass = getColorClasses(config.color);
                const shortTitle = shortenBlockTitle(config.title);
                const aiTag = type === 'approval' ? '<div class="ai-corner-tag">AI</div>' : '';
                
                // Check if this is a trigger and if triggers are disabled
                const isTrigger = type.startsWith('trigger-');
                const hasTrigger = workflowBlocks.some(block => block.type.startsWith('trigger-'));
                const isDisabled = isTrigger && hasTrigger;
                
                const disabledClass = isDisabled ? 'opacity-50 cursor-not-allowed pointer-events-none' : 'cursor-pointer hover:bg-gray-50 hover:border-gray-300';
                const disabledTitle = isDisabled ? 'Only one trigger allowed per workflow' : `${config.title} - ${config.description}`;
                
                
                html += `
                    <div class="block-library-item relative flex flex-col items-center p-2 rounded-lg border border-gray-200 ${disabledClass} transition-colors" data-type="${type}" title="${disabledTitle}">
                        ${aiTag}
                        ${isDisabled ? '<div class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 rounded-lg z-10"><div class="text-center"><i class="ri-lock-line text-gray-400 text-lg mb-1"></i><div class="text-xs text-gray-500">Only one trigger allowed</div></div></div>' : ''}
                        <div class="w-6 h-6 ${colorClass.bg} ${colorClass.text} rounded-full flex items-center justify-center mb-1 flex-shrink-0">
                            <i class="${config.icon} text-sm"></i>
                        </div>
                        <div class="text-center">
                            <div class="text-xs font-medium text-gray-900 leading-tight">${shortTitle}</div>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        function shortenBlockTitle(title) {
            // Mapping of long titles to shorter versions
            const titleMappings = {
                'Send Message/SMS/Email': 'Send Message',
                'Make Appointment': 'Appointment',
                'Assign Task': 'Task',
                'Send Document': 'Document',
                'Place Order': 'Order',
                'Add Internal Note': 'Note',
                'Nest Workflow': 'Workflow',
                'Wait': 'Wait',
                'Condition': 'Condition',
                'Loop': 'Loop',
                'Review & Approval': 'Review & Approval',
                'AI Touch': 'AI Touch',
                // Patient triggers
                'Trigger: Appointment Booked': 'Appt Booked',
                'Trigger: Form Submitted': 'Form Submit',
                'Trigger: Patient Message': 'Patient Msg',
                'Trigger: Test Result Available': 'Test Result',
                'Trigger: Manual Start': 'Manual',
                // Practice triggers
                'Trigger: Scheduled': 'Scheduled',
                'Trigger: Threshold Alert': 'Threshold',
                'Trigger: System Event': 'System Event',
                // Practice actions
                'Bulk Communication': 'Bulk Comm',
                'Generate Report': 'Report',
                'System Maintenance': 'Maintenance'
            };

            return titleMappings[title] || title;
        }

        function setupEventListeners() {
            // Back button
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'Healthcare-Provider-Workbench.html';
            });

            // AI Chat functionality
            const sendChatBtn = document.getElementById('sendChatBtn');
            const chatInput = document.getElementById('chatInput');
            
            sendChatBtn.addEventListener('click', () => {
                sendChatMessage();
            });
            
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });

            // Save and Preview
            document.getElementById('saveBtn').addEventListener('click', saveWorkflow);
            
            // New action buttons
            document.getElementById('manageUsageBtn').addEventListener('click', manageWorkflowUsage);
            document.getElementById('copyWorkflowBtn').addEventListener('click', copyWorkflow);
            
            // Zoom control buttons
            document.getElementById('zoomInBtn').addEventListener('click', zoomIn);
            document.getElementById('zoomOutBtn').addEventListener('click', zoomOut);
            document.getElementById('zoomDisplay').addEventListener('click', resetZoom); // Click zoom display to reset

            

            
            // Command palette search
            document.getElementById('commandSearch').addEventListener('input', (e) => {
                updateCommandPaletteResults(e.target.value);
            });

            // Keyboard shortcuts for command palette
            document.addEventListener('keydown', (e) => {
                // Cmd/Ctrl + K to open command palette
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    showCommandPalette();
                    return;
                }

                // ESC to close command palette
                if (e.key === 'Escape' && commandPaletteVisible) {
                    e.preventDefault();
                    hideCommandPalette();
                    return;
                }

                // Arrow keys and Enter for navigation when palette is open
                if (commandPaletteVisible) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, filteredItems.length - 1);
                        updateCommandPaletteResults(document.getElementById('commandSearch').value);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, 0);
                        updateCommandPaletteResults(document.getElementById('commandSearch').value);
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (filteredItems[selectedIndex]) {
                            const [blockType] = filteredItems[selectedIndex];
                            addBlock(blockType);
                            hideCommandPalette();
                        }
                    }
                }
            });
        }

        function showEmptyState() {
            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                emptyState.style.display = 'block';
            }
        }

        function hideEmptyState() {
            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                emptyState.style.display = 'none';
            }
        }




        function addBlock(type, parentId = null) {
            // Check trigger restriction: only one trigger per workflow
            if (type.startsWith('trigger-')) {
                const existingTriggers = workflowBlocks.filter(block => block.type.startsWith('trigger-'));
                if (existingTriggers.length > 0) {
                    showTriggerRestrictionModal();
                    return;
                }
            }
            
            blockCounter++;
            const config = blockConfigs[type];
            
            const block = {
                id: `block-${blockCounter}`,
                type: type,
                config: { ...config },
                data: {},
                parentId: parentId,
                nextBlocks: [], // New: array of blocks that follow this one
                position: { x: 0, y: 0 }, // New: canvas position for drag-and-drop
                connectionPoints: { // New: positions for connection handles
                    bottom: { x: 0, y: 0 }
                },
                children: type === 'condition' ? { paths: [] } : 
                         type === 'loop' ? { items: [] } : null
            };

            if (parentId) {
                // Add to parent's children instead of main workflow
                const parentBlock = findBlockById(parentId);
                if (parentBlock) {
                    // This will be handled by the container-specific logic
                }
            } else {
                workflowBlocks.push(block);
            }
            
            renderWorkflow();
            hideEmptyState();
            
            // Refresh block library to update trigger restrictions
            initializeBlockLibrary();

            // Show configuration for the new block
            setTimeout(() => {
                showBlockConfiguration(block);
            }, 100);
        }

        function addTextBlock(text) {
            blockCounter++;
            
            const block = {
                id: `block-${blockCounter}`,
                type: 'text',
                config: {
                    title: 'Text Block',
                    icon: 'ri-text',
                    color: 'gray'
                },
                data: { content: text },
                parentId: null,
                children: null
            };

            workflowBlocks.push(block);
            renderWorkflow();
            hideEmptyState();
            
            // Refresh block library to update trigger restrictions
            initializeBlockLibrary();
        }

        function findBlockById(blockId) {
            function searchInBlocks(blocks) {
                for (let block of blocks) {
                    if (block.id === blockId) {
                        return block;
                    }
                    if (block.children) {
                        if (block.children.true) {
                            const found = searchInBlocks(block.children.true);
                            if (found) return found;
                        }
                        if (block.children.false) {
                            const found = searchInBlocks(block.children.false);
                            if (found) return found;
                        }
                        if (block.children.items) {
                            const found = searchInBlocks(block.children.items);
                            if (found) return found;
                        }
                    }
                }
                return null;
            }
            return searchInBlocks(workflowBlocks);
        }

        function renderWorkflow() {
            const workflowBlocksContainer = document.getElementById('workflowBlocks');
            workflowBlocksContainer.innerHTML = '';
            
            
            // Create canvas container for hierarchical layout
            const canvasContainer = document.createElement('div');
            canvasContainer.className = 'workflow-canvas';
            canvasContainer.style.cssText = `
                position: relative;
                width: 100%;
                min-height: 800px;
                padding: 40px;
                box-sizing: border-box;
                background: linear-gradient(
                    rgba(99, 102, 241, 0.05) 1px, 
                    transparent 1px
                ), 
                linear-gradient(
                    90deg, 
                    rgba(99, 102, 241, 0.05) 1px, 
                    transparent 1px
                );
                background-size: 20px 20px;
                transform-origin: top left;
            `;
            
            // Make canvas a drop zone for new blocks
            setupCanvasDropZone(canvasContainer);
            
            // Get root blocks (blocks with no parent)
            const rootBlocks = getRootBlocks();
            
            if (rootBlocks.length === 0) {
                // Show empty state
                const emptyState = document.createElement('div');
                emptyState.className = 'text-center py-16 text-gray-400';
                emptyState.style.pointerEvents = 'none'; // Allow drop events to pass through
                emptyState.innerHTML = `
                    <i class="ri-workflow-line text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium mb-2">Start building your workflow</h3>
                    <p>Drag blocks from the left panel to this canvas</p>
                    <p class="text-xs mt-2 text-gray-500">Then use the red handles to connect blocks together</p>
                `;
                canvasContainer.appendChild(emptyState);
            } else {
                // Render hierarchical structure starting from center
                const canvasCenter = { x: 600, y: 100 }; // Start from center-top of canvas
                renderHierarchicalBlocks(rootBlocks, canvasContainer, 0, canvasCenter);
            }
            
            // Ensure parent container is properly set up
            workflowBlocksContainer.style.overflow = 'hidden';
            workflowBlocksContainer.appendChild(canvasContainer);
            
            // Draw connection lines after rendering and reinitialize zoom/pan
            requestAnimationFrame(() => {
                drawHierarchicalConnections();
                markOrphanedBlocks();
                // Reinitialize zoom and pan for the new canvas
                initializeZoomAndPan();
                // Reapply current zoom and pan state to the new canvas
                updateCanvasTransform();
            });
        }

        // Mark blocks as orphaned if they're not connected to any trigger block
        function markOrphanedBlocks() {
            // Get all trigger blocks (workflow entry points)
            const triggerBlocks = workflowBlocks.filter(block => block.type.startsWith('trigger-'));
            const connectedBlocks = new Set();
            
            // Traverse all paths from trigger blocks to find connected blocks
            function markConnectedBlocks(block) {
                if (connectedBlocks.has(block.id)) return;
                connectedBlocks.add(block.id);
                
                if (block.nextBlocks) {
                    block.nextBlocks.forEach(nextBlock => {
                        markConnectedBlocks(nextBlock);
                    });
                }
            }
            
            // Start traversal from each trigger block
            triggerBlocks.forEach(triggerBlock => {
                markConnectedBlocks(triggerBlock);
            });
            
            // Mark all blocks as orphaned or connected
            workflowBlocks.forEach(block => {
                const blockElement = document.querySelector(`[data-block-id="${block.id}"]`);
                if (blockElement) {
                    if (connectedBlocks.has(block.id)) {
                        blockElement.classList.remove('orphaned');
                    } else {
                        blockElement.classList.add('orphaned');
                    }
                }
            });
        }

        function renderHierarchicalBlocks(blocks, container, level = 0, parentPosition = { x: 0, y: 0 }) {
            const blockSpacing = { x: 320, y: 160 };
            const levelOffset = level * blockSpacing.y;
            
            blocks.forEach((block, index) => {
                // Use stored position if manually placed, otherwise calculate auto position
                let position;
                if (block.position && (block.position.x !== 0 || block.position.y !== 0)) {
                    // Use manually set position for root blocks
                    position = block.position;
                } else {
                    // Calculate automatic hierarchical position
                    position = {
                        x: parentPosition.x + (index - (blocks.length - 1) / 2) * blockSpacing.x,
                        y: parentPosition.y + levelOffset
                    };
                    // Update block position data
                    block.position = position;
                }
                
                // Create block wrapper
                const blockWrapper = document.createElement('div');
                blockWrapper.className = 'workflow-block-wrapper';
                blockWrapper.style.cssText = `
                    position: absolute;
                    left: ${position.x}px;
                    top: ${position.y}px;
                    z-index: 10;
                `;
                
                renderBlock(block, blockWrapper, 0, false);
                container.appendChild(blockWrapper);
                    makeBlockMovable(blockWrapper, block);
                
                // Recursively render follow-up blocks
                if (block.nextBlocks && block.nextBlocks.length > 0) {
                    renderHierarchicalBlocks(block.nextBlocks, container, level + 1, position);
                }
            });
        }

        function renderBlock(block, container, nestingLevel = 0, isLast = false) {
            // Check if this is a container block (only loop now)
            if (block.type === 'loop') {
                renderLoopBlock(block, container, nestingLevel, isLast);
                return;
            }
            
            const blockElement = document.createElement('div');
            const indentClass = nestingLevel > 0 ? `ml-${nestingLevel * 4}` : '';
            
            // Determine configuration status
            const isConfigured = Object.keys(block.data).length > 0 && block.data.configured !== false;
            const needsConfig = !isConfigured && !['trigger-manual'].includes(block.type);
            
            const statusClass = isConfigured ? 'configured' : needsConfig ? 'needs-config' : '';
            const conditionClass = block.type === 'condition' ? 'condition-block' : '';
            
            blockElement.className = `flowchart-block ${statusClass} ${conditionClass} ${indentClass}`;
            blockElement.dataset.blockId = block.id;
            
            const colorClass = getColorClasses(block.config.color);
            
            // Create status indicator
            const statusIndicator = isConfigured ? 
                '<div class="flowchart-block-status configured"><i class="ri-check-line mr-1"></i>Configured</div>' :
                needsConfig ? 
                '<div class="flowchart-block-status needs-config"><i class="ri-settings-line mr-1"></i>Needs Setup</div>' :
                '<div class="flowchart-block-status configured"><i class="ri-check-line mr-1"></i>Ready</div>';
            
            blockElement.innerHTML = `
                <div class="flowchart-block-header">
                    <div class="flowchart-block-icon ${colorClass.bg} ${colorClass.text}">
                        <i class="${block.config.icon}"></i>
                    </div>
                    <div class="flowchart-block-content">
                        <div class="flowchart-block-title">${block.config.title}</div>
                        <div class="flowchart-block-description">${block.config.description}</div>
                        ${statusIndicator}
                    </div>
                </div>
                
                ${renderBlockContent(block)}
                
                <div class="flowchart-block-actions">
                    ${needsConfig ? 
                        '<button class="flowchart-action-btn primary configure-block"><i class="ri-settings-line mr-1"></i>Configure</button>' :
                        '<button class="flowchart-action-btn configure-block"><i class="ri-settings-line mr-1"></i>Edit</button>'
                    }
                    <button class="flowchart-action-btn danger delete-block"><i class="ri-delete-bin-line mr-1"></i>Delete</button>
                </div>
            `;
            
            // Add event listeners
            blockElement.querySelector('.configure-block').addEventListener('click', (e) => {
                e.stopPropagation();
                showBlockConfiguration(block);
            });
            
            blockElement.querySelector('.delete-block').addEventListener('click', (e) => {
                e.stopPropagation();
                showDeleteConfirmation(block.id, block.config.title);
            });
            
            // Add red connection handle for trigger and action blocks (not logic blocks)
            if (!['loop'].includes(block.type)) {
                const connectionHandle = document.createElement('div');
                connectionHandle.className = 'connection-handle';
                connectionHandle.dataset.blockId = block.id;
                connectionHandle.title = 'Drag blocks here to create follow-up steps';
                
                // Position handle at bottom center of block
                connectionHandle.style.bottom = '-10px';
                connectionHandle.style.left = '50%';
                connectionHandle.style.transform = 'translateX(-50%)';
                
                blockElement.style.position = 'relative';
                blockElement.appendChild(connectionHandle);
                
                // Add drop zone event listeners
                setupDropZoneListeners(connectionHandle, block);
            }
            
            // For blocks on canvas, completely disable HTML5 drag system
            blockElement.draggable = false;
            blockElement.style.pointerEvents = 'auto'; // Ensure mouse events work
            
            container.appendChild(blockElement);
            
            // Add red handle for next block connections (if not at max capacity)
            if (shouldShowRedHandle(block)) {
                createRedHandle(blockElement, block);
            }
        }

        // Helper function to determine if red handle should be shown
        function shouldShowRedHandle(block) {
            // Don't show handle if block already has max connections (5)
            if (block.nextBlocks && block.nextBlocks.length >= 5) {
                return false;
            }
            
            // Always show handle for blocks that can have next steps
            return true;
        }

        // Create red handle for connecting next blocks
        function createRedHandle(blockElement, block) {
            // Remove any existing handles first to prevent duplicates
            const existingHandles = blockElement.querySelectorAll('.connection-handle');
            existingHandles.forEach(handle => handle.remove());
            
            const handle = document.createElement('div');
            handle.className = 'connection-handle';
            handle.dataset.blockId = block.id;
            
            // Position handle: bottom-center if no connections, bottom-right if has connections
            const hasConnections = block.nextBlocks && block.nextBlocks.length > 0;
            if (hasConnections) {
                // Bottom-right position for blocks with existing connections
                handle.style.right = '-10px';
                handle.style.bottom = '10px';
                handle.style.left = 'auto';
                handle.style.transform = 'none';
            } else {
                // Bottom-center position for blocks with no connections
                handle.style.left = '50%';
                handle.style.bottom = '-10px';
                handle.style.right = 'auto';
                handle.style.transform = 'translateX(-50%)';
            }
            
            // Add event listeners for handle interactions
            setupRedHandleListeners(handle, block);
            
            blockElement.appendChild(handle);
        }

        // Setup event listeners for red handle interactions
        function setupRedHandleListeners(handle, parentBlock) {
            let isDraggingHandle = false;
            let connectionLine = null;
            
            // Handle dragging to create connections
            handle.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return; // Only left click
                
                isDraggingHandle = true;
                handle.classList.add('active');
                
                // Create temporary connection line
                connectionLine = createTemporaryConnectionLine(handle);
                
                // Prevent block dragging
                e.stopPropagation();
                e.preventDefault();
            });
            
            // Handle clicking to disconnect (if connected)
            handle.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!isDraggingHandle) {
                    // Show connection options or disconnect menu
                    showConnectionMenu(handle, parentBlock);
                }
            });
            
            // Global mouse move for handle dragging
            document.addEventListener('mousemove', (e) => {
                if (!isDraggingHandle) return;
                
                updateTemporaryConnectionLine(connectionLine, e);
                
                // Check for proximity to other blocks
                checkConnectionProximity(e, handle, parentBlock);
            });
            
            // Global mouse up for handle dragging
            document.addEventListener('mouseup', (e) => {
                if (!isDraggingHandle) return;
                
                isDraggingHandle = false;
                handle.classList.remove('active');
                
                // Try to create connection
                const targetBlock = findTargetBlockAtPosition(e.clientX, e.clientY);
                if (targetBlock && canConnect(parentBlock, targetBlock)) {
                    createConnection(parentBlock, targetBlock);
                    triggerAutoLayout();
                }
                
                // Cleanup temporary connection line
                if (connectionLine) {
                    connectionLine.remove();
                    connectionLine = null;
                }
                
                // Clear proximity indicators
                clearProximityIndicators();
            });
        }

        // Supporting functions for red handle functionality
        function createTemporaryConnectionLine(handle) {
            const canvas = document.getElementById('blockEditor');
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.className = 'workflow-connection-line temporary';
            svg.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;';
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('stroke', '#ef4444');
            path.setAttribute('stroke-width', '2');
            path.setAttribute('stroke-dasharray', '5,5');
            path.setAttribute('fill', 'none');
            
            svg.appendChild(path);
            canvas.appendChild(svg);
            
            return svg;
        }

        function updateTemporaryConnectionLine(connectionLine, mouseEvent) {
            if (!connectionLine) return;
            
            const canvas = document.getElementById('blockEditor');
            const canvasRect = canvas.getBoundingClientRect();
            const handle = document.querySelector('.connection-handle.active');
            if (!handle) return;
            
            const handleRect = handle.getBoundingClientRect();
            const startX = handleRect.left + handleRect.width / 2 - canvasRect.left;
            const startY = handleRect.top + handleRect.height / 2 - canvasRect.top;
            const endX = mouseEvent.clientX - canvasRect.left;
            const endY = mouseEvent.clientY - canvasRect.top;
            
            const path = connectionLine.querySelector('path');
            path.setAttribute('d', `M ${startX} ${startY} Q ${(startX + endX) / 2} ${startY + 50} ${endX} ${endY}`);
        }

        function checkConnectionProximity(mouseEvent, handle, parentBlock) {
            const targetBlock = findTargetBlockAtPosition(mouseEvent.clientX, mouseEvent.clientY);
            
            // Clear all proximity indicators first
            clearProximityIndicators();
            
            if (targetBlock && canConnect(parentBlock, targetBlock)) {
                // Add proximity indicator to target block
                const targetElement = document.querySelector(`[data-block-id="${targetBlock.id}"]`);
                if (targetElement) {
                    targetElement.classList.add('connection-target');
                }
                
                // Update handle appearance
                handle.classList.add('proximity-active');
            }
        }

        function findTargetBlockAtPosition(clientX, clientY) {
            const elements = document.elementsFromPoint(clientX, clientY);
            for (const element of elements) {
                const blockId = element.dataset.blockId || element.closest('[data-block-id]')?.dataset.blockId;
                if (blockId) {
                    return workflowBlocks.find(block => block.id === blockId);
                }
            }
            return null;
        }

        function canConnect(sourceBlock, targetBlock) {
            // Can't connect to self
            if (sourceBlock.id === targetBlock.id) return false;
            
            // Check if connection already exists
            if (sourceBlock.nextBlocks && sourceBlock.nextBlocks.some(block => block.id === targetBlock.id)) {
                return false;
            }
            
            // Prevent circular connections
            if (wouldCreateCircularConnection(sourceBlock, targetBlock)) return false;
            
            // Check max connections limit (5)
            if (sourceBlock.nextBlocks && sourceBlock.nextBlocks.length >= 5) return false;
            
            // Trigger blocks can't have incoming connections
            if (targetBlock.type.startsWith('trigger-')) return false;
            
            return true;
        }

        function wouldCreateCircularConnection(sourceBlock, targetBlock) {
            // Simple circular detection - check if targetBlock leads back to sourceBlock
            const visited = new Set();
            
            function hasPathTo(fromBlock, toBlockId) {
                if (visited.has(fromBlock.id)) return false;
                visited.add(fromBlock.id);
                
                if (!fromBlock.nextBlocks) return false;
                
                for (const nextBlock of fromBlock.nextBlocks) {
                    if (nextBlock.id === toBlockId) return true;
                    if (hasPathTo(nextBlock, toBlockId)) return true;
                }
                return false;
            }
            
            return hasPathTo(targetBlock, sourceBlock.id);
        }

        function createConnection(sourceBlock, targetBlock) {
            // Add connection
            if (!sourceBlock.nextBlocks) {
                sourceBlock.nextBlocks = [];
            }
            sourceBlock.nextBlocks.push(targetBlock);
            
            // Re-render workflow to update red handles and connections
            renderWorkflow();
            
            showNotification(`Connected ${getBlockTitle(sourceBlock)} → ${getBlockTitle(targetBlock)}`, 'success');
        }

        function clearProximityIndicators() {
            document.querySelectorAll('.connection-target').forEach(el => {
                el.classList.remove('connection-target');
            });
            document.querySelectorAll('.proximity-active').forEach(el => {
                el.classList.remove('proximity-active');
            });
        }

        function showConnectionMenu(handle, parentBlock) {
            // Simple implementation - show disconnect options if has connections
            if (parentBlock.nextBlocks && parentBlock.nextBlocks.length > 0) {
                const menu = document.createElement('div');
                menu.className = 'connection-menu absolute bg-white border rounded-lg shadow-lg p-2 z-50';
                menu.style.cssText = 'top: 30px; left: 0;';
                
                parentBlock.nextBlocks.forEach((nextBlock, index) => {
                    const option = document.createElement('button');
                    option.className = 'block w-full text-left px-3 py-1 text-sm hover:bg-gray-100 rounded';
                    option.textContent = `Disconnect from ${getBlockTitle(nextBlock)}`;
                    option.onclick = () => {
                        disconnectBlocks(parentBlock, nextBlock);
                        menu.remove();
                    };
                    menu.appendChild(option);
                });
                
                handle.appendChild(menu);
                
                // Remove menu when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', function removeMenu(e) {
                        if (!menu.contains(e.target)) {
                            menu.remove();
                            document.removeEventListener('click', removeMenu);
                        }
                    });
                }, 0);
            }
        }

        function disconnectBlocks(sourceBlock, targetBlock) {
            if (sourceBlock.nextBlocks) {
                sourceBlock.nextBlocks = sourceBlock.nextBlocks.filter(block => block.id !== targetBlock.id);
                renderWorkflow();
                showNotification(`Disconnected ${getBlockTitle(sourceBlock)} from ${getBlockTitle(targetBlock)}`, 'info');
            }
        }

        function getBlockTitle(block) {
            return block.config?.title || block.type || 'Block';
        }

        function triggerAutoLayout() {
            // Simple auto-layout: position blocks in a top-to-bottom flow
            const rootBlocks = workflowBlocks.filter(block => 
                !workflowBlocks.some(otherBlock => 
                    otherBlock.nextBlocks && otherBlock.nextBlocks.some(nextBlock => nextBlock.id === block.id)
                )
            );
            
            layoutBlocksHierarchically(rootBlocks, { x: 400, y: 100 }, 0);
            renderWorkflow();
            
            // Center blocks after auto layout
            setTimeout(() => {
                centerBlocks();
            }, 100);
        }

        function layoutBlocksHierarchically(blocks, startPosition, level) {
            const blockSpacing = { x: 320, y: 160 };
            
            blocks.forEach((block, index) => {
                // Position block
                block.position = {
                    x: startPosition.x + (index - (blocks.length - 1) / 2) * blockSpacing.x,
                    y: startPosition.y + level * blockSpacing.y
                };
                
                // Layout next blocks
                if (block.nextBlocks && block.nextBlocks.length > 0) {
                    layoutBlocksHierarchically(
                        block.nextBlocks, 
                        { x: block.position.x, y: block.position.y + blockSpacing.y }, 
                        level + 1
                    );
                }
            });
        }


        function renderLoopBlock(block, container, nestingLevel = 0, isLast = false) {
            const containerElement = document.createElement('div');
            const indentClass = nestingLevel > 0 ? `ml-${nestingLevel * 4} border-l-2 border-gray-200 pl-4` : '';
            
            containerElement.className = `workflow-container mb-4 ${indentClass}`;
            containerElement.dataset.blockId = block.id;
            
            const colorClass = getColorClasses(block.config.color);
            const loopText = block.data.count ? `Repeat ${block.data.count} times` : 'Set loop count...';
            const isExpanded = block.data.expanded !== false; // Default to expanded
            
            containerElement.innerHTML = `
                <div class="loop-container border-2 border-blue-200 rounded-lg bg-blue-50">
                    <!-- Container Header -->
                    <div class="loop-header p-4 border-b border-blue-200 cursor-pointer" onclick="toggleContainer('${block.id}')">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-8 h-8 ${colorClass.bg} ${colorClass.text} rounded-full flex items-center justify-center mr-3">
                                    <i class="${block.config.icon}"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-gray-900">LOOP: ${loopText}</div>
                                    <div class="text-xs text-gray-500">Click to ${isExpanded ? 'collapse' : 'expand'}</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="configure-block p-1 text-gray-400 hover:text-gray-600" onclick="event.stopPropagation(); showBlockConfiguration(findBlockById('${block.id}'))">
                                    <i class="ri-settings-line"></i>
                                </button>
                                <button class="delete-block p-1 text-gray-400 hover:text-red-500" onclick="event.stopPropagation(); showDeleteConfirmation('${block.id}', '${block.config.title}')">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                                <i class="ri-arrow-${isExpanded ? 'up' : 'down'}-s-line text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Container Content -->
                    <div class="loop-content ${isExpanded ? '' : 'hidden'}" id="container-${block.id}">
                        <div class="p-4">
                            <div class="loop-items">
                                <div class="branch-header mb-3">
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                                        <span class="text-sm font-medium text-blue-700">Repeated Actions</span>
                                    </div>
                                </div>
                                <div class="drop-zone min-h-16 rounded-lg p-2" 
                                     data-parent-id="${block.id}" data-branch="items">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(containerElement);
            
            // Render nested blocks if expanded
            if (isExpanded && block.children.items.length > 0) {
                const itemsDropZone = containerElement.querySelector('[data-branch="items"]');
                itemsDropZone.innerHTML = '';
                block.children.items.forEach(childBlock => {
                    renderBlock(childBlock, itemsDropZone, nestingLevel + 1);
                });
            }
        }

        function toggleContainer(blockId) {
            const block = findBlockById(blockId);
            if (block) {
                block.data.expanded = !block.data.expanded;
                renderWorkflow();
            }
        }

        function renderBlockContent(block) {
            if (block.type === 'text') {
                return `<div class="text-sm text-gray-700 mt-1">${block.data.content}</div>`;
            }
            
            if (block.type === 'condition' && block.data.configured) {
                const pathsCount = block.data.paths?.length || 0;
                return `
                    <div class="mt-3">
                        <div class="text-xs text-gray-600 mb-2">${pathsCount} AI-driven paths configured</div>
                        <div class="text-xs text-blue-600 bg-blue-50 p-2 rounded">
                            Default: Cannot Decide → Stop & Notify
                        </div>
                        ${pathsCount > 0 ? `
                            <div class="mt-2 text-xs text-gray-600">
                                Sample: "${block.data.paths[0]?.prompt.substring(0, 30)}..."
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            if (block.type === 'wait' && block.data.configured) {
                const waitType = block.data.type === 'time' ? 'Time-based' : 'Input-based';
                const waitValue = block.data.type === 'time' ? 
                    `${block.data.duration} ${block.data.unit}` : 
                    `Wait for ${block.data.inputCount} inputs`;
                return `<div class="text-sm text-gray-600 mt-1">${waitType}: ${waitValue}</div>`;
            }
            
            if (block.type === 'loop' && block.data.configured) {
                return `<div class="text-sm text-gray-600 mt-1">Repeat ${block.data.count} times</div>`;
            }
            
            if (block.type === 'approval' && block.data.configured) {
                const aiStatus = block.data.aiEnabled ? '🤖 AI Analysis + Human' : '👤 Human Only';
                const primaryReviewer = block.data.primaryReviewer || 'current-user';
                
                // Map user IDs to display names
                const userLabels = {
                    'current-user': 'Me',
                    'sarah-johnson': 'Dr. Sarah Johnson',
                    'michael-chen': 'Dr. Michael Chen', 
                    'lisa-martinez': 'Lisa Martinez, RN',
                    'david-thompson': 'David Thompson, PA',
                    'jennifer-davis': 'Jennifer Davis, NP',
                    'robert-williams': 'Dr. Robert Williams',
                    'emily-brown': 'Dr. Emily Brown',
                    'james-wilson': 'James Wilson',
                    'maria-garcia': 'Maria Garcia',
                    'thomas-anderson': 'Dr. Thomas Anderson'
                };
                
                const primaryReviewerLabel = userLabels[primaryReviewer] || 'Me';
                
                const escalationEnabled = block.data.enableEscalation;
                const escalationReviewer = block.data.escalationReviewer;
                const escalationLabel = userLabels[escalationReviewer] || 'Not set';
                
                const timeoutDuration = block.data.timeoutDuration || '24';
                const timeoutUnit = block.data.timeoutUnit || 'days';
                const timeoutDisplay = `${timeoutDuration} ${timeoutUnit === 'hours' ? 'hr' : 'day'}${timeoutDuration != '1' ? 's' : ''}`;
                
                return `
                    <div class="mt-2 space-y-1">
                        <div class="text-xs text-red-600 bg-red-50 px-2 py-1 rounded">${aiStatus}</div>
                        ${block.data.aiEnabled ? `<div class="text-xs text-gray-600">AI decisions: ✅ Approve • ❌ Reject • 🔄 Escalate</div>` : ''}
                        <div class="text-xs text-gray-600">👤 Primary: ${primaryReviewerLabel}</div>
                        ${escalationEnabled ? `<div class="text-xs text-gray-600">🔺 Escalation: ${escalationLabel}</div>` : ''}
                        <div class="text-xs text-gray-500">⏱️ Timeout: ${timeoutDisplay}</div>
                    </div>
                `;
            }
            
            if (block.type === 'ai-touch' && block.data.configured) {
                const contextLabels = {
                    'previous-1': '1 previous step',
                    'previous-2': '2 previous steps', 
                    'previous-3': '3 previous steps',
                    'previous-all': 'All previous steps',
                    'specific': 'Specific steps'
                };
                const contextSteps = contextLabels[block.data.contextSteps] || 'Previous step';
                
                const modeLabels = {
                    'execute-next': '➡️ Execute next steps',
                    'auto-generate': '⚡ Auto-generate steps',
                    'hybrid': '🔄 Hybrid mode'
                };
                const executionMode = modeLabels[block.data.executionMode] || '➡️ Execute next steps';
                
                const approvalIcon = block.data.requireApproval ? '✋ ' : '';
                
                return `
                    <div class="mt-3 space-y-2">
                        <div class="text-xs text-purple-600 bg-purple-50 p-2 rounded">
                            <strong>🤖 AI Prompt:</strong> ${block.data.prompt ? (block.data.prompt.length > 60 ? block.data.prompt.substring(0, 60) + '...' : block.data.prompt) : 'Not set'}
                        </div>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div>📥 Context: ${contextSteps}</div>
                            <div>${approvalIcon}${executionMode}</div>
                        </div>
                    </div>
                `;
            }
            
            // Handle manual trigger blocks
            if (block.type === 'trigger-manual') {
                if (currentWorkflowType === 'patient') {
                    return `
                        <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="text-sm text-blue-700 font-medium mb-1">
                                <i class="ri-user-add-line mr-1"></i>
                                Patient Assignment Trigger
                            </div>
                            <div class="text-xs text-blue-600">
                                This workflow will trigger when assigned to a patient
                            </div>
                        </div>
                    `;
                } else if (currentWorkflowType === 'practice') {
                    return `
                        <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                            <div class="text-sm text-green-700 font-medium mb-2">
                                <i class="ri-play-circle-line mr-1"></i>
                                Manual Start Trigger
                            </div>
                            <div class="text-xs text-green-600 mb-3">
                                This workflow will trigger when the manual start button is clicked
                            </div>
                            <button 
                                onclick="startManualWorkflow('${block.id}')" 
                                class="px-3 py-1.5 text-sm bg-green-600 text-white rounded-button hover:bg-green-700 flex items-center"
                            >
                                <i class="ri-play-line mr-1"></i>
                                Start Workflow
                            </button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                            <div class="text-sm text-gray-700 font-medium mb-1">
                                <i class="ri-play-circle-line mr-1"></i>
                                Manual Trigger
                            </div>
                            <div class="text-xs text-gray-600">
                                Select a workflow type to see specific trigger behavior
                            </div>
                        </div>
                    `;
                }
            }
            
            // Handle grouped trigger blocks
            if (block.type.startsWith('trigger-') && block.data.configured) {
                return renderGroupedTriggerContent(block);
            }
            
            // Show configuration status
            const hasConfig = Object.keys(block.data).length > 0;
            if (!hasConfig) {
                return `<div class="text-xs text-orange-500 mt-1">⚠️ Needs configuration</div>`;
            }
            
            return `<div class="text-xs text-green-600 mt-1">✓ Configured</div>`;
        }
        
        function renderGroupedTriggerContent(block) {
            const selectedEvents = [];
            
            // Get all selected events from block data
            Object.keys(block.data).forEach(key => {
                if (key !== 'configured' && block.data[key] === true) {
                    // Convert camelCase to readable text
                    const eventText = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    selectedEvents.push(eventText);
                }
            });
            
            if (selectedEvents.length === 0) {
                return `<div class="text-xs text-orange-500 mt-1">⚠️ No events selected</div>`;
            }
            
            const eventColors = {
                'trigger-order-events': 'teal',
                'trigger-appointment-events': 'green',
                'trigger-document-events': 'blue',
                'trigger-report-events': 'purple',
                'trigger-task-events': 'orange',
                'trigger-profile-events': 'indigo'
            };
            
            const color = eventColors[block.type] || 'gray';
            
            return `
                <div class="mt-3">
                    <div class="text-xs text-gray-600 mb-2">Monitoring ${selectedEvents.length} event${selectedEvents.length > 1 ? 's' : ''}:</div>
                    <div class="flex flex-wrap gap-1">
                        ${selectedEvents.slice(0, 3).map(event => 
                            `<span class="px-2 py-1 bg-${color}-100 text-${color}-700 text-xs rounded">${event}</span>`
                        ).join('')}
                        ${selectedEvents.length > 3 ? `<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">+${selectedEvents.length - 3} more</span>` : ''}
                    </div>
                </div>
            `;
        }

        function getColorClasses(color) {
            const colorMap = {
                blue: { bg: 'bg-blue-100', text: 'text-blue-600' },
                green: { bg: 'bg-green-100', text: 'text-green-600' },
                purple: { bg: 'bg-purple-100', text: 'text-purple-600' },
                orange: { bg: 'bg-orange-100', text: 'text-orange-600' },
                teal: { bg: 'bg-teal-100', text: 'text-teal-600' },
                yellow: { bg: 'bg-yellow-100', text: 'text-yellow-600' },
                indigo: { bg: 'bg-indigo-100', text: 'text-indigo-600' },
                gray: { bg: 'bg-gray-100', text: 'text-gray-600' },
                red: { bg: 'bg-red-100', text: 'text-red-600' }
            };
            return colorMap[color] || colorMap.gray;
        }

        function selectBlock(block) {
            // Remove previous selection
            document.querySelectorAll('.workflow-block').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selection to current block
            const blockElement = document.querySelector(`[data-block-id="${block.id}"]`);
            blockElement.classList.add('selected');
            selectedBlock = block;
        }

        function showDeleteConfirmation(blockId, blockTitle) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4 shadow-xl">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                            <i class="ri-delete-bin-line text-red-600 text-lg"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">Delete Block</h3>
                    </div>
                    <p class="text-gray-600 mb-6">Are you sure you want to delete the <strong>${blockTitle}</strong> block? This action cannot be undone.</p>
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-delete px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button class="confirm-delete px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            Delete Block
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            modal.querySelector('.cancel-delete').addEventListener('click', () => {
                modal.remove();
            });
            
            modal.querySelector('.confirm-delete').addEventListener('click', () => {
                try {
                    deleteBlock(blockId);
                    // Small delay to ensure the operation completes
                    setTimeout(() => {
                        modal.remove();
                    }, 50);
                } catch (error) {
                    console.error('Error deleting block:', error);
                    modal.remove();
                }
            });
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function deleteBlock(blockId) {
            const blockToDelete = findBlockById(blockId);
            if (!blockToDelete) return;
            
            // Remove from main workflow blocks if it's a root block
            workflowBlocks = workflowBlocks.filter(block => block.id !== blockId);
            
            // Remove from any parent's followUp blocks
            workflowBlocks.forEach(block => {
                removeFromFollowUps(block, blockId);
            });
            
            // If the deleted block had followUp blocks, move them back to root level
            if (blockToDelete.nextBlocks && blockToDelete.nextBlocks.length > 0) {
                blockToDelete.nextBlocks.forEach(childBlock => {
                    childBlock.parentId = null;
                    workflowBlocks.push(childBlock);
                });
            }
            
            renderWorkflow();
            
            // Refresh block library to update trigger restrictions
            initializeBlockLibrary();
            
            if (workflowBlocks.length === 0) {
                showEmptyState();
            }
        }

        function removeFromFollowUps(block, blockIdToRemove) {
            // Remove from followUp blocks
            if (block.nextBlocks) {
                block.nextBlocks = block.nextBlocks.filter(child => child.id !== blockIdToRemove);
                
                // Recursively check child blocks
                block.nextBlocks.forEach(childBlock => {
                    removeFromFollowUps(childBlock, blockIdToRemove);
                });
            }
            
            // Also handle legacy children structure for condition/loop blocks
            if (block.children) {
                if (block.children.true) {
                    block.children.true = block.children.true.filter(child => child.id !== blockIdToRemove);
                    block.children.true.forEach(child => removeFromFollowUps(child, blockIdToRemove));
                }
                if (block.children.false) {
                    block.children.false = block.children.false.filter(child => child.id !== blockIdToRemove);
                    block.children.false.forEach(child => removeFromFollowUps(child, blockIdToRemove));
                }
                if (block.children.items) {
                    block.children.items = block.children.items.filter(child => child.id !== blockIdToRemove);
                    block.children.items.forEach(child => removeFromFollowUps(child, blockIdToRemove));
                }
            }
        }

        function showBlockConfiguration(block) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            
            let modalContent = '';
            
            switch (block.type) {
                case 'send-message':
                    modalContent = createMessageConfigModal(block);
                    break;
                case 'appointment':
                    modalContent = createAppointmentConfigModal(block);
                    break;
                case 'task':
                    modalContent = createTaskConfigModal(block);
                    break;
                case 'wait':
                    modalContent = createWaitConfigModal(block);
                    break;
                case 'condition':
                    modalContent = createConditionConfigModal(block);
                    break;
                case 'loop':
                    modalContent = createLoopConfigModal(block);
                    break;
                case 'approval':
                    modalContent = createApprovalConfigModal(block);
                    break;
                case 'ai-touch':
                    modalContent = createAITouchConfigModal(block);
                    break;
                case 'trigger-order-events':
                    modalContent = createOrderEventsConfigModal(block);
                    break;
                case 'trigger-appointment-events':
                    modalContent = createAppointmentEventsConfigModal(block);
                    break;
                case 'trigger-document-events':
                    modalContent = createDocumentEventsConfigModal(block);
                    break;
                case 'trigger-report-events':
                    modalContent = createReportEventsConfigModal(block);
                    break;
                case 'trigger-task-events':
                    modalContent = createTaskEventsConfigModal(block);
                    break;
                case 'trigger-profile-events':
                    modalContent = createProfileEventsConfigModal(block);
                    break;
                default:
                    modalContent = createGenericConfigModal(block);
            }
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // Setup modal event listeners
            setupModalEventListeners(modal, block);
        }
        
        function createMessageConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Message</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Message Type</label>
                            <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="type">
                                <option value="">Select type...</option>
                                <option value="sms">SMS</option>
                                <option value="email">Email</option>
                                <option value="in-app">In-App Message</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Subject (Email only)</label>
                            <input type="text" class="config-input w-full p-2 border border-gray-300 rounded-lg" 
                                   data-field="subject" placeholder="Email subject...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Message Content</label>
                            <textarea class="config-input w-full p-2 border border-gray-300 rounded-lg" rows="4" 
                                      data-field="content" placeholder="Message content..."></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Save Configuration
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createWaitConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-lg mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Wait</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Wait Type</label>
                            <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="type">
                                <option value="time">Fixed Time Period</option>
                                <option value="input">Wait for Input</option>
                            </select>
                        </div>
                        <div id="timeConfig" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Duration</label>
                                <input type="number" class="config-input w-full p-2 border border-gray-300 rounded-lg" 
                                       data-field="duration" min="1" placeholder="1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Unit</label>
                                <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="unit">
                                    <option value="minutes">Minutes</option>
                                    <option value="hours">Hours</option>
                                    <option value="days">Days</option>
                                </select>
                            </div>
                        </div>
                        <div id="inputConfig" class="hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Number of Inputs Required</label>
                                <input type="number" class="config-input w-full p-2 border border-gray-300 rounded-lg" 
                                       data-field="inputCount" min="1" placeholder="1">
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Save Configuration
                        </button>
                    </div>
                </div>
            `;
        }
        
        function removeConditionPath(pathIndex) {
            // This will be handled when the modal is saved
            const pathElement = document.querySelector(`[data-path-index="${pathIndex}"]`).closest('.border');
            pathElement.style.opacity = '0.5';
            pathElement.style.pointerEvents = 'none';
            pathElement.setAttribute('data-marked-for-deletion', 'true');
        }

        function createConditionConfigModal(block) {
            const paths = block.data.paths || [];
            const pathsHtml = paths.map((path, index) => {
                const nextBlock = findBlockById(path.nextBlockId);
                const blockName = nextBlock ? nextBlock.config.title : 'Unknown Block';
                const blockIcon = nextBlock ? nextBlock.config.icon : 'ri-question-line';
                const blockColor = nextBlock ? getColorClasses(nextBlock.config.color) : { bg: 'bg-gray-500', text: 'text-white' };
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center">
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-medium">Path ${index + 1}</span>
                                <div class="ml-3 flex items-center">
                                    <div class="w-5 h-5 ${blockColor.bg} ${blockColor.text} rounded mr-2 flex items-center justify-center text-xs">
                                        <i class="${blockIcon}"></i>
                                    </div>
                                    <span class="text-sm font-medium">${blockName}</span>
                                </div>
                            </div>
                            <button onclick="removeConditionPath(${index})" class="text-red-500 hover:text-red-700 text-sm">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">AI Decision Prompt:</label>
                            <textarea class="path-prompt-input w-full p-2 text-sm border border-gray-300 rounded" rows="2" 
                                      data-path-index="${index}" placeholder="When should AI take this path?">${path.prompt}</textarea>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white rounded-lg p-6 max-w-3xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure AI-Driven Condition</h3>
                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="ri-brain-line text-blue-600 mr-2"></i>
                                <span class="font-medium text-blue-900">AI Decision Making</span>
                            </div>
                            <p class="text-sm text-blue-800">
                                This condition block uses AI to analyze workflow context and decide which path to take. 
                                Connect different blocks using the red handle, and specify when AI should choose each path.
                            </p>
                        </div>
                        
                        ${paths.length > 0 ? `
                            <div>
                                <h4 class="font-medium text-gray-900 mb-3">Configured Paths (${paths.length})</h4>
                                <div class="space-y-3">
                                    ${pathsHtml}
                                </div>
                            </div>
                        ` : `
                            <div class="text-center py-8 text-gray-500">
                                <i class="ri-links-line text-3xl mb-2"></i>
                                <p>No paths configured yet</p>
                                <p class="text-sm">Drag blocks to the red handle to create AI-driven paths</p>
                            </div>
                        `}
                        
                        <div class="border-t pt-4">
                            <div class="flex items-center text-sm text-gray-600 bg-orange-50 p-3 rounded-lg">
                                <i class="ri-alert-line text-orange-600 mr-2"></i>
                                <div>
                                    <strong>Default Behavior:</strong> If AI cannot decide which path to take, the workflow will stop and send a notification message: "Cannot decide next step - manual review required."
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                            Save Configuration
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createLoopConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-lg mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Loop</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Repeat Count</label>
                            <input type="number" class="config-input w-full p-2 border border-gray-300 rounded-lg" 
                                   data-field="count" min="1" placeholder="3">
                        </div>
                        <div class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                            <strong>Note:</strong> Actions following this loop will be repeated the specified number of times.
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Save Configuration
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createGenericConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-lg mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure ${block.config.title}</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea class="config-input w-full p-2 border border-gray-300 rounded-lg" rows="3" 
                                      data-field="description" placeholder="Describe what this block should do..."></textarea>
                        </div>
                        <div class="text-sm text-yellow-600 bg-yellow-50 p-3 rounded-lg">
                            <strong>Note:</strong> This block type will need additional configuration during workflow execution.
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Save Configuration
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createAppointmentConfigModal(block) {
            return createGenericConfigModal(block);
        }
        
        function createTaskConfigModal(block) {
            return createGenericConfigModal(block);
        }
        
        function createApprovalConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <!-- Header Section -->
                    <div class="border-b border-gray-200 pb-4 mb-6">
                        <div class="flex items-center mb-2">
                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                <i class="ri-shield-check-line text-red-600 text-lg"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">Review & Approval</h3>
                                <p class="text-sm text-gray-600">Configure approval workflow with optional AI pre-screening</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Human Review Section -->
                        <div class="space-y-4">
                            <div class="flex items-center">
                                <i class="ri-user-line text-gray-600 mr-2"></i>
                                <h4 class="text-lg font-medium text-gray-900">Human Review Settings</h4>
                            </div>
                            
                            <div>
                                <label class="flex items-center mb-3">
                                    <input type="checkbox" class="config-input mr-3" data-field="enableEscalation">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">Enable Escalated Approval</div>
                                        <div class="text-xs text-gray-500">Set up a two-tier approval process with escalation</div>
                                    </div>
                                </label>
                            </div>
                            
                            <div class="grid grid-cols-1 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Primary Reviewer</label>
                                    <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="primaryReviewer">
                                        <option value="current-user" selected>Me (Current User)</option>
                                        <option value="sarah-johnson">Dr. Sarah Johnson</option>
                                        <option value="michael-chen">Dr. Michael Chen</option>
                                        <option value="lisa-martinez">Lisa Martinez, RN</option>
                                        <option value="david-thompson">David Thompson, PA</option>
                                        <option value="jennifer-davis">Jennifer Davis, NP</option>
                                    </select>
                                </div>
                                
                                <div id="escalation-reviewer-section" class="hidden">
                                    <label class="block text-sm text-gray-600 mb-1">Escalation Reviewer</label>
                                    <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="escalationReviewer">
                                        <option value="">Select escalation reviewer...</option>
                                        <option value="robert-williams">Dr. Robert Williams (Chief Medical Officer)</option>
                                        <option value="emily-brown">Dr. Emily Brown (Medical Director)</option>
                                        <option value="james-wilson">James Wilson (Practice Manager)</option>
                                        <option value="maria-garcia">Maria Garcia (Clinical Supervisor)</option>
                                        <option value="thomas-anderson">Dr. Thomas Anderson (Department Head)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-2">Review Response Time</label>
                                    <div class="flex space-x-2">
                                        <input type="number" min="1" max="999" class="config-input w-16 p-2 border border-gray-300 rounded-lg text-center" 
                                               data-field="timeoutDuration" placeholder="24" value="24">
                                        <select class="config-input flex-1 p-2 border border-gray-300 rounded-lg" data-field="timeoutUnit">
                                            <option value="hours">Hours</option>
                                            <option value="days" selected>Days</option>
                                        </select>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">How long to wait for response</div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm text-gray-600 mb-2">If No Response After Timeout</label>
                                    <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="timeoutAction">
                                        <option value="auto-reject" selected>Auto Reject - Stop workflow</option>
                                        <option value="auto-approve">Auto Approve - Continue workflow</option>
                                        <option value="remind-again">Send Reminder & Extend deadline</option>
                                        <option value="escalate" class="escalation-only hidden">Escalate to Higher Authority</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Demo Section -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <div class="flex items-start">
                                    <i class="ri-information-line text-blue-600 mr-2 mt-1 cursor-pointer" onclick="showReviewDemo()"></i>
                                    <div class="text-sm text-blue-800">
                                        <span class="underline cursor-pointer" onclick="showReviewDemo()">Preview human review interface</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Analysis Section -->
                        <div class="border-t border-gray-200 pt-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <i class="ri-robot-line text-purple-600 mr-2"></i>
                                    <h4 class="text-lg font-medium text-gray-900">AI Pre-Screening</h4>
                                </div>
                                
                                <!-- Fancy AI Toggle -->
                                <div class="flex items-center">
                                    <label class="ai-toggle flex items-center cursor-pointer">
                                        <input type="checkbox" class="config-input" data-field="aiEnabled">
                                        <div class="ai-toggle-slider"></div>
                                        <span class="ml-3 text-sm font-medium text-gray-700">Enable AI Analysis</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="text-sm text-gray-600 mb-4">
                                AI can analyze workflow data and make initial approval decisions before routing to human reviewers
                            </div>
                            
                            <div id="ai-analysis-section" class="space-y-4" style="display: none;">
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                    <h5 class="text-sm font-medium text-gray-900 mb-3">AI Decision Instructions</h5>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-green-700 mb-1">
                                                <i class="ri-check-line mr-1"></i>Approval Instructions
                                            </label>
                                            <textarea class="config-input w-full p-2 border border-gray-300 rounded-lg text-sm" rows="2" 
                                                      data-field="approvalInstructions" placeholder="When should AI approve and continue workflow? &#10;Example: 'If patient confirmed appointment within 24 hours'"></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-red-700 mb-1">
                                                <i class="ri-close-line mr-1"></i>Rejection Instructions
                                            </label>
                                            <textarea class="config-input w-full p-2 border border-gray-300 rounded-lg text-sm" rows="2" 
                                                      data-field="rejectionInstructions" placeholder="When should AI reject and stop workflow? &#10;Example: 'If patient requested cancellation or no response after 48 hours'"></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-orange-700 mb-1">
                                                <i class="ri-arrow-up-line mr-1"></i>Escalation Instructions
                                            </label>
                                            <textarea class="config-input w-full p-2 border border-gray-300 rounded-lg text-sm" rows="2" 
                                                      data-field="escalationInstructions" placeholder="When should AI escalate to human review? &#10;Example: 'If patient response is unclear or requests special accommodation'"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Save Configuration
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createAITouchConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure AI Touch</h3>
                    <div class="space-y-4">
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-ai-generate text-purple-600 mr-2 mt-1"></i>
                                <div class="text-sm text-purple-800">
                                    <strong>AI Touch</strong> analyzes previous workflow steps and intelligently executes or generates next steps based on your instructions.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">AI Analysis Prompt</label>
                            <textarea class="config-input w-full p-3 border border-gray-300 rounded-lg text-sm" rows="4" 
                                      data-field="prompt" placeholder="Describe what AI should analyze and do...&#10;&#10;Examples:&#10;• 'If patient didn't respond to appointment reminder, send SMS and reschedule'&#10;• 'Analyze patient questionnaire results and recommend next steps'&#10;• 'Check if lab results are abnormal and create appropriate follow-up tasks'"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Context from Previous Steps</label>
                            <select class="config-input w-full p-2 border border-gray-300 rounded-lg" data-field="contextSteps">
                                <option value="previous-1">Previous 1 step</option>
                                <option value="previous-2">Previous 2 steps</option>
                                <option value="previous-3">Previous 3 steps</option>
                                <option value="previous-all">All previous steps</option>
                                <option value="specific">Specific steps (advanced)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Execution Mode</label>
                            <div class="space-y-3">
                                <label class="flex items-start">
                                    <input type="radio" name="executionMode" value="execute-next" class="config-input mt-1 mr-3" data-field="executionMode" checked>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">Execute Next Steps</div>
                                        <div class="text-xs text-gray-500">AI will execute pre-configured next steps based on analysis</div>
                                    </div>
                                </label>
                                <label class="flex items-start">
                                    <input type="radio" name="executionMode" value="auto-generate" class="config-input mt-1 mr-3" data-field="executionMode">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">Auto-Generate Steps</div>
                                        <div class="text-xs text-gray-500">AI will automatically create and execute new workflow steps</div>
                                    </div>
                                </label>
                                <label class="flex items-start">
                                    <input type="radio" name="executionMode" value="hybrid" class="config-input mt-1 mr-3" data-field="executionMode">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">Hybrid Mode</div>
                                        <div class="text-xs text-gray-500">Execute configured steps + auto-generate additional ones if needed</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" class="config-input mr-2" data-field="requireApproval">
                                <span class="text-sm text-gray-700">Require human approval before AI execution</span>
                            </label>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="text-sm text-blue-800">
                                <strong>💡 Tip:</strong> AI Touch works best when placed after data collection steps (forms, questionnaires, test results) or communication attempts where intelligent analysis and response are needed.
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            Save AI Touch
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createOrderEventsConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Order Update Trigger</h3>
                    <div class="space-y-4">
                        <div class="bg-teal-50 border border-teal-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-shopping-cart-line text-teal-600 mr-2 mt-1"></i>
                                <div class="text-sm text-teal-800">
                                    <strong>Order Update</strong> triggers when order status changes occur in your system.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Order Updates to Monitor:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="orderCreated" value="order-created">
                                    <span class="text-sm text-gray-700">Order Created</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="orderModified" value="order-modified">
                                    <span class="text-sm text-gray-700">Order Modified</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="orderRedrawn" value="order-redrawn">
                                    <span class="text-sm text-gray-700">Order Redrawn</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="paymentComplete" value="payment-complete">
                                    <span class="text-sm text-gray-700">Payment Complete</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="paymentFailed" value="payment-failed">
                                    <span class="text-sm text-gray-700">Payment Failed</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="paymentRefund" value="payment-refund">
                                    <span class="text-sm text-gray-700">Payment Refund</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="labShipped" value="lab-shipped">
                                    <span class="text-sm text-gray-700">Lab Shipped</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="questionnaireAssigned" value="questionnaire-assigned">
                                    <span class="text-sm text-gray-700">Questionnaire Assigned</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="missingInformation" value="missing-information">
                                    <span class="text-sm text-gray-700">Missing Information</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="testNotPerformed" value="test-not-performed">
                                    <span class="text-sm text-gray-700">Test Not Performed</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="orderCanceled" value="order-canceled">
                                    <span class="text-sm text-gray-700">Order Canceled</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                            Save Trigger
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createAppointmentEventsConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Appointment Update Trigger</h3>
                    <div class="space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-calendar-event-line text-green-600 mr-2 mt-1"></i>
                                <div class="text-sm text-green-800">
                                    <strong>Appointment Update</strong> triggers when calendar appointment status changes occur.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Appointment Updates to Monitor:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="appointmentCreated" value="appointment-created">
                                    <span class="text-sm text-gray-700">Appointment Created</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="appointmentAccepted" value="appointment-accepted">
                                    <span class="text-sm text-gray-700">Appointment Accepted</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="appointmentRejected" value="appointment-rejected">
                                    <span class="text-sm text-gray-700">Appointment Rejected</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="appointmentTentative" value="appointment-tentative">
                                    <span class="text-sm text-gray-700">Appointment Tentative</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="appointmentCancelled" value="appointment-cancelled">
                                    <span class="text-sm text-gray-700">Appointment Cancelled</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Save Trigger
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createDocumentEventsConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Document/Form Update Trigger</h3>
                    <div class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-file-text-line text-blue-600 mr-2 mt-1"></i>
                                <div class="text-sm text-blue-800">
                                    <strong>Document/Form Update</strong> triggers when document or form interactions occur.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Document/Form Updates to Monitor:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="documentViewed" value="document-viewed">
                                    <span class="text-sm text-gray-700">Document/Form Viewed</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="formSubmitted" value="form-submitted">
                                    <span class="text-sm text-gray-700">Form Submitted</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="encounterShared" value="encounter-shared">
                                    <span class="text-sm text-gray-700">Encounter Note Shared</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="encounterUpdated" value="encounter-updated">
                                    <span class="text-sm text-gray-700">Encounter Note Updated</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Save Trigger
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createReportEventsConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Report Update Trigger</h3>
                    <div class="space-y-4">
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-file-chart-line text-purple-600 mr-2 mt-1"></i>
                                <div class="text-sm text-purple-800">
                                    <strong>Report Update</strong> triggers when report status changes occur.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Report Updates to Monitor:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="reportAvailable" value="report-available">
                                    <span class="text-sm text-gray-700">Report Available</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="reportShared" value="report-shared">
                                    <span class="text-sm text-gray-700">Report Shared</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            Save Trigger
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createTaskEventsConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Task Update Trigger</h3>
                    <div class="space-y-4">
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-task-line text-orange-600 mr-2 mt-1"></i>
                                <div class="text-sm text-orange-800">
                                    <strong>Task Update</strong> triggers when task status changes occur.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Task Updates to Monitor:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="taskOpen" value="task-open">
                                    <span class="text-sm text-gray-700">Task Open</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="taskCompleted" value="task-completed">
                                    <span class="text-sm text-gray-700">Task Completed</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                            Save Trigger
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createProfileEventsConfigModal(block) {
            return `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Configure Profile Update Trigger</h3>
                    <div class="space-y-4">
                        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="ri-user-line text-indigo-600 mr-2 mt-1"></i>
                                <div class="text-sm text-indigo-800">
                                    <strong>Profile Update</strong> triggers when patient profile or note changes occur.
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Profile Updates to Monitor:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="profileUpdated" value="profile-updated">
                                    <span class="text-sm text-gray-700">Patient Profile Updated</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="config-input mr-2" data-field="internalNoteUpdated" value="internal-note-updated">
                                    <span class="text-sm text-gray-700">Internal Note Updated</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button class="save-btn px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            Save Trigger
                        </button>
                    </div>
                </div>
            `;
        }
        
        function showReviewDemo() {
            const demoModal = document.createElement('div');
            demoModal.className = 'modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            demoModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-lg mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Human Review Interface Demo</h3>
                    <div class="space-y-6">
                        <!-- Source Event Details -->
                        <div class="border border-gray-200 rounded-lg p-4 bg-blue-50">
                            <div class="flex items-center mb-3">
                                <i class="ri-calendar-event-line text-blue-600 mr-2"></i>
                                <div class="text-sm font-medium text-gray-900">Source Event Details</div>
                            </div>
                            <div class="space-y-2 text-sm text-gray-700">
                                <div><strong>Patient:</strong> Sarah Martinez</div>
                                <div><strong>Event Type:</strong> Appointment Rescheduling Request</div>
                                <div><strong>Original Date:</strong> March 15, 2024 at 2:00 PM</div>
                                <div><strong>Requested Date:</strong> March 18, 2024 at 10:30 AM</div>
                                <div><strong>Reason:</strong> Scheduling conflict with work</div>
                                <div><strong>Requested:</strong> 2 hours ago</div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-blue-200">
                                <a href="#" class="text-blue-600 hover:text-blue-800 text-sm font-medium inline-flex items-center">
                                    <i class="ri-external-link-line mr-1"></i>
                                    View Original Appointment
                                </a>
                                <span class="mx-2 text-gray-400">•</span>
                                <a href="#" class="text-blue-600 hover:text-blue-800 text-sm font-medium inline-flex items-center">
                                    <i class="ri-user-line mr-1"></i>
                                    View Patient Profile
                                </a>
                            </div>
                        </div>
                        
                        <!-- Review Actions -->
                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <div class="text-sm font-medium text-gray-900 mb-3">Review Decision Required</div>
                            
                            <div class="space-y-3">
                                <button class="w-full flex items-center justify-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="ri-check-line mr-2"></i>
                                    Approve & Continue Workflow
                                </button>
                                <button class="w-full flex items-center justify-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                    <i class="ri-close-line mr-2"></i>
                                    Reject & Stop Workflow
                                </button>
                                <button class="w-full flex items-center justify-center px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                                    <i class="ri-share-forward-line mr-2"></i>
                                    Forward to Another Reviewer
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-500 text-center">
                            This interface appears when a review is actually triggered during workflow execution
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-6">
                        <button class="close-demo px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Close Demo
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(demoModal);
            
            // Close demo functionality
            demoModal.querySelector('.close-demo').addEventListener('click', () => {
                document.body.removeChild(demoModal);
            });
            
            demoModal.addEventListener('click', (e) => {
                if (e.target === demoModal) {
                    document.body.removeChild(demoModal);
                }
            });
        }
        
        function setupModalEventListeners(modal, block) {
            // Wait type toggle for wait blocks
            const waitTypeSelect = modal.querySelector('select[data-field="type"]');
            if (waitTypeSelect && block.type === 'wait') {
                waitTypeSelect.addEventListener('change', (e) => {
                    const timeConfig = modal.querySelector('#timeConfig');
                    const inputConfig = modal.querySelector('#inputConfig');
                    
                    if (e.target.value === 'input') {
                        timeConfig.classList.add('hidden');
                        inputConfig.classList.remove('hidden');
                    } else {
                        timeConfig.classList.remove('hidden');
                        inputConfig.classList.add('hidden');
                    }
                });
            }
            
            // AI analysis toggle for approval blocks
            const aiEnabledToggle = modal.querySelector('input[data-field="aiEnabled"]');
            if (aiEnabledToggle && block.type === 'approval') {
                const aiAnalysisSection = modal.querySelector('#ai-analysis-section');
                
                // Set initial state
                if (block.data.aiEnabled) {
                    aiEnabledToggle.checked = true;
                    aiAnalysisSection.style.display = 'block';
                }
                
                aiEnabledToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        aiAnalysisSection.style.display = 'block';
                    } else {
                        aiAnalysisSection.style.display = 'none';
                    }
                });
            }
            
            // Escalation toggle for approval blocks
            const escalationToggle = modal.querySelector('input[data-field="enableEscalation"]');
            if (escalationToggle && block.type === 'approval') {
                const escalationReviewerSection = modal.querySelector('#escalation-reviewer-section');
                const escalationTimeoutOption = modal.querySelector('option[value="escalate"]');
                
                // Set initial state
                if (block.data.enableEscalation) {
                    escalationToggle.checked = true;
                    escalationReviewerSection.classList.remove('hidden');
                    if (escalationTimeoutOption) {
                        escalationTimeoutOption.classList.remove('hidden');
                    }
                }
                
                escalationToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        escalationReviewerSection.classList.remove('hidden');
                        if (escalationTimeoutOption) {
                            escalationTimeoutOption.classList.remove('hidden');
                        }
                    } else {
                        escalationReviewerSection.classList.add('hidden');
                        if (escalationTimeoutOption) {
                            escalationTimeoutOption.classList.add('hidden');
                            // Reset timeout action if it was set to escalate
                            const timeoutActionSelect = modal.querySelector('select[data-field="timeoutAction"]');
                            if (timeoutActionSelect && timeoutActionSelect.value === 'escalate') {
                                timeoutActionSelect.value = 'auto-reject';
                            }
                        }
                    }
                });
            }
            
            // Cancel button
            modal.querySelector('.cancel-btn').addEventListener('click', () => {
                modal.remove();
            });
            
            // Save button
            modal.querySelector('.save-btn').addEventListener('click', () => {
                saveBlockConfiguration(modal, block);
                modal.remove();
            });
        }
        
        function saveBlockConfiguration(modal, block) {
            const inputs = modal.querySelectorAll('.config-input');
            const data = {};
            
            inputs.forEach(input => {
                const field = input.dataset.field;
                
                if (input.type === 'radio') {
                    if (input.checked) {
                        data[field] = input.value;
                    }
                } else if (input.type === 'checkbox') {
                    data[field] = input.checked;
                } else {
                    const value = input.value.trim();
                    if (value) {
                        data[field] = value;
                    }
                }
            });
            
            // Mark as configured
            data.configured = true;
            
            // Special handling for condition blocks
            if (block.type === 'condition') {
                // Preserve existing paths and update prompts
                const existingPaths = block.data.paths || [];
                const updatedPaths = [];
                
                // Get all path prompt inputs
                const pathInputs = modal.querySelectorAll('.path-prompt-input');
                pathInputs.forEach(input => {
                    const pathIndex = parseInt(input.dataset.pathIndex);
                    const pathElement = input.closest('[data-marked-for-deletion]');
                    
                    // Skip paths marked for deletion
                    if (!pathElement) {
                        const existingPath = existingPaths[pathIndex];
                        if (existingPath) {
                            updatedPaths.push({
                                prompt: input.value.trim(),
                                nextBlockId: existingPath.nextBlockId
                            });
                        }
                    }
                });
                
                data.paths = updatedPaths;
            }
            
            // Update block data
            block.data = { ...block.data, ...data };
            
            // Re-render the workflow to show updated configuration
            renderWorkflow();
            
            showNotification('Block configuration saved!', 'success');
        }

        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addChatMessage(message, 'user');
            
            // Clear input
            chatInput.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Simulate AI response (replace with actual API call)
            setTimeout(() => {
                hideTypingIndicator();
                const hasExistingWorkflow = workflowBlocks.length > 0;
                const aiResponse = generateAIResponse(message, hasExistingWorkflow);
                addChatMessage(aiResponse, 'ai');
            }, 1500);
        }
        
        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remove empty state if it exists
            const emptyState = chatMessages.querySelector('.text-center');
            if (emptyState) {
                emptyState.remove();
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `mb-4 chat-message ${sender === 'user' ? 'text-right' : 'text-left'}`;
            
            const time = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (sender === 'user') {
                messageElement.innerHTML = `
                    <div class="inline-block max-w-xs">
                        <div class="bg-purple-600 text-white px-4 py-2 rounded-lg rounded-br-sm">
                            ${message}
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${time}</div>
                    </div>
                `;
            } else {
                messageElement.innerHTML = `
                    <div class="inline-block max-w-xs">
                        <div class="bg-gray-100 text-gray-900 px-4 py-2 rounded-lg rounded-bl-sm">
                            <div class="flex items-start">
                                <i class="ri-magic-line text-purple-600 mr-2 mt-1 text-sm"></i>
                                <div>${message}</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${time}</div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingElement = document.createElement('div');
            typingElement.id = 'typingIndicator';
            typingElement.className = 'mb-4 text-left';
            typingElement.innerHTML = `
                <div class="inline-block">
                    <div class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg rounded-bl-sm">
                        <div class="flex items-center">
                            <i class="ri-magic-line text-purple-600 mr-2"></i>
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(typingElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function generateAIResponse(userMessage, hasWorkflow) {
            // Type-aware AI response simulation - replace with actual AI integration
            const workflowTypeText = currentWorkflowType === 'patient' ? 'patient' : 'practice-wide';
            
            const responses = {
                greeting: `Hello! I'm here to help you build your ${workflowTypeText} workflow. What would you like to work on?`,
                generate: hasWorkflow ? 
                    `I can help you modify your existing ${workflowTypeText} workflow. What changes would you like to make?` :
                    `I can help you create a new ${workflowTypeText} workflow. What process would you like to automate?`,
                patient_specific: "For patient workflows, I can help you create personalized care paths, appointment follow-ups, or medication adherence workflows. What patient process would you like to automate?",
                practice_specific: "For practice workflows, I can help you set up scheduled reports, threshold alerts, or bulk operations. What system-wide process would you like to automate?",
                placeholder: `I understand you want to work on your ${workflowTypeText} workflow. This is a demo - full AI integration will provide intelligent suggestions and modifications to your workflow blocks.`
            };
            
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return responses.greeting;
            } else if (lowerMessage.includes('create') || lowerMessage.includes('generate') || lowerMessage.includes('build')) {
                return responses.generate;
            } else if (lowerMessage.includes('patient') && currentWorkflowType === 'patient') {
                return responses.patient_specific;
            } else if (lowerMessage.includes('practice') && currentWorkflowType === 'practice') {
                return responses.practice_specific;
            } else {
                return responses.placeholder;
            }
        }

        function saveWorkflow() {
            // Extract trigger blocks from workflow blocks
            const triggerBlocks = workflowBlocks.filter(block => block.type.startsWith('trigger-'));
            const triggerInfo = triggerBlocks.map(block => ({
                type: block.type.replace('trigger-', ''),
                blockId: block.id
            }));

            const workflowData = {
                name: document.getElementById('workflowName').value || 'Untitled Workflow',
                description: document.getElementById('workflowDescription').value || '',
                triggers: triggerInfo,
                blocks: workflowBlocks
            };
            
            // For now, just show success message
            showNotification('Workflow saved successfully!', 'success');
            console.log('Saved workflow:', workflowData);
        }

        function manageWorkflowUsage() {
            if (!currentWorkflowType) {
                showNotification('Please select a workflow type first', 'warning');
                return;
            }

            if (currentWorkflowType === 'patient') {
                showPatientUsageModal();
            } else if (currentWorkflowType === 'practice') {
                showPracticeUsageModal();
            }
        }

        function copyWorkflow() {
            const currentName = document.getElementById('workflowName').value || 'Untitled Workflow';
            const newName = `Copy of ${currentName}`;
            
            // Create new workflow data
            const triggerBlocks = workflowBlocks.filter(block => block.type.startsWith('trigger-'));
            const triggerInfo = triggerBlocks.map(block => ({
                type: block.type.replace('trigger-', ''),
                blockId: block.id
            }));

            const copiedWorkflowData = {
                name: newName,
                description: document.getElementById('workflowDescription').value || '',
                triggers: triggerInfo,
                blocks: workflowBlocks.map(block => ({
                    ...block,
                    id: 'block-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9) // Generate new IDs
                }))
            };
            
            // Update the current form with the copied data
            document.getElementById('workflowName').value = newName;
            
            showNotification('Workflow copied successfully! You can now modify and save the copy.', 'success');
            console.log('Copied workflow:', copiedWorkflowData);
        }

        function showPatientUsageModal() {
            // Create and show modal for patient workflow usage
            const modal = document.createElement('div');
            modal.id = 'patientUsageModal';
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 w-full max-w-2xl mx-4">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Patient Workflow Usage</h3>
                        <button onclick="closePatientUsageModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="ri-close-line text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm text-gray-600">Assigned Patients</span>
                            <div class="flex space-x-2">
                                <button onclick="batchAssignPatients()" class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                    Batch Assign
                                </button>
                                <button onclick="batchDeassignPatients()" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">
                                    Batch De-assign
                                </button>
                            </div>
                        </div>
                        
                        <div class="border rounded-lg max-h-64 overflow-y-auto">
                            <div class="p-3 text-sm text-gray-500 text-center">
                                No patients currently assigned to this workflow.<br>
                                <span class="text-xs">Use "Batch Assign" to add patients.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button onclick="closePatientUsageModal()" class="px-4 py-2 text-gray-600 border border-gray-200 rounded-button hover:bg-gray-50">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showPracticeUsageModal() {
            // Create and show modal for practice workflow usage
            const modal = document.createElement('div');
            modal.id = 'practiceUsageModal';
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Practice Workflow Status</h3>
                        <button onclick="closePracticeUsageModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="ri-close-line text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div>
                                <div class="font-medium text-gray-900">Workflow Status</div>
                                <div class="text-sm text-gray-600" id="workflowStatusText">Active</div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="workflowToggle" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        
                        <div class="mt-3 text-xs text-gray-500">
                            When active, this workflow will automatically execute for all practice-wide events that match its triggers.
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button onclick="closePracticeUsageModal()" class="px-4 py-2 text-gray-600 border border-gray-200 rounded-button hover:bg-gray-50">
                            Close
                        </button>
                        <button onclick="savePracticeWorkflowStatus()" class="px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90">
                            Save Changes
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add toggle event listener
            document.getElementById('workflowToggle').addEventListener('change', function() {
                const statusText = document.getElementById('workflowStatusText');
                statusText.textContent = this.checked ? 'Active' : 'Inactive';
            });
        }

        function closePatientUsageModal() {
            const modal = document.getElementById('patientUsageModal');
            if (modal) modal.remove();
        }

        function closePracticeUsageModal() {
            const modal = document.getElementById('practiceUsageModal');
            if (modal) modal.remove();
        }

        function batchAssignPatients() {
            showNotification('Batch assign feature coming soon!', 'info');
        }

        function batchDeassignPatients() {
            showNotification('Batch de-assign feature coming soon!', 'info');
        }

        function savePracticeWorkflowStatus() {
            const isActive = document.getElementById('workflowToggle').checked;
            showNotification(`Workflow ${isActive ? 'activated' : 'deactivated'} successfully!`, 'success');
            closePracticeUsageModal();
        }

        function startManualWorkflow(blockId) {
            const workflowName = document.getElementById('workflowName').value || 'Untitled Workflow';
            
            // Find the manual trigger block
            const triggerBlock = workflowBlocks.find(block => block.id === blockId);
            if (!triggerBlock) {
                showNotification('Manual trigger block not found', 'error');
                return;
            }

            // Simulate workflow execution
            const executionData = {
                workflowName: workflowName,
                triggerType: 'manual',
                triggeredBy: 'user-action',
                blockId: blockId,
                timestamp: new Date().toISOString(),
                totalBlocks: workflowBlocks.length
            };

            // Show success notification with workflow details
            showNotification(
                `🚀 Manual workflow "${workflowName}" started successfully! (${workflowBlocks.length} blocks to execute)`, 
                'success'
            );
            
            console.log('Manual workflow execution:', executionData);
            
            // Optional: Could trigger actual workflow execution here
            // executeWorkflow(executionData);
        }


        // Command Palette functionality
        let commandPaletteVisible = false;
        let filteredItems = [];
        let selectedIndex = 0;

        function showCommandPalette() {
            if (commandPaletteVisible) return;
            
            commandPaletteVisible = true;
            const palette = document.getElementById('commandPalette');
            const modal = palette.querySelector('div:nth-child(2)');
            const searchInput = document.getElementById('commandSearch');
            
            palette.classList.remove('hidden');
            
            // Trigger animation after a small delay
            setTimeout(() => {
                palette.classList.remove('opacity-0');
                modal.classList.remove('-translate-y-4');
            }, 10);
            
            setTimeout(() => {
                searchInput.focus();
            }, 150);
            
            searchInput.value = '';
            
            // Show all items initially
            updateCommandPaletteResults('');
        }

        function hideCommandPalette() {
            if (!commandPaletteVisible) return;
            
            commandPaletteVisible = false;
            const palette = document.getElementById('commandPalette');
            const modal = palette.querySelector('div:nth-child(2)');
            
            palette.classList.add('opacity-0');
            modal.classList.add('-translate-y-4');
            
            setTimeout(() => {
                palette.classList.add('hidden');
            }, 200);
            
            selectedIndex = 0;
        }

        function updateCommandPaletteResults(query) {
            const resultsContainer = document.getElementById('commandResults');
            
            // Get workflow type specific blocks (same logic as block library)
            const patientTriggers = ['trigger-manual', 'trigger-order-events', 'trigger-appointment-events', 'trigger-document-events', 'trigger-report-events', 'trigger-task-events', 'trigger-profile-events'];
            const practiceTriggers = ['trigger-manual', 'trigger-scheduled', 'trigger-threshold', 'trigger-system-event'];
            const patientActions = ['send-message', 'appointment', 'task', 'document', 'order', 'note'];
            const practiceActions = ['bulk-communication', 'generate-report', 'system-maintenance'];
            
            let availableTriggers, availableActions;
            if (currentWorkflowType === 'patient') {
                availableTriggers = patientTriggers;
                availableActions = patientActions;
            } else if (currentWorkflowType === 'practice') {
                availableTriggers = practiceTriggers;
                availableActions = practiceActions;
            } else {
                availableTriggers = [...patientTriggers, ...practiceTriggers];
                availableActions = [...patientActions, ...practiceActions];
            }
            
            const allowedTypes = [...availableTriggers, ...availableActions, 'wait', 'condition', 'loop', 'approval'];
            
            // Filter items based on query and workflow type
            filteredItems = Object.entries(blockConfigs).filter(([type, config]) => {
                // Only include workflow type appropriate blocks
                if (!allowedTypes.includes(type)) {
                    return false;
                }
                
                return config.title.toLowerCase().includes(query.toLowerCase()) ||
                       config.description.toLowerCase().includes(query.toLowerCase());
            });

            // Group by category with type filtering
            // Filter out triggers if one already exists
            const hasTrigger = workflowBlocks.some(block => block.type.startsWith('trigger-'));
            const triggers = hasTrigger ? [] : filteredItems.filter(([type]) => availableTriggers.includes(type));
            const actions = filteredItems.filter(([type]) => availableActions.includes(type));
            const logic = filteredItems.filter(([type]) => ['wait', 'condition', 'loop', 'approval'].includes(type));

            let html = '';

            if (triggers.length > 0) {
                html += '<div class="mb-4"><div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Triggers</div>';
                triggers.forEach(([type, config], index) => {
                    const isSelected = index === selectedIndex;
                    html += `
                        <div class="command-item flex items-center p-3 rounded-lg cursor-pointer transition-colors ${isSelected ? 'bg-primary text-white' : 'hover:bg-gray-50'}" data-type="${type}">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 ${isSelected ? 'bg-white/20' : `bg-${config.color}-100`}">
                                <i class="${config.icon} ${isSelected ? 'text-white' : `text-${config.color}-600`}"></i>
                            </div>
                            <div>
                                <div class="font-medium">${config.title}</div>
                                <div class="text-sm ${isSelected ? 'text-white/80' : 'text-gray-500'}">${config.description}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (actions.length > 0) {
                html += '<div class="mb-4"><div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Actions</div>';
                actions.forEach(([type, config], index) => {
                    const globalIndex = triggers.length + index;
                    const isSelected = globalIndex === selectedIndex;
                    html += `
                        <div class="command-item flex items-center p-3 rounded-lg cursor-pointer transition-colors ${isSelected ? 'bg-primary text-white' : 'hover:bg-gray-50'}" data-type="${type}">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 ${isSelected ? 'bg-white/20' : `bg-${config.color}-100`}">
                                <i class="${config.icon} ${isSelected ? 'text-white' : `text-${config.color}-600`}"></i>
                            </div>
                            <div>
                                <div class="font-medium">${config.title}</div>
                                <div class="text-sm ${isSelected ? 'text-white/80' : 'text-gray-500'}">${config.description}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (logic.length > 0) {
                html += '<div class="mb-4"><div class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Logic</div>';
                logic.forEach(([type, config], index) => {
                    const globalIndex = triggers.length + actions.length + index;
                    const isSelected = globalIndex === selectedIndex;
                    html += `
                        <div class="command-item flex items-center p-3 rounded-lg cursor-pointer transition-colors ${isSelected ? 'bg-primary text-white' : 'hover:bg-gray-50'}" data-type="${type}">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 ${isSelected ? 'bg-white/20' : `bg-${config.color}-100`}">
                                <i class="${config.icon} ${isSelected ? 'text-white' : `text-${config.color}-600`}"></i>
                            </div>
                            <div>
                                <div class="font-medium">${config.title}</div>
                                <div class="text-sm ${isSelected ? 'text-white/80' : 'text-gray-500'}">${config.description}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (filteredItems.length === 0) {
                html = '<div class="text-center py-8 text-gray-500">No blocks found</div>';
            }

            resultsContainer.innerHTML = html;
            selectedIndex = 0;

            // Add click handlers
            document.querySelectorAll('.command-item').forEach((item, index) => {
                item.addEventListener('click', () => {
                    const blockType = item.dataset.type;
                    // Add block at center of canvas for command palette
                    createBlockAtPosition(blockType, 600, 300);
                    hideCommandPalette();
                });
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colorClass = type === 'success' ? 'bg-green-50 text-green-600' : 'bg-blue-50 text-blue-600';
            const icon = type === 'success' ? 'ri-check-line' : 'ri-information-line';
            
            notification.className = `fixed top-4 right-4 ${colorClass} px-4 py-3 rounded-lg shadow-lg z-50`;
            notification.innerHTML = `<i class="${icon} mr-2"></i>${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Zoom and Pan functionality
        let currentZoom = 1;
        let currentPanX = 0;
        let currentPanY = 0;
        let isPanning = false;
        let lastPanX = 0;
        let lastPanY = 0;

        function initializeZoomAndPan() {
            const canvas = document.querySelector('.workflow-canvas');
            if (!canvas || canvas.hasZoomPanListeners) return;
            canvas.hasZoomPanListeners = true;
            
            // Mouse wheel zoom with Ctrl key
            canvas.addEventListener('wheel', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    
                    const rect = canvas.getBoundingClientRect();
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    
                    const zoomFactor = e.deltaY > 0 ? 0.95 : 1.05; // 5% increments
                    const newZoom = Math.max(0.1, Math.min(3, currentZoom * zoomFactor));
                    
                    if (newZoom !== currentZoom) {
                        currentZoom = newZoom;
                        updateCanvasTransform();
                    }
                }
            });

            // Pinch-to-zoom for trackpad
            let lastTouchDistance = 0;
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    lastTouchDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                }
            });

            canvas.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    
                    if (lastTouchDistance > 0) {
                        const zoomFactor = currentDistance / lastTouchDistance;
                        const newZoom = Math.max(0.1, Math.min(3, currentZoom * zoomFactor));
                        
                        if (newZoom !== currentZoom) {
                            currentZoom = newZoom;
                            updateCanvasTransform();
                        }
                    }
                    
                    lastTouchDistance = currentDistance;
                }
            });

            canvas.addEventListener('touchend', (e) => {
                if (e.touches.length < 2) {
                    lastTouchDistance = 0;
                }
            });

            // Add gesturestart/gesturechange for Safari trackpad pinch
            canvas.addEventListener('gesturestart', (e) => {
                e.preventDefault();
            });

            canvas.addEventListener('gesturechange', (e) => {
                e.preventDefault();
                const newZoom = Math.max(0.1, Math.min(3, currentZoom * e.scale));
                if (newZoom !== currentZoom) {
                    currentZoom = newZoom;
                    updateCanvasTransform();
                }
            });

            canvas.addEventListener('gestureend', (e) => {
                e.preventDefault();
            });

            // Pan functionality with direct drag on empty canvas areas
            canvas.addEventListener('mousedown', (e) => {
                // Only start panning if clicking directly on the canvas (not on blocks)
                if (e.button === 0 && e.target === canvas) { // Left click on empty canvas
                    e.preventDefault();
                    isPanning = true;
                    lastPanX = e.clientX;
                    lastPanY = e.clientY;
                    canvas.style.cursor = 'grabbing';
                } else if (e.button === 1) { // Middle mouse button anywhere
                    e.preventDefault();
                    isPanning = true;
                    lastPanX = e.clientX;
                    lastPanY = e.clientY;
                    canvas.style.cursor = 'grabbing';
                }
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isPanning) {
                    const deltaX = e.clientX - lastPanX;
                    const deltaY = e.clientY - lastPanY;
                    
                    // Convert screen delta to canvas delta by dividing by zoom
                    currentPanX += deltaX / currentZoom;
                    currentPanY += deltaY / currentZoom;
                    
                    lastPanX = e.clientX;
                    lastPanY = e.clientY;
                    
                    updateCanvasTransform();
                }
            });

            canvas.addEventListener('mouseup', (e) => {
                if (isPanning) {
                    isPanning = false;
                    canvas.style.cursor = '';
                }
            });

            canvas.addEventListener('mouseleave', () => {
                isPanning = false;
                canvas.style.cursor = '';
            });

            // Reset zoom with double-click
            canvas.addEventListener('dblclick', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    currentZoom = 1;
                    currentPanX = 0;
                    currentPanY = 0;
                    updateCanvasTransform();
                }
            });
        }

        function updateCanvasTransform() {
            const canvas = document.querySelector('.workflow-canvas');
            canvas.style.transform = `scale(${currentZoom}) translate(${currentPanX}px, ${currentPanY}px)`;
            canvas.style.transformOrigin = 'center center';
            
            // Update zoom display
            const zoomDisplay = document.getElementById('zoomDisplay');
            if (zoomDisplay) {
                zoomDisplay.textContent = Math.round(currentZoom * 100) + '%';
            }
        }

        function zoomIn() {
            const newZoom = Math.min(3, currentZoom * 1.05); // 5% increment
            if (newZoom !== currentZoom) {
                currentZoom = newZoom;
                updateCanvasTransform();
            }
        }

        function zoomOut() {
            const newZoom = Math.max(0.1, currentZoom * 0.95); // 5% decrement
            if (newZoom !== currentZoom) {
                currentZoom = newZoom;
                updateCanvasTransform();
            }
        }

        function resetZoom() {
            currentZoom = 1;
            updateCanvasTransform();
        }

        function centerBlocks() {
            if (workflowBlocks.length === 0) return;
            
            // Calculate bounds of all blocks
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            
            function calculateBlockBounds(blocks) {
                blocks.forEach(block => {
                    if (block.position) {
                        minX = Math.min(minX, block.position.x);
                        minY = Math.min(minY, block.position.y);
                        maxX = Math.max(maxX, block.position.x + 250); // Approximate block width
                        maxY = Math.max(maxY, block.position.y + 100); // Approximate block height
                    }
                    
                    // Check child blocks
                    if (block.nextBlocks) {
                        calculateBlockBounds(block.nextBlocks);
                    }
                });
            }
            
            calculateBlockBounds(workflowBlocks);
            
            if (minX === Infinity) return;
            
            // Calculate center position
            const boundsWidth = maxX - minX;
            const boundsHeight = maxY - minY;
            const boundsCenterX = minX + boundsWidth / 2;
            const boundsCenterY = minY + boundsHeight / 2;
            
            // Get canvas dimensions
            const canvas = document.querySelector('.workflow-canvas');
            const canvasRect = canvas.getBoundingClientRect();
            const canvasCenterX = canvasRect.width / 2;
            const canvasCenterY = canvasRect.height / 2;
            
            // Calculate pan needed to center (account for scale-first transform)
            const panX = (canvasCenterX - boundsCenterX * currentZoom) / currentZoom;
            const panY = (canvasCenterY - boundsCenterY * currentZoom) / currentZoom;
            
            currentPanX = panX;
            currentPanY = panY;
            
            updateCanvasTransform();
        }

        // Tab switching functionality
        function initializeTabs() {
            const composeTab = document.getElementById('composeTab');
            const testLogTab = document.getElementById('testLogTab');
            const composeTabContent = document.getElementById('composeTabContent');
            const testLogTabContent = document.getElementById('testLogTabContent');

            // Main tab switching
            composeTab.addEventListener('click', () => {
                switchMainTab('compose');
            });

            testLogTab.addEventListener('click', () => {
                switchMainTab('testLog');
            });

            // Sub-tab switching for Test & Log
            const testRunTab = document.getElementById('testRunTab');
            const logViewTab = document.getElementById('logViewTab');
            const testRunContent = document.getElementById('testRunContent');
            const logViewContent = document.getElementById('logViewContent');

            testRunTab.addEventListener('click', () => {
                switchSubTab('testRun');
            });

            logViewTab.addEventListener('click', () => {
                switchSubTab('logView');
            });

            // Log sub-tabs
            const testLogsTab = document.getElementById('testLogsTab');
            const liveLogsTab = document.getElementById('liveLogsTab');

            testLogsTab.addEventListener('click', () => {
                switchLogTab('testLogs');
            });

            liveLogsTab.addEventListener('click', () => {
                switchLogTab('liveLogs');
            });

            // Test run functionality
            const runTestBtn = document.getElementById('runTestBtn');
            runTestBtn.addEventListener('click', () => {
                runWorkflowTest();
            });
        }

        function switchMainTab(tab) {
            const composeTab = document.getElementById('composeTab');
            const testLogTab = document.getElementById('testLogTab');
            const composeTabContent = document.getElementById('composeTabContent');
            const testLogTabContent = document.getElementById('testLogTabContent');

            // Remove active class from all tabs
            composeTab.classList.remove('active', 'border-primary', 'text-primary', 'bg-primary/5');
            testLogTab.classList.remove('active', 'border-primary', 'text-primary', 'bg-primary/5');
            
            // Add inactive styling
            composeTab.classList.add('border-transparent', 'text-gray-500');
            testLogTab.classList.add('border-transparent', 'text-gray-500');

            // Hide all content
            composeTabContent.classList.add('hidden');
            testLogTabContent.classList.add('hidden');

            if (tab === 'compose') {
                composeTab.classList.add('active', 'border-primary', 'text-primary', 'bg-primary/5');
                composeTab.classList.remove('border-transparent', 'text-gray-500');
                composeTabContent.classList.remove('hidden');
            } else if (tab === 'testLog') {
                testLogTab.classList.add('active', 'border-primary', 'text-primary', 'bg-primary/5');
                testLogTab.classList.remove('border-transparent', 'text-gray-500');
                testLogTabContent.classList.remove('hidden');
                updateWorkflowTypeDisplay();
            }
        }

        function switchSubTab(tab) {
            const testRunTab = document.getElementById('testRunTab');
            const logViewTab = document.getElementById('logViewTab');
            const testRunContent = document.getElementById('testRunContent');
            const logViewContent = document.getElementById('logViewContent');

            // Remove active class from all sub-tabs
            testRunTab.classList.remove('active', 'border-primary', 'text-primary', 'bg-primary/5');
            logViewTab.classList.remove('active', 'border-primary', 'text-primary', 'bg-primary/5');
            
            // Add inactive styling
            testRunTab.classList.add('border-transparent', 'text-gray-500');
            logViewTab.classList.add('border-transparent', 'text-gray-500');

            // Hide all content
            testRunContent.classList.add('hidden');
            logViewContent.classList.add('hidden');

            if (tab === 'testRun') {
                testRunTab.classList.add('active', 'border-primary', 'text-primary', 'bg-primary/5');
                testRunTab.classList.remove('border-transparent', 'text-gray-500');
                testRunContent.classList.remove('hidden');
            } else if (tab === 'logView') {
                logViewTab.classList.add('active', 'border-primary', 'text-primary', 'bg-primary/5');
                logViewTab.classList.remove('border-transparent', 'text-gray-500');
                logViewContent.classList.remove('hidden');
            }
        }

        function switchLogTab(tab) {
            const testLogsTab = document.getElementById('testLogsTab');
            const liveLogsTab = document.getElementById('liveLogsTab');

            // Remove active class from all log tabs
            testLogsTab.classList.remove('active', 'border-primary', 'text-primary');
            liveLogsTab.classList.remove('active', 'border-primary', 'text-primary');
            
            // Add inactive styling
            testLogsTab.classList.add('border-transparent', 'text-gray-500');
            liveLogsTab.classList.add('border-transparent', 'text-gray-500');

            if (tab === 'testLogs') {
                testLogsTab.classList.add('active', 'border-primary', 'text-primary');
                testLogsTab.classList.remove('border-transparent', 'text-gray-500');
                // Filter to show only test runs (placeholder)
            } else if (tab === 'liveLogs') {
                liveLogsTab.classList.add('active', 'border-primary', 'text-primary');
                liveLogsTab.classList.remove('border-transparent', 'text-gray-500');
                // Filter to show only live runs (placeholder)
            }
        }

        function updateWorkflowTypeDisplay() {
            // Detect workflow type from URL parameter or workflow configuration
            const urlParams = new URLSearchParams(window.location.search);
            const workflowType = urlParams.get('type') || 'patient'; // Default to patient
            
            const workflowTypeIcon = document.getElementById('workflowTypeIcon');
            const workflowTypeText = document.getElementById('workflowTypeText');
            const testDescription = document.getElementById('testDescription');
            const runTestBtnText = document.getElementById('runTestBtnText');

            if (workflowType === 'practice') {
                workflowTypeIcon.innerHTML = '<i class="ri-building-2-line text-purple-600"></i>';
                workflowTypeIcon.className = 'w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3';
                workflowTypeText.textContent = 'Practice Workflow';
                testDescription.textContent = 'Run this practice workflow in test mode to verify system automation';
                runTestBtnText.textContent = 'Run Test Workflow';
            } else {
                workflowTypeIcon.innerHTML = '<i class="ri-user-heart-line text-blue-600"></i>';
                workflowTypeIcon.className = 'w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3';
                workflowTypeText.textContent = 'Patient Workflow';
                testDescription.textContent = 'Run this workflow with dummy patient data to verify functionality';
                runTestBtnText.textContent = 'Run with Dummy Patient';
            }
        }

        function runWorkflowTest() {
            const runTestBtn = document.getElementById('runTestBtn');
            const testStatus = document.getElementById('testStatus');
            const testResults = document.getElementById('testResults');
            const testStatusText = document.getElementById('testStatusText');
            const testStatusDetail = document.getElementById('testStatusDetail');
            const testResultsList = document.getElementById('testResultsList');

            // Disable button and show running status
            runTestBtn.disabled = true;
            runTestBtn.classList.add('opacity-50', 'cursor-not-allowed');
            testStatus.classList.remove('hidden');
            testStatus.className = 'mb-6 p-4 rounded-lg bg-blue-50';
            testResults.classList.add('hidden');

            // Simulate test execution steps
            const testSteps = [
                { message: 'Initializing test environment...', detail: 'Setting up dummy data and test context' },
                { message: 'Validating workflow blocks...', detail: 'Checking block configuration and dependencies' },
                { message: 'Executing workflow steps...', detail: 'Running through each workflow block' },
                { message: 'Processing results...', detail: 'Analyzing test outcomes and generating report' }
            ];

            let currentStep = 0;

            function executeNextStep() {
                if (currentStep < testSteps.length) {
                    const step = testSteps[currentStep];
                    testStatusText.textContent = step.message;
                    testStatusDetail.textContent = step.detail;
                    currentStep++;
                    setTimeout(executeNextStep, 1000 + Math.random() * 1000); // Random delay between 1-2 seconds
                } else {
                    // Test completed
                    completeTest();
                }
            }

            // Start the test execution
            setTimeout(executeNextStep, 500);
        }

        function completeTest() {
            const runTestBtn = document.getElementById('runTestBtn');
            const testStatus = document.getElementById('testStatus');
            const testResults = document.getElementById('testResults');
            const testStatusText = document.getElementById('testStatusText');
            const testStatusDetail = document.getElementById('testStatusDetail');
            const testStatusIcon = document.getElementById('testStatusIcon');
            const testResultsList = document.getElementById('testResultsList');

            // Show success status
            testStatus.className = 'mb-6 p-4 rounded-lg bg-green-50';
            testStatusIcon.innerHTML = '<i class="ri-check-line text-green-600"></i>';
            testStatusText.textContent = 'Test completed successfully!';
            testStatusDetail.textContent = 'All workflow blocks executed without errors';

            // Generate mock test results
            const mockResults = generateMockTestResults();
            testResultsList.innerHTML = mockResults;
            testResults.classList.remove('hidden');

            // Re-enable button
            setTimeout(() => {
                runTestBtn.disabled = false;
                runTestBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                testStatus.classList.add('hidden');
            }, 2000);

            // Add to log (placeholder)
            addTestRunToLog();
        }

        function generateMockTestResults() {
            const results = [
                { block: 'Patient Data Validation', status: 'success', message: 'Dummy patient data validated successfully', time: '0.2s' },
                { block: 'Condition Check', status: 'success', message: 'IF condition evaluated to true', time: '0.1s' },
                { block: 'Send Notification', status: 'success', message: 'Test notification sent to dummy patient', time: '0.3s' },
                { block: 'Update Records', status: 'success', message: 'Patient records updated in test database', time: '0.4s' },
                { block: 'AI Analysis', status: 'success', message: 'AI processing completed with 95% confidence', time: '1.2s' }
            ];

            return results.map(result => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-5 h-5 mr-3">
                            ${result.status === 'success' 
                                ? '<i class="ri-check-line text-green-600"></i>' 
                                : '<i class="ri-close-line text-red-600"></i>'}
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${result.block}</p>
                            <p class="text-sm text-gray-600">${result.message}</p>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500">${result.time}</div>
                </div>
            `).join('');
        }

        function addTestRunToLog() {
            // This would add a new entry to the log table in a real implementation
            // For now, it's just a placeholder
            console.log('Test run added to log');
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            // Other existing initialization code...
        });
    </script>
</body>
</html>